<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation System Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .has-reservations {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        .has-reservations:hover {
            background-color: #dbeafe !important;
        }
        
        /* Calendar Table Styles */
        .table-bordered {
            border-collapse: collapse;
            border: 1px solid #ccc;
            width: 100%;
        }
        .table-bordered th,
        .table-bordered td {
            border: 1px solid #ccc;
            padding: 8px;
            vertical-align: top;
            height: 120px;
        }
        .table-bordered th {
            background-color: #CCC;
            height: 45px;
            text-align: center;
            font-weight: bold;
        }
        .bg-red {
            background-color: #ffebee !important;
        }
        
        /* Country Flag Background Classes - Global (for both mobile and desktop) */
        .flag-usa::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/a/a4/Flag_of_the_United_States.svg');
        }

        .flag-uk::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Flag_of_the_United_Kingdom_(3-5).svg');
        }

        .flag-canada::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/d/d9/Flag_of_Canada_(Pantone).svg');
        }

        .flag-australia::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/8/88/Flag_of_Australia_(converted).svg');
        }

        .flag-japan::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/9e/Flag_of_Japan.svg');
        }

        .flag-south-korea::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_South_Korea.svg');
        }

        .flag-germany::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/ba/Flag_of_Germany.svg');
        }

        .flag-france::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c3/Flag_of_France.svg');
        }

        .flag-italy::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/0/03/Flag_of_Italy.svg');
        }

        .flag-spain::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/9a/Flag_of_Spain.svg');
        }

        .flag-brazil::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/0/05/Flag_of_Brazil.svg');
        }

        .flag-mexico::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/fc/Flag_of_Mexico.svg');
        }

        .flag-india::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/41/Flag_of_India.svg');
        }

        .flag-china::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/fa/Flag_of_the_People%27s_Republic_of_China.svg');
        }

        .flag-russia::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/f3/Flag_of_Russia.svg');
        }

        .flag-netherlands::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/2/20/Flag_of_the_Netherlands.svg');
        }

        .flag-sweden::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/4c/Flag_of_Sweden.svg');
        }

        .flag-norway::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/d/d9/Flag_of_Norway.svg');
        }

        .flag-switzerland::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/0/08/Flag_of_Switzerland_(Pantone).svg');
        }

        .flag-south-africa::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/a/af/Flag_of_South_Africa.svg');
        }

        .flag-singapore::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/48/Flag_of_Singapore.svg');
        }

        .flag-thailand::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg');
        }

        .flag-philippines::before {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg');
        }

        /* Flag backgrounds for table rows - Desktop and Mobile */
        .job-order-row {
            position: relative;
            overflow: hidden;
        }

        .job-order-row::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.05;
            z-index: 1;
            transition: opacity 0.3s ease;
        }

        .job-order-row:hover::before {
            opacity: 0.08;
        }

        /* Ensure table cell content stays above background */
        .job-order-row td {
            position: relative;
            z-index: 2;
        }
        
        /* Mobile-Friendly Styles */
        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }
        
        .sidebar-collapsed {
            transform: translateX(-100%);
        }
        
        .main-content {
            transition: margin-left 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        .main-content-expanded {
            margin-left: 0 !important;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 40;
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .mobile-overlay {
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            
            /* Job Order Card Layout for Mobile */
            .job-order-card {
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 0.5rem;
                background: white;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            /* Random Country Flag Background for Job Order Cards */
            .job-order-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.1;
                z-index: 1;
                transition: opacity 0.3s ease;
            }

            .job-order-card:hover::before {
                opacity: 0.15;
            }

            /* Ensure content stays above background */
            .job-order-card > * {
                position: relative;
                z-index: 2;
            }
            
            .job-order-card:hover {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }
            
            .job-order-card .title {
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 0.25rem;
            }
            
            .job-order-card .subtitle {
                color: #6b7280;
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }
            
            .job-order-card .status-badge {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
            }
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .hamburger span {
            width: 1.5rem;
            height: 2px;
            background-color: #374151;
            margin: 2px 0;
            transition: 0.3s;
        }
        
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
        }
        .bg-orange {
            background-color: #fff3e0 !important;
        }
        .bg-maroon {
            background-color: #800000 !important;
            color: white !important;
        }
        .bg-green {
            background-color: #4caf50;
            color: white;
        }
        .bg-blue {
            background-color: #2196f3;
            color: white;
        }
        .calendar-cell {
            width: 14.28%;
            position: relative;
            cursor: pointer;
        }
        .calendar-cell:hover {
            background-color: #f5f5f5 !important;
        }
        .date-number {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-bottom: 10px;
        }
        .reservation-item {
            padding: 3px;
            font-size: 12px;
            border-radius: 4px;
            margin-bottom: 3px;
            display: block;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }
        .reservation-item:hover {
            opacity: 0.8;
        }
        .thickbox {
            cursor: pointer;
            color: inherit;
            text-decoration: none;
        }
        .thickbox:hover {
            color: inherit;
            text-decoration: none;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            font-weight: 500;
        }
        .header-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 50%, #581c87 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .notification-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Line clamp utility for mobile cards */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            min-width: 280px;
        }
        
        /* Custom Loader */
        .loader {
            --r1: 154%;
            --r2: 68.5%;
            width: 60px;
            aspect-ratio: 1;
            border-radius: 50%;
            background:
                radial-gradient(var(--r1) var(--r2) at top, #0000 79.5%, #269af2 80%),
                radial-gradient(var(--r1) var(--r2) at bottom, #269af2 79.5%, #0000 80%),
                radial-gradient(var(--r1) var(--r2) at top, #0000 79.5%, #269af2 80%),
                #ccc;
            background-size: 50.5% 220%;
            background-position: -100% 0%, 0% 0%, 100% 0%;
            background-repeat: no-repeat;
            animation: l9 2s infinite linear;
            margin: 0 auto 1rem;
        }
        
        @keyframes l9 {
            33% { background-position: 0% 33%, 100% 33%, 200% 33%; }
            66% { background-position: -100% 66%, 0% 66%, 100% 66%; }
            100% { background-position: 0% 100%, 100% 100%, 200% 100%; }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #269af2, #3b82f6);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* New Message Highlighting Styles */
        .new-message-highlight {
            background-color: #f0fdf4 !important;
            border: 2px solid #22c55e !important;
            border-radius: 0.5rem;
            position: relative;
            animation: newMessagePulse 2s ease-in-out;
        }
        
        .new-message-label {
            position: absolute;
            top: -8px;
            right: 8px;
            background: #22c55e;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            z-index: 10;
        }
        
        @keyframes newMessagePulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
                background-color: #f0fdf4;
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
                background-color: #dcfce7;
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
                background-color: #f0fdf4;
            }
        }
        
        @keyframes slideInFromLeft {
            0% {
                transform: translateX(-20px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-slideInFromLeft {
            animation: slideInFromLeft 0.5s ease-out;
        }
        
        .loading-text {
            color: #374151;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .loading-subtext {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .progress-percentage {
            color: #269af2;
            font-weight: 600;
            font-size: 1.125rem;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }
            .header-brand-subtitle {
                display: none;
            }
            .loading-container {
                margin: 1rem;
                min-width: auto;
                width: calc(100% - 2rem);
            }
        }
        
        /* Submit Button Background Image */
        .submit-button-bg {
            background-image: url('https://i.imgur.com/jq1xaI4.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .submit-button-bg span {
            position: relative;
            z-index: 10;
        }
        
        /* Header Philippine Flag Background */
        .header-flag-bg {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .header-flag-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
        }
        
        .header-flag-bg > * {
            position: relative;
            z-index: 2;
        }
        
        /* Navigation Philippine Flag Background */
        .nav-flag-bg {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .nav-flag-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: 1;
            border-radius: 0.5rem;
        }
        
        .nav-flag-bg > * {
            position: relative;
            z-index: 2;
        }
        
        /* Active navigation with stronger flag visibility */
        .nav-flag-bg.bg-blue-50::before {
            background: rgba(239, 246, 255, 0.9);
        }

        /* Rope Border Style - Advanced Pattern */
        .rope-border {
            position: relative;
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .rope-border::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: 
                repeating-linear-gradient(
                    0deg,
                    #8B4513 0px,
                    #A0522D 2px,
                    #CD853F 4px,
                    #D2691E 6px,
                    #CD853F 8px,
                    #A0522D 10px,
                    #8B4513 12px
                ),
                repeating-linear-gradient(
                    90deg,
                    #8B4513 0px,
                    #A0522D 2px,
                    #CD853F 4px,
                    #D2691E 6px,
                    #CD853F 8px,
                    #A0522D 10px,
                    #8B4513 12px
                );
            border-radius: 20px;
            z-index: -1;
        }

        .rope-border::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: 
                repeating-linear-gradient(
                    45deg,
                    #654321 0px,
                    #8B4513 1px,
                    #A0522D 2px,
                    #CD853F 3px,
                    #D2691E 4px,
                    #CD853F 5px,
                    #A0522D 6px,
                    #8B4513 7px,
                    #654321 8px
                ),
                repeating-linear-gradient(
                    -45deg,
                    #654321 0px,
                    #8B4513 1px,
                    #A0522D 2px,
                    #CD853F 3px,
                    #D2691E 4px,
                    #CD853F 5px,
                    #A0522D 6px,
                    #8B4513 7px,
                    #654321 8px
                );
            border-radius: 18px;
            z-index: -1;
            opacity: 0.8;
        }

        .rope-border:hover::before {
            opacity: 0.9;
        }

        .rope-border:hover::after {
            opacity: 0.9;
        }

        /* Enhanced rope border visibility for modals */
        .modal-backdrop .rope-border {
            margin: 20px; /* Ensure space for the extended border */
        }

        .modal-backdrop .rope-border::before,
        .modal-backdrop .rope-border::after {
            opacity: 0.9; /* Make rope border more visible in modals */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loader"></div>
            <div class="loading-text" id="loadingText">Processing...</div>
            <div class="loading-subtext" id="loadingSubtext">Please wait while we process your request</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-percentage" id="progressPercentage">0%</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header-flag-bg bg-white shadow-md border-b border-gray-200 fixed w-full top-0 z-50">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-3">
                    <!-- Mobile Hamburger Menu -->
                    <div class="hamburger md:hidden" onclick="toggleMobileSidebar()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    
                    <img src="https://edp.usjr.edu.ph/public/images/usjr_trans.png" style="display: block; border: 6px solid red !important; width: 50px; height: 50px; object-fit: contain;">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">PAO - Basak</h1>
                        <p class="text-gray-500 text-sm hidden sm:block">Venue Management System</p>
                    </div>
                    <!-- Real-time status indicator -->
                    <div id="realTimeStatus" class="hidden sm:flex items-center space-x-1 text-xs text-green-600 opacity-0 transition-opacity">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span>Live</span>
                    </div>
                </div>

                <!-- Profile Management -->
                <div class="relative">
                    <button onclick="toggleProfileMenu()" class="rope-border flex items-center space-x-3 bg-gray-50 hover:bg-gray-100 rounded-lg px-4 py-2 transition-colors">
                        <div id="headerProfilePicture" class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden">
                            <img id="headerProfileImage" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <span id="headerProfileInitials" class="text-white text-sm font-medium">JD</span>
                        </div>
                        <div class="text-left">
                            <span class="text-gray-700 font-medium text-sm block">John Doe</span>
                            <span class="text-gray-500 text-xs">Administrator</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transform: rotate(90deg);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                    <!-- Profile Dropdown -->
                    <div id="profileMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 py-2">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <div class="flex items-center space-x-3">
                                <div id="dropdownProfilePicture" class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden">
                                    <img id="dropdownProfileImage" src="" alt="Profile" class="w-full h-full object-cover hidden">
                                    <span id="dropdownProfileInitials" class="text-white text-sm font-medium">JD</span>
                                </div>
                                <div>
                                    <p id="profileDisplayName" class="text-sm font-medium text-gray-900">John Doe</p>
                                    <p id="profileDisplayEmail" class="text-sm text-gray-500">admin@reservehub.com</p>
                                    <span id="profileDisplayType" class="inline-block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mt-1">Admin</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="openProfileModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>Edit Profile</span>
                        </button>
                        <button onclick="openPasswordModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <span>Change Password</span>
                        </button>
                        <div class="border-t border-gray-100 mt-2 pt-2">
                            <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay hidden" onclick="closeMobileSidebar()"></div>
    
    <div class="flex pt-20">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 bg-white shadow-sm h-screen fixed left-0 top-20 border-r border-gray-200 flex flex-col">
            <!-- Scrollable Navigation Container -->
            <div class="flex-1 overflow-y-auto">
                <nav class="p-4 space-y-2">
                    <button onclick="showSection('dashboard')" class="nav-item nav-traditional w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-700 font-medium flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4"></path>
                        </svg>
                        <span class="relative z-10">Dashboard</span>
                    </button>
                    <button onclick="showSection('reservations')" class="nav-item nav-traditional w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-4 8l-2-2m0 0l-2-2m2 2l2-2m-2 2l2 2"></path>
                        </svg>
                        <span class="relative z-10">Reservations</span>
                    </button>
                    <button onclick="showSection('venues')" class="nav-item nav-traditional w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0H3"></path>
                        </svg>
                        <span class="relative z-10">Venues</span>
                    </button>
                    <button onclick="showSection('usage-log')" class="nav-item nav-traditional w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="relative z-10">Usage Log</span>
                    </button>
                    <button onclick="showSection('messages')" class="nav-item nav-traditional w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="relative z-10">Messages</span>
                        <div id="navUnreadIndicator" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></div>
                    </button>
                    <button onclick="showSection('manage-users')" class="nav-item nav-admin w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <span class="relative z-10">Manage Users</span>
                    </button>
                    
                    <!-- New Navigation Items -->
                    <button onclick="showSection('file-job-order')" class="nav-item nav-general w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="relative z-10">File Job Order</span>
                    </button>
                    <button onclick="showSection('view-job-order')" class="nav-item nav-general w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <span class="relative z-10">View Job Order</span>
                    </button>
                    <button onclick="showSection('aircon-concerns')" class="nav-item nav-general w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM7 3H5a2 2 0 00-2 2v12a4 4 0 004 4h2a2 2 0 002-2V5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2h6a2 2 0 012 2z"></path>
                        </svg>
                        <span class="relative z-10">Aircon Concerns</span>
                    </button>
                    <button onclick="showSection('view-ac-status')" class="nav-item nav-general w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span class="relative z-10">View AC Status</span>
                    </button>
                    <button onclick="showSection('request-water')" class="nav-item nav-general w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center space-x-3 relative" style="display: none; background-image: url('https://i.imgur.com/HKNaGIt.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
                        <svg class="w-5 h-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                        </svg>
                        <span class="relative z-10">Request Water</span>
                    </button>
                </nav>
            </div>
            
            <!-- Fixed Footer -->
            <div class="flex-shrink-0 px-4 py-3 text-center text-xs text-gray-500 border-t border-gray-200">
                <p>2025 Property Administrator's Office - Basak</p>
                <p>Developed by Jan Lurence Espinosa</p>
            </div>
        </aside>
        <!-- Main Content -->
        <main id="mainContent" class="main-content flex-1 ml-64 p-3 md:p-6">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Dashboard</h2>
                        <p class="text-gray-600">Manage your reservations and venue bookings</p>
                    </div>
                    <button onclick="openReservationModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>New Reservation</span>
                    </button>
                </div>
                
                <!-- Calendar -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 card-shadow">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-xl font-semibold text-gray-900">Reservation Calendar</h3>
                        <div class="flex items-center space-x-4">
                            <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span id="currentMonth" class="text-lg font-medium text-gray-800 min-w-[140px] text-center">December 2024</span>
                            <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <table id="calendar" class="table table-bordered" width="100%" style="background-color: #FFF;">
                        <!-- Calendar will be generated by JavaScript -->
                    </table>
                </div>
            </div>
            <!-- Reservations Section -->
            <div id="reservations-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Reservations</h2>
                    <p class="text-gray-600">View and manage all reservations</p>
                </div>
                
                <!-- Date Filters -->
                <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">From Date:</label>
                            <input type="date" id="fromDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">To Date:</label>
                            <input type="date" id="toDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <button onclick="filterReservations()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                            Filter
                        </button>
                        <button onclick="clearReservationFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="reservationsTable" class="bg-white rounded-xl shadow-sm border border-gray-200 card-shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">All Reservations</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="reservationsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Reservations will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Venues Section -->
            <div id="venues-section" class="section hidden">
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Venues</h2>
                        <p class="text-gray-600">Manage venue information and availability</p>
                    </div>
                    <button onclick="openAddVenueModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Add Venue</span>
                    </button>
                </div>
                <div id="venuesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Venues will be populated here dynamically -->
                </div>
            </div>
            
            <!-- Usage Log Section -->
            <div id="usage-log-section" class="section hidden">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Venue Usage Log</h2>
                        <p class="text-gray-600">Track venue usage for inventory purposes</p>
                    </div>
                    <button onclick="openUsageModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Log Usage</span>
                    </button>
                </div>
                
                <!-- Filters and Export Section -->
                <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">Venue:</label>
                            <select id="usageVenueFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm min-w-[150px]">
                                <option value="">All Venues</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">From Date:</label>
                            <input type="date" id="usageFromDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">To Date:</label>
                            <input type="date" id="usageToDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <button onclick="filterUsageLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                            Filter
                        </button>
                        <button onclick="clearUsageFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                            Clear
                        </button>
                    </div>
                    
                    <!-- Export Buttons -->
                    <div class="flex items-center space-x-3 pt-4 border-t border-gray-200">
                        <span class="text-sm font-medium text-gray-700">Export:</span>
                        <button onclick="exportUsageLogToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>PDF</span>
                        </button>
                        <button onclick="exportUsageLogToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Excel</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 card-shadow">
                    <div class="overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-full table-fixed">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr>
                                        <th class="w-32 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Timestamp</th>
                                        <th class="w-24 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Log ID</th>
                                        <th class="w-32 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Venue</th>
                                        <th class="w-28 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Activity Date</th>
                                        <th class="w-20 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Day</th>
                                        <th class="w-32 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Department</th>
                                        <th class="w-24 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Time</th>
                                        <th class="flex-1 min-w-0 px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Details</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <div class="max-h-96 overflow-y-auto overflow-x-auto">
                            <table class="w-full min-w-full table-fixed">
                                <tbody id="usageLogTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Usage logs here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div id="messages-section" class="section hidden">
                <div class="fixed inset-0 top-20 left-64 flex bg-white">
                    <!-- Users Sidebar -->
                    <div class="w-80 border-r border-gray-200 flex flex-col h-full bg-gray-50">
                        <div class="p-4 border-b border-gray-200 bg-white">
                            <h2 class="text-xl font-bold text-gray-900">Messages</h2>
                            <div class="mt-3 relative">
                                <input type="text" id="userSearchInput" placeholder="Search users..." 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       oninput="searchUsers()">
                                <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto bg-white">
                            <div id="usersList" class="divide-y divide-gray-100">
                                <!-- Users will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="flex-1 flex flex-col h-full">
                        <!-- Chat Header -->
                        <div id="chatHeader" class="p-4 border-b border-gray-200 bg-white flex-shrink-0 hidden">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                                    <img id="chatUserProfileImage" src="" alt="Profile" class="w-full h-full object-cover hidden">
                                    <span id="chatUserInitials" class="text-white font-semibold text-sm"></span>
                                </div>
                                <div>
                                    <h3 id="chatUserName" class="font-semibold text-gray-900"></h3>
                                    <p id="chatUserRole" class="text-sm text-gray-500"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Indicator -->
                        <div id="messagingStatus" class="px-4 py-2 bg-white border-b border-gray-200 text-xs text-gray-500 hidden">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span id="statusIndicator" class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                    <span id="statusText">Connected</span>
                                </div>
                                <div id="loadingIndicator" class="hidden">
                                    <div class="animate-spin w-3 h-3 border border-gray-300 border-t-blue-500 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                            <div id="noUserSelected" class="flex items-center justify-center h-full">
                                <div class="text-center">
                                    <svg class="mx-auto w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Select a conversation</h3>
                                    <p class="text-gray-500">Choose a user from the sidebar to start messaging</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div id="messageInputContainer" class="p-4 border-t border-gray-200 bg-white flex-shrink-0 hidden">
                            <form id="messageForm" class="flex space-x-3">
                                <input type="text" id="messageInput" placeholder="Type your message..." 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       required>
                                <button type="submit" class="submit-button-bg text-white px-6 py-2 rounded-lg font-semibold transition-colors relative">
                                    <svg class="w-5 h-5 rotate-90 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Users Section -->
            <div id="manage-users-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Manage Users</h2>
                    <p class="text-gray-600">View and manage user accounts and permissions</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">User Accounts</h3>
                            <div class="flex items-center space-x-3">
                                <button onclick="openAddUserModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Add New User</span>
                                </button>
                                <button onclick="refreshUsersList()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue Access</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="usersLoading" class="p-8 text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="mt-2 text-gray-500">Loading users...</p>
                    </div>
                    
                    <div id="usersEmpty" class="p-8 text-center hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No users found</h3>
                        <p class="mt-1 text-sm text-gray-500">No user accounts are registered in the system.</p>
                    </div>
                </div>
            </div>

            <!-- File Job Order Section -->
            <div id="file-job-order-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">File Job Order</h2>
                    <p class="text-gray-600">Submit a new job order request</p>
                </div>

                <!-- Form Section -->
                <div id="formContainer" class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                    <form id="jobOrderForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="formNumber" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-hashtag mr-2 text-gray-400"></i>Form No.
                                </label>
                                <input type="text" id="formNumber" name="formNumber" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 cursor-not-allowed" />
                            </div>
                            
                            <div class="form-group">
                                <label for="dateFiled" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-days mr-2 text-gray-400"></i>Date of Filing
                                </label>
                                <input type="text" id="dateFiled" name="dateFiled" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 cursor-not-allowed" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="department" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-building mr-2 text-gray-400"></i>Department
                            </label>
                            <select id="department" name="department" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Loading departments...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-location-dot mr-2 text-gray-400"></i>Location
                            </label>
                            <input type="text" id="location" name="location" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter location" />
                        </div>

                        <div class="form-group">
                            <label for="natureOfWork" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-clipboard-list mr-2 text-gray-400"></i>Nature of Work
                            </label>
                            <input type="text" id="natureOfWork" name="natureOfWork" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Describe the nature of work" />
                        </div>

                        <div class="form-group">
                            <label for="requestedBy" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2 text-gray-400"></i>Requested By
                            </label>
                            <input type="text" id="requestedBy" name="requestedBy" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter your name" />
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="submit-button-bg px-6 py-3 text-white font-semibold rounded-lg transition-colors flex items-center space-x-2 relative">
                                <i class="fas fa-paper-plane relative z-10"></i>
                                <span class="relative z-10">Submit Job Order</span>
                            </button>
                        </div>

                        <div id="jobOrderMessage" class="mt-4 text-sm"></div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="mt-8 text-center text-sm text-gray-500">
                    © 2025 Property Administrator's Office | Designed by <a href="#" class="text-blue-600 hover:underline">janlurence</a>
                </div>
            </div>

            <!-- Job Order Success Overlay -->
            <div id="jobOrderSuccessOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
                <div class="bg-white rounded-xl shadow-2xl max-w-md mx-4 overflow-hidden relative">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-2">
                                    <i class="fas fa-check text-white text-xl"></i>
                                </div>
                                <h3 class="text-white text-lg font-semibold">Success!</h3>
                            </div>
                            <button id="closeSuccessOverlayX" class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="fas fa-file-alt text-green-500 text-4xl mb-3"></i>
                                <h4 class="text-xl font-semibold text-gray-800 mb-2">Job Order Submitted</h4>
                                <p class="text-gray-600 mb-4">Your maintenance request has been successfully submitted.</p>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                    <div class="flex items-center justify-center space-x-2">
                                        <i class="fas fa-hashtag text-green-600"></i>
                                        <span class="text-green-800 font-semibold">Form Number:</span>
                                        <span id="successFormNumber" class="text-green-800 font-bold"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button id="printJobOrderBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2">
                                    <i class="fas fa-print"></i>
                                    <span>Print</span>
                                </button>
                                <button id="downloadJobOrderBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2">
                                    <i class="fas fa-download"></i>
                                    <span>Download</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden">
                <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm mx-4 text-center">
                    <div class="mb-4">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Processing...</h3>
                        <p class="text-gray-600">Submitting your job order. Please wait.</p>
                    </div>
                </div>
            </div>

            <!-- View Job Order Section -->
            <div id="view-job-order-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">View Job Orders</h2>
                    <p class="text-gray-600">Track and view your job order requests</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Your Job Orders</h3>
                                <p id="jobOrdersCount" class="text-sm text-gray-500 mt-1">Loading...</p>
                            </div>
                            <button onclick="refreshJobOrders()" class="px-4 py-2 text-blue-600 hover:text-blue-700 flex items-center space-x-2">
                                <i class="fas fa-sync-alt"></i>
                                <span class="hidden sm:inline">Refresh</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Job Orders Filters -->
                    <div class="p-4 md:p-6 border-b border-gray-200 bg-gray-50">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Search by Job Order Number -->
                            <div class="flex-1">
                                <label for="jobOrderSearch" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <div class="relative">
                                    <input type="text" id="jobOrderSearch" placeholder="Search by form number..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           oninput="filterJobOrders()">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Department Filter -->
                            <div class="flex-1">
                                <label for="jobOrderDepartmentFilter" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                <select id="jobOrderDepartmentFilter" onchange="filterJobOrders(true)" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">All Departments</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <!-- Date Filter -->
                            <div class="flex-1">
                                <label for="jobOrderDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="jobOrderDate" onchange="filterJobOrders(true)" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Select date">
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <div class="flex items-end">
                                <button onclick="clearJobOrderFilters()" 
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors whitespace-nowrap">
                                    <i class="fas fa-times mr-2"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desktop Table View -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Filed</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nature of Work</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobOrdersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Job orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div id="jobOrdersCardView" class="md:hidden p-4 space-y-3">
                        <!-- Job order cards will be loaded here -->
                    </div>
                    
                    <div id="jobOrdersLoading" class="p-8 text-center">
                        <div class="inline-flex items-center space-x-2 text-gray-600">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading job orders...</span>
                        </div>
                    </div>
                    <div id="jobOrdersEmpty" class="p-8 text-center hidden">
                        <div class="text-gray-500">
                            <i class="fas fa-clipboard text-4xl mb-4"></i>
                            <p class="text-lg font-medium mb-2">No job orders found</p>
                            <p class="text-sm">You haven't submitted any job orders yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aircon Concerns Section -->
            <div id="aircon-concerns-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Aircon Concerns</h2>
                    <p class="text-gray-600">Report air conditioning issues and concerns</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                    <form id="airconConcernForm" class="space-y-6">
                        <!-- Auto-filled fields (read-only) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date
                                </label>
                                <input type="text" name="date" id="airconDate" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 cursor-not-allowed">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-building mr-2 text-green-500"></i>Department
                                </label>
                                <input type="text" name="department" id="airconDepartment" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 cursor-not-allowed">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2 text-purple-500"></i>Reported By
                            </label>
                            <input type="text" name="reportedBy" id="airconReportedBy" readonly 
                                   class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 cursor-not-allowed">
                        </div>

                        <!-- User input fields -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-snowflake mr-2 text-cyan-500"></i>Aircon Type <span class="text-red-500">*</span>
                            </label>
                            <select name="airconType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select aircon type...</option>
                                <option value="Window">
                                    <i class="fas fa-square"></i> Window Type
                                </option>
                                <option value="Split">
                                    <i class="fas fa-grip-lines"></i> Split Type
                                </option>
                                <option value="Standby">
                                    <i class="fas fa-cube"></i> Standby Unit
                                </option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>Concern/s <span class="text-red-500">*</span>
                            </label>
                            <textarea name="concerns" required rows="4" placeholder="Describe the aircon issues or concerns in detail..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                        </div>

                        <!-- Status and Date Accomplished (hidden, will be set by admin) -->
                        <input type="hidden" name="status" value="Pending">
                        <input type="hidden" name="dateAccomplished" value="">

                        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button type="button" onclick="resetAirconForm()" class="px-6 py-3 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="fas fa-undo mr-2"></i>Reset
                            </button>
                            <button type="submit" class="submit-button-bg px-6 py-3 text-white rounded-lg transition-colors font-semibold flex items-center space-x-2 relative">
                                <i class="fas fa-paper-plane relative z-10"></i>
                                <span class="relative z-10">Submit Concern</span>
                            </button>
                        </div>

                        <!-- Status message -->
                        <div id="airconMessage" class="mt-4 text-sm"></div>
                    </form>
                </div>
            </div>

            <!-- Request Water Section -->
            <div id="request-water-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Request Water</h2>
                    <p class="text-gray-600">Request water delivery or water-related services</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <!-- Content Not Available Notice -->
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Content Not Yet Available!</h3>
                        <p class="text-gray-600 text-lg">This feature will be available soon.</p>
                    </div>
                    
                    <!-- Hidden form for future use -->
                    <form id="waterRequestForm" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Location <span class="text-red-500">*</span></label>
                            <input type="text" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Water Type</label>
                            <select name="waterType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Drinking Water">Drinking Water</option>
                                <option value="Distilled Water">Distilled Water</option>
                                <option value="Purified Water">Purified Water</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity <span class="text-red-500">*</span></label>
                            <select name="quantity" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select quantity...</option>
                                <option value="1 Gallon">1 Gallon</option>
                                <option value="2 Gallons">2 Gallons</option>
                                <option value="3 Gallons">3 Gallons</option>
                                <option value="5 Gallons">5 Gallons</option>
                                <option value="10 Gallons">10 Gallons</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Date <span class="text-red-500">*</span></label>
                            <input type="date" name="deliveryDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
                            <textarea name="instructions" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                                <span class="relative z-10">Submit Request</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View AC Status Section -->
            <div id="view-ac-status-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">AC Status Dashboard</h2>
                    <p class="text-gray-600">Track and manage air conditioning concerns and their status</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">AC Concerns List</h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    <span id="acConcernsCount">0</span> concerns found
                                </p>
                            </div>
                            <button onclick="refreshACConcerns()" class="px-4 py-2 text-blue-600 hover:text-blue-700 flex items-center space-x-2">
                                <i class="fas fa-sync-alt"></i>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- AC Concerns Filters -->
                    <div class="p-4 md:p-6 border-b border-gray-200 bg-gray-50">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Search by Reporter or Concern -->
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="acConcernSearch" placeholder="Search by reporter or concern description..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           oninput="filterACConcerns()">
                                </div>
                            </div>
                            
                            <!-- Department Filter -->
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                <select id="acConcernDepartmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="filterACConcerns(true)">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="acConcernStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="filterACConcerns(true)">
                                    <option value="">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            
                            <!-- Aircon Type Filter -->
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">AC Type</label>
                                <select id="acConcernTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="filterACConcerns(true)">
                                    <option value="">All Types</option>
                                    <option value="Window">Window</option>
                                    <option value="Split">Split</option>
                                    <option value="Standby">Standby</option>
                                </select>
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <div class="flex items-end">
                                <button onclick="clearACConcernFilters()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors text-sm">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desktop Table View -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AC Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concern</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reported By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Accomplished</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="acConcernsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- AC concerns will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div id="acConcernsCardView" class="md:hidden p-4 space-y-3">
                        <!-- AC concern cards will be loaded here -->
                    </div>
                    
                    <div id="acConcernsLoading" class="p-8 text-center">
                        <div class="inline-flex items-center space-x-2 text-gray-600">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading AC concerns...</span>
                        </div>
                    </div>
                    <div id="acConcernsEmpty" class="p-8 text-center hidden">
                        <div class="text-gray-500">
                            <i class="fas fa-snowflake text-4xl mb-4"></i>
                            <p class="text-lg font-medium mb-2">No AC concerns found</p>
                            <p class="text-sm">No air conditioning concerns have been reported yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reservation Modal -->
    <div id="reservationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-auto max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-xl font-semibold text-gray-900">New Reservation</h3>
            </div>
            <form id="reservationForm" class="flex-1 overflow-y-auto">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Venue <span class="text-red-500">*</span></label>
                        <select name="venue" id="venueSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">Select a venue...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Activity Date <span class="text-red-500">*</span></label>
                        <input type="date" name="activityDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Day</label>
                        <input type="text" name="day" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department <span class="text-red-500">*</span></label>
                        <select name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">Select department...</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                            <input type="time" name="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                            <input type="time" name="endTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose <span class="text-red-500">*</span></label>
                        <textarea name="purpose" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" rows="3" placeholder="Describe the activity"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Facilities</label>
                        <input type="text" name="facilities" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g. Projector, Sound System">
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 flex-shrink-0">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeReservationModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <span class="relative z-10">Submit</span>
                        </button>
                    </div>
                    <div id="reservationMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-auto max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-xl font-semibold text-gray-900">Edit Profile</h3>
            </div>
            <form id="profileForm" class="flex-1 overflow-y-auto">
                <div class="p-6 space-y-4">
                    <!-- Profile Picture Section -->
                    <div class="text-center">
                        <div class="relative inline-block">
                            <div class="w-24 h-24 mx-auto rounded-full overflow-hidden bg-gray-200 flex items-center justify-center">
                                <img id="profilePreview" src="" alt="Profile" class="w-full h-full object-cover hidden">
                                <div id="profilePlaceholder" class="text-2xl font-bold text-gray-500">
                                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <button type="button" onclick="document.getElementById('profileImageInput').click()" 
                                    class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                        </div>
                        <input type="file" id="profileImageInput" name="profilePic" accept="image/*" class="hidden" onchange="handleProfileImageChange(event)">
                        <p class="text-sm text-gray-500 mt-2">Click to upload profile picture</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" name="username" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name <span class="text-red-500">*</span></label>
                        <input type="text" name="fullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email <span class="text-red-500">*</span></label>
                        <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Type</label>
                        <input type="text" name="userType" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed">
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 flex-shrink-0">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeProfileModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <span class="relative z-10">Save Changes</span>
                        </button>
                    </div>
                    <div id="profileMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    <!-- Password Change Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Change Password</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closePasswordModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                <button onclick="changePassword()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Change Password</button>
            </div>
        </div>
    </div>
    <!-- Usage Log Modal -->
    <div id="usageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Log Event Activity</h3>
            </div>
            <form id="usageLogForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Venue <span class="text-red-500">*</span></label>
                        <select name="venue" id="usageVenueSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a venue...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Activity Date <span class="text-red-500">*</span></label>
                        <input type="date" name="activityDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Day</label>
                        <input type="text" name="day" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department <span class="text-red-500">*</span></label>
                    <select name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select department...</option>
                        <!-- Departments will be populated dynamically from Google Sheets -->
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Time <span class="text-red-500">*</span></label>
                        <input type="time" name="startTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Time <span class="text-red-500">*</span></label>
                        <input type="time" name="endTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Purpose <span class="text-red-500">*</span></label>
                    <textarea name="purpose" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Describe the purpose of the event/activity"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Facilities Used</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="Projector" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Projector</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="Sound System" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Sound System</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="Air Conditioning" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Air Conditioning</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="WiFi" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">WiFi</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="Whiteboard" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Whiteboard</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="facilities" value="Tables & Chairs" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm">Tables & Chairs</span>
                        </label>
                    </div>
                    <textarea name="additionalFacilities" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Additional facilities or equipment used..."></textarea>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="closeUsageModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                <button type="button" onclick="saveUsageLog()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Event Log</button>
            </div>
        </div>
    </div>
    
    <!-- Usage Log Detail Modal -->
    <div id="usageDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Event Log Details</h3>
                    <button onclick="closeUsageDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <!-- Event Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Timestamp</label>
                            <p id="detailTimestamp" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Log ID</label>
                            <p id="detailLogId" class="text-sm text-blue-600 bg-gray-50 px-3 py-2 rounded-lg font-mono">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
                            <p id="detailVenue" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <p id="detailDepartment" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Activity Date</label>
                            <p id="detailActivityDate" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day</label>
                            <p id="detailDay" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                            <p id="detailStartTime" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                            <p id="detailEndTime" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Purpose -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
                    <div id="detailPurpose" class="text-sm text-gray-900 bg-gray-50 px-4 py-3 rounded-lg min-h-[60px] whitespace-pre-wrap">-</div>
                </div>
                
                <!-- Facilities -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Facilities Used</label>
                    <div id="detailFacilities" class="text-sm text-gray-900 bg-gray-50 px-4 py-3 rounded-lg min-h-[40px]">-</div>
                </div>
                
                <!-- Date Submitted -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Submitted</label>
                    <p id="detailDateSubmitted" class="text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">-</p>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeUsageDetailModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Close</button>
                <button id="editUsageButton" onclick="handleEditButtonClick()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                    <span id="editButtonText">Edit</span>
                    <svg id="editButtonSpinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Usage Log Modal -->
    <div id="editUsageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Edit Event Log</h3>
                    <button onclick="closeEditUsageModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <form id="editUsageLogForm">
                <div class="p-6 space-y-6">
                    <!-- Hidden fields for log ID -->
                    <input type="hidden" id="editLogId" name="logId">
                    
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Venue Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Venue <span class="text-red-500">*</span></label>
                            <select id="editVenue" name="venue" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="">Select a venue</option>
                            </select>
                        </div>
                        
                        <!-- Department Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Department <span class="text-red-500">*</span></label>
                            <select id="editDepartment" name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="">Select a department</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Date and Time -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Activity Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Activity Date <span class="text-red-500">*</span></label>
                            <input type="date" id="editActivityDate" name="activityDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" onchange="updateEditDayField()">
                        </div>
                        
                        <!-- Day -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Day</label>
                            <input type="text" id="editDay" name="day" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                        </div>
                        
                        <!-- Time Range -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Time <span class="text-red-500">*</span></label>
                                <input type="time" id="editStartTime" name="startTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Time <span class="text-red-500">*</span></label>
                                <input type="time" id="editEndTime" name="endTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Purpose -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose <span class="text-red-500">*</span></label>
                        <textarea id="editPurpose" name="purpose" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Please describe the purpose of using this venue"></textarea>
                    </div>
                    
                    <!-- Facilities -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Facilities Needed</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="editFacilitiesCheckboxes">
                            <!-- Facilities checkboxes will be populated here -->
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-600 mb-2">Additional Facilities</label>
                            <input type="text" id="editAdditionalFacilities" name="additionalFacilities" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Specify any other facilities needed">
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="closeEditUsageModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                    <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg relative">
                        <span class="relative z-10">Update Event Log</span>
                    </button>
                </div>
                
                <!-- Message area -->
                <div id="editUsageMsg" class="px-6 pb-6 text-sm"></div>
            </form>
        </div>
    </div>
    
    <!-- Date Reservations Modal -->
    <div id="dateReservationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h3 id="dateModalTitle" class="text-lg font-semibold text-gray-800">Reservations for Selected Date</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dateReservationsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Reservations for selected date will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button onclick="closeDateReservationsModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Venue Modal -->
    <div id="addVenueModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Add New Venue</h3>
            </div>
            <form id="addVenueForm">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Venue Name <span class="text-red-500">*</span></label>
                        <input type="text" name="venueName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Capacity <span class="text-red-500">*</span></label>
                        <input type="number" name="capacity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Facilities</label>
                        <textarea name="facilities" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" rows="3" placeholder="e.g. Projector, Whiteboard, Audio System"></textarea>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAddVenueModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <span class="relative z-10">Add Venue</span>
                        </button>
                    </div>
                    <div id="addVenueMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Venue Assignment Modal -->
    <div id="venueAssignmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit Venue Assignments</h3>
                <p class="text-sm text-gray-600 mt-1">Select which venues this user can access</p>
            </div>
            <form id="venueAssignmentForm">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                        <input type="text" id="assignmentUsername" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-medium">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Venue Access</label>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 bg-blue-50 rounded-lg border">
                                <input type="radio" name="venueAccess" value="ALL" class="text-blue-600 focus:ring-blue-500 mr-3">
                                <div>
                                    <div class="font-medium text-blue-900">All Venues</div>
                                    <div class="text-sm text-blue-700">User can view reservations for all venues</div>
                                </div>
                            </label>
                            <label class="flex items-start p-3 bg-gray-50 rounded-lg border">
                                <input type="radio" name="venueAccess" value="SPECIFIC" class="text-blue-600 focus:ring-blue-500 mr-3 mt-1">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900 mb-2">Specific Venues</div>
                                    <div id="venueCheckboxes" class="space-y-1 max-h-32 overflow-y-auto">
                                        <!-- Venue checkboxes will be populated here -->
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeVenueAssignmentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <span class="relative z-10">Save Changes</span>
                        </button>
                    </div>
                    <div id="venueAssignmentMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- AC Concern Edit Modal -->
    <div id="acConcernEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Edit AC Concern</h3>
                <p class="text-sm text-gray-600 mt-1">Update air conditioning concern details</p>
            </div>
            <form id="acConcernEditForm">
                <div class="p-6 space-y-4">
                    <!-- Read-only fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Reported</label>
                            <input type="text" id="editACDate" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                            <input type="text" id="editACDepartment" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AC Type</label>
                            <input type="text" id="editACType" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reported By</label>
                            <input type="text" id="editACReportedBy" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>
                    
                    <!-- Editable fields -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Concern Description</label>
                        <textarea id="editACConcerns" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status <span class="text-red-500">*</span></label>
                            <select id="editACStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Accomplished</label>
                            <input type="date" id="editACDateAccomplished" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeACConcernEditModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <i class="fas fa-save mr-2 relative z-10"></i><span class="relative z-10">Save Changes</span>
                        </button>
                    </div>
                    <div id="acConcernEditMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Add New User</h3>
                <p class="text-sm text-gray-600 mt-1">Create a new user account with specified permissions</p>
            </div>
            <form id="addUserForm">
                <div class="p-6 space-y-4">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username <span class="text-red-500">*</span></label>
                            <input type="text" id="newUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password <span class="text-red-500">*</span></label>
                            <input type="password" id="newPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter password">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name <span class="text-red-500">*</span></label>
                        <input type="text" id="newFullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter full name">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Department <span class="text-red-500">*</span></label>
                            <select id="newDepartment" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Department</option>
                                <!-- Will be populated from backend -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">User Type <span class="text-red-500">*</span></label>
                            <select id="newUserType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select User Type</option>
                                <option value="admin">Admin</option>
                                <option value="staff">Staff</option>
                                <option value="student">Student</option>
                                <option value="faculty">Faculty</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="newEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter email address">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="newPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="newStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAddUserModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="submit-button-bg px-4 py-2 text-white rounded-lg transition-colors relative">
                            <i class="fas fa-user-plus mr-2 relative z-10"></i><span class="relative z-10">Create User</span>
                        </button>
                    </div>
                    <div id="addUserMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ====== CONFIGURATION ======
        // Replace with your deployed Apps Script URL
        const GOOGLE_APPS_SCRIPT_URL_FORM = 'https://script.google.com/macros/s/AKfycbx9KxSx1JlgIOIvZVYG-RCMy_Njjul-TGKWcVwHtmWTX1gwpcuALP28Ws-HNqloq_a2cg/exec';
        
        // ====== COUNTRY FLAGS FOR JOB ORDER CARDS ======
        const countryFlags = [
            'flag-usa', 'flag-uk', 'flag-canada', 'flag-australia', 'flag-japan', 'flag-south-korea',
            'flag-germany', 'flag-france', 'flag-italy', 'flag-spain', 'flag-brazil', 'flag-mexico',
            'flag-india', 'flag-china', 'flag-russia', 'flag-netherlands', 'flag-sweden', 'flag-norway',
            'flag-switzerland', 'flag-south-africa', 'flag-singapore', 'flag-thailand', 'flag-philippines'
        ];

        function getRandomFlagClass() {
            return countryFlags[Math.floor(Math.random() * countryFlags.length)];
        }
        
        // ====== LOADING OVERLAY UTILITIES ======
        let loadingProgress = 0;
        let loadingInterval = null;
        
        function showLoading(text = 'Processing...', subtext = 'Please wait while we process your request') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            
            // Reset progress
            loadingProgress = 0;
            progressFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            
            // Set text content
            loadingText.textContent = text;
            loadingSubtext.textContent = subtext;
            
            // Show overlay
            overlay.classList.add('active');
            
            // Start progress simulation
            startProgressSimulation();
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            
            // Complete progress first
            setProgress(100);
            
            // Hide overlay after a short delay to show completion
            setTimeout(() => {
                overlay.classList.remove('active');
                stopProgressSimulation();
            }, 500);
        }
        
        function setProgress(percentage) {
            loadingProgress = Math.min(100, Math.max(0, percentage));
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            
            progressFill.style.width = loadingProgress + '%';
            progressPercentage.textContent = Math.round(loadingProgress) + '%';
        }
        
        function startProgressSimulation() {
            stopProgressSimulation(); // Clear any existing interval
            
            loadingInterval = setInterval(() => {
                if (loadingProgress < 85) {
                    // Simulate realistic progress with decreasing increments
                    const increment = Math.random() * (90 - loadingProgress) * 0.1;
                    setProgress(loadingProgress + increment);
                } else if (loadingProgress < 95) {
                    // Slow down near completion
                    setProgress(loadingProgress + Math.random() * 2);
                }
            }, 200);
        }
        
        function stopProgressSimulation() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }
        
        function updateLoadingText(text, subtext = null) {
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            loadingText.textContent = text;
            if (subtext) {
                loadingSubtext.textContent = subtext;
            }
        }

        /*
        ====== GOOGLE APPS SCRIPT BACKEND CHANGES ======
        Your Google Apps Script should handle FormData like this:

        function doPost(e) {
            try {
                // Read parameters from e.parameter (not e.postData.contents)
                const data = {
                    venue: e.parameter.venue || '',
                    activityDate: e.parameter.activityDate || '',
                    day: e.parameter.day || '',
                    department: e.parameter.department || '',
                    time: e.parameter.time || '',
                    purpose: e.parameter.purpose || '',
                    facilities: e.parameter.facilities || '',
                    dateSubmitted: e.parameter.dateSubmitted || new Date().toLocaleString()
                };
                
                // Your existing logic to save to spreadsheet
                // ... rest of your doPost function
                
                return ContentService
                    .createTextOutput(JSON.stringify({success: true, reservationId: 'RES' + Date.now()}))
                    .setMimeType(ContentService.MimeType.JSON);
                    
            } catch (error) {
                return ContentService
                    .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
                    .setMimeType(ContentService.MimeType.JSON);
            }
        }

        function doGet(e) {
            // Handle GET requests (like fetching reservations)
            const action = e.parameter.action;
            
            if (action === 'getPending' || action === 'getApproved') {
                // Your existing logic to fetch from spreadsheet
                // ... rest of your doGet function
            }
            
            return ContentService
                .createTextOutput(JSON.stringify({success: true, reservations: []}))
                .setMimeType(ContentService.MimeType.JSON);
        }
        */

        let currentDate = new Date();
        let selectedDate = null;

        // Reservations data will be loaded from backend
        let reservations = [];
        let venues = [];
        let departments = [];
        let currentUser = null;
        
        // Real-time refresh intervals
        let dataRefreshInterval = null;

        // Navigation functions
        function showSection(sectionName) {
            // Check if user has permission to access this section
            if (currentUser && currentUser.userType !== 'admin') {
                const adminOnlySections = ['manage-users'];
                if (adminOnlySections.includes(sectionName)) {
                    alert('Access denied. Administrator privileges required.\n\nTo edit venue assignments, please log in as an admin user.\nDefault admin credentials: username "admin", password "admin"');
                    return;
                }
            }
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            
            // Reset all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium');
                item.classList.add('text-gray-700', 'hover:bg-gray-50');
            });
            
            // Find the clicked nav item and activate it
            const activeNavItem = document.querySelector(`button[onclick="showSection('${sectionName}')"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                activeNavItem.classList.remove('text-gray-700', 'hover:bg-gray-50');
            }
            
            if (sectionName === 'reservations') {
                loadAllReservations();
            }
            if (sectionName === 'venues') {
                loadVenuesGrid();
            }
            if (sectionName === 'usage-log') {
                fetchUsageLogs().then(() => {
                    loadUsageLog();
                });
                populateVenueFilter();
            }
            if (sectionName === 'messages') {
                console.log('Switching to messages section - instant load with cache');
                // INSTANT LOAD: Use cached users first for immediate display
                loadUsersInstant();
            }
            if (sectionName === 'view-job-order') {
                loadJobOrders();
            }
            if (sectionName === 'manage-users') {
                // Ensure loading overlay is hidden first
                hideLoading();
                // Reset the users loading state
                const usersLoading = document.getElementById('usersLoading');
                const usersEmpty = document.getElementById('usersEmpty');
                const usersTableBody = document.getElementById('usersTableBody');
                
                if (usersLoading) usersLoading.classList.remove('hidden');
                if (usersEmpty) usersEmpty.classList.add('hidden');
                if (usersTableBody) usersTableBody.style.display = 'none';
                
                refreshUsersList();
            } else {
                // Clear message polling when leaving messages section
                if (messagePollingInterval) {
                    clearInterval(messagePollingInterval);
                    messagePollingInterval = null;
                }
            }
        }

        // Profile menu functions
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        }
        
        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('sidebar-mobile-open')) {
                closeMobileSidebar();
            } else {
                sidebar.classList.add('sidebar-mobile-open');
                mobileOverlay.classList.remove('hidden');
                mobileOverlay.classList.add('sidebar-overlay-visible');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('sidebar-mobile-open');
            mobileOverlay.classList.add('hidden');
            mobileOverlay.classList.remove('sidebar-overlay-visible');
            document.body.style.overflow = '';
        }
        
        // Job Order functions
        function openJobOrderEditModal(jobOrder) {
            // Check if user is admin
            if (!currentUser || currentUser.userType !== 'admin') {
                alert('Only administrators can edit job order status.');
                return;
            }
            
            console.log('Opening edit modal with job order:', jobOrder);
            console.log('Department value:', jobOrder.department);
            console.log('All jobOrder properties:', Object.keys(jobOrder));
            console.log('Full jobOrder object:', JSON.stringify(jobOrder, null, 2));
            
            document.getElementById('editFormNumber').value = jobOrder.formNumber || '';
            document.getElementById('editDepartment').value = jobOrder.department || '';
            document.getElementById('editStatus').value = jobOrder.status || '';
            document.getElementById('editLocation').value = jobOrder.location || '';
            document.getElementById('editNatureOfWork').value = jobOrder.natureOfWork || '';
            document.getElementById('editRequestedBy').value = jobOrder.requestedBy || '';
            document.getElementById('editDateFiled').value = formatDate(jobOrder.dateFiled) || '';
            
            // Additional debugging for department field
            const deptField = document.getElementById('editDepartment');
            console.log('Department field after setting:', deptField.value);
            console.log('Department field element:', deptField);
            
            // Store the form number for updating
            document.getElementById('jobOrderEditForm').dataset.formNumber = jobOrder.formNumber;
            
            document.getElementById('jobOrderEditModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function openJobOrderEditModalByIndex(index) {
            if (window.currentJobOrders && window.currentJobOrders[index]) {
                openJobOrderEditModal(window.currentJobOrders[index]);
            }
        }
        
        function closeJobOrderEditModal() {
            document.getElementById('jobOrderEditModal').classList.add('hidden');
            document.getElementById('jobOrderEditMsg').textContent = '';
            document.body.style.overflow = '';
        }
        
        // Job Order Details Modal functions
        function openJobOrderDetailsModal(index) {
            console.log('openJobOrderDetailsModal called with index:', index);
            console.log('currentJobOrders:', window.currentJobOrders);
            
            if (window.currentJobOrders && window.currentJobOrders[index]) {
                const jobOrder = window.currentJobOrders[index];
                console.log('Selected job order:', jobOrder);
                
                // Populate all the details fields
                document.getElementById('detailsFormNumber').textContent = jobOrder.formNumber || 'N/A';
                document.getElementById('detailsDepartment').textContent = jobOrder.department || 'N/A';
                document.getElementById('detailsLocation').textContent = jobOrder.location || 'No location specified';
                document.getElementById('detailsNatureOfWork').textContent = jobOrder.natureOfWork || 'No work description provided';
                document.getElementById('detailsRequestedBy').textContent = jobOrder.requestedBy || 'N/A';
                document.getElementById('detailsDateFiled').textContent = formatDate(jobOrder.dateFiled) || 'N/A';
                document.getElementById('detailsDateSubmitted').textContent = formatDate(jobOrder.dateSubmitted) || 'N/A';
                
                // Set status badge with proper styling
                const statusElement = document.getElementById('detailsStatus');
                statusElement.textContent = jobOrder.status || 'Pending';
                statusElement.className = `px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(jobOrder.status)}`;
                
                // Store current job order for edit functionality
                window.currentJobOrderForDetails = jobOrder;
                
                // Show/hide edit button based on user role
                const editButton = document.getElementById('jobOrderEditButton');
                if (currentUser && currentUser.userType === 'admin') {
                    editButton.style.display = 'flex';
                } else {
                    editButton.style.display = 'none';
                }
                
                // Show the modal
                console.log('Showing modal...');
                document.getElementById('jobOrderDetailsModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                console.error('Job order not found at index:', index);
            }
        }
        
        function closeJobOrderDetailsModal() {
            document.getElementById('jobOrderDetailsModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function openJobOrderEditFromDetails() {
            if (window.currentJobOrderForDetails) {
                closeJobOrderDetailsModal();
                openJobOrderEditModal(window.currentJobOrderForDetails);
            }
        }
        
        async function printJobOrderFromDetails() {
            if (window.currentJobOrderForDetails) {
                await printJobOrder(window.currentJobOrderForDetails.formNumber);
            }
        }
        
        function openProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileMsg').textContent = '';
            loadUserProfile();
            toggleProfileMenu();
        }
        
        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }
        
        // Update navigation visibility based on user type
        function updateNavigationVisibility() {
            if (!currentUser) return;
            
            // Get all navigation items
            const traditionalNavItems = document.querySelectorAll('.nav-traditional');
            const generalNavItems = document.querySelectorAll('.nav-general');
            const adminNavItems = document.querySelectorAll('.nav-admin');
            
            if (currentUser.userType === 'admin') {
                // Admin can see ALL navigation items (traditional + general + admin)
                traditionalNavItems.forEach(item => {
                    item.style.display = 'flex';
                });
                generalNavItems.forEach(item => {
                    item.style.display = 'flex';
                });
                adminNavItems.forEach(item => {
                    item.style.display = 'flex';
                });
            } else if (currentUser.userType === 'user') {
                // Regular users (previous users) can ONLY see traditional navigation, NOT the new general navigation and NOT admin items
                traditionalNavItems.forEach(item => {
                    item.style.display = 'flex';
                });
                generalNavItems.forEach(item => {
                    item.style.display = 'none';
                });
                adminNavItems.forEach(item => {
                    item.style.display = 'none';
                });
            } else {
                // Non-admin, non-user (department users) can ONLY see the new general navigation items
                traditionalNavItems.forEach(item => {
                    item.style.display = 'none';
                });
                generalNavItems.forEach(item => {
                    item.style.display = 'flex';
                });
                adminNavItems.forEach(item => {
                    item.style.display = 'none';
                });
            }
        }
        
        // Load user profile data into the form
        async function loadUserProfile() {
            if (!currentUser) return;
            
            showLoading('Loading Profile...', 'Fetching your profile information');
            
            try {
                setProgress(30);
                const formData = new FormData();
                formData.append('action', 'getUserProfile');
                formData.append('username', currentUser.username);
                
                setProgress(50);
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                setProgress(80);
                const result = await res.json();
                
                if (result.success && result.user) {
                    const form = document.getElementById('profileForm');
                    form.username.value = result.user.username;
                    form.fullName.value = result.user.fullName || '';
                    form.email.value = result.user.email || '';
                    form.phone.value = result.user.phone || '';
                    form.userType.value = result.user.userType || '';
                    
                    // Load profile picture
                    updateProfilePicture(result.user.profilePicture);
                    updateLoadingText('Profile Loaded!', 'Profile information updated successfully');
                } else {
                    updateLoadingText('Profile Load Error', 'Failed to load profile information');
                }
                hideLoading();
            } catch (error) {
                console.error('Error loading profile:', error);
                updateLoadingText('Network Error', 'Failed to connect to server');
                setTimeout(hideLoading, 1000);
            }
        }
        
        // Handle profile image change with compression
        function handleProfileImageChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (max 5MB for initial upload, we'll compress it)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            // Show loading state
            const profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            
            profilePlaceholder.innerHTML = `
                <div class="flex flex-col items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                    <span class="text-xs text-gray-500">Processing image...</span>
                </div>
            `;
            
            // Compress and resize the image
            compressImage(file, 150, 150, 0.8).then(compressedBase64 => {
                // Check if compressed image is still too large for Google Sheets
                if (compressedBase64.length > 45000) { // Leave some buffer
                    // Try more aggressive compression
                    compressImage(file, 120, 120, 0.6).then(moreCompressedBase64 => {
                        if (moreCompressedBase64.length > 45000) {
                            // Final attempt with very aggressive compression
                            compressImage(file, 100, 100, 0.4).then(finalBase64 => {
                                if (finalBase64.length > 45000) {
                                    alert('Image is too complex to compress within limits. Please try a simpler image or smaller file.');
                                    resetProfileImagePreview();
                                } else {
                                    updateImagePreview(finalBase64);
                                }
                            }).catch(handleCompressionError);
                        } else {
                            updateImagePreview(moreCompressedBase64);
                        }
                    }).catch(handleCompressionError);
                } else {
                    updateImagePreview(compressedBase64);
                }
            }).catch(handleCompressionError);
        }
        
        // Compress and resize image to fit Google Sheets limits
        function compressImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions maintaining aspect ratio
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with compression
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedBase64);
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load image'));
                };
                
                // Create object URL for the image
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Update image preview after compression
        function updateImagePreview(base64String) {
            const profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            
            profilePreview.src = base64String;
            profilePreview.classList.remove('hidden');
            profilePlaceholder.classList.add('hidden');
            
            // Show compression info
            const compressionInfo = document.createElement('div');
            compressionInfo.className = 'text-xs text-green-600 mt-2';
            compressionInfo.textContent = `Image compressed to ${Math.round(base64String.length / 1024)}KB`;
            
            // Remove any existing compression info
            const existingInfo = profilePlaceholder.parentNode.querySelector('.text-green-600');
            if (existingInfo) existingInfo.remove();
            
            profilePlaceholder.parentNode.appendChild(compressionInfo);
        }
        
        // Reset profile image preview on error
        function resetProfileImagePreview() {
            const profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            
            profilePreview.classList.add('hidden');
            profilePlaceholder.classList.remove('hidden');
            profilePlaceholder.innerHTML = `
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            `;
            
            // Clear file input
            document.getElementById('profileImageInput').value = '';
        }
        
        // Handle compression errors
        function handleCompressionError(error) {
            console.error('Image compression failed:', error);
            alert('Failed to process image. Please try a different image.');
            resetProfileImagePreview();
        }
        
        // Update profile picture display
        function updateProfilePicture(base64Image) {
            const profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            const headerProfileImage = document.getElementById('headerProfileImage');
            const headerProfileInitials = document.getElementById('headerProfileInitials');
            const dropdownProfileImage = document.getElementById('dropdownProfileImage');
            const dropdownProfileInitials = document.getElementById('dropdownProfileInitials');
            
            if (base64Image) {
                // Update modal preview
                profilePreview.src = base64Image;
                profilePreview.classList.remove('hidden');
                profilePlaceholder.classList.add('hidden');
                
                // Update header image
                headerProfileImage.src = base64Image;
                headerProfileImage.classList.remove('hidden');
                headerProfileInitials.classList.add('hidden');
                
                // Update dropdown image
                if (dropdownProfileImage && dropdownProfileInitials) {
                    dropdownProfileImage.src = base64Image;
                    dropdownProfileImage.classList.remove('hidden');
                    dropdownProfileInitials.classList.add('hidden');
                }
            } else {
                // Show placeholders
                profilePreview.classList.add('hidden');
                profilePlaceholder.classList.remove('hidden');
                headerProfileImage.classList.add('hidden');
                headerProfileInitials.classList.remove('hidden');
                
                // Show dropdown placeholders
                if (dropdownProfileImage && dropdownProfileInitials) {
                    dropdownProfileImage.classList.add('hidden');
                    dropdownProfileInitials.classList.remove('hidden');
                }
                
                // Update initials
                if (currentUser && currentUser.fullName) {
                    const names = currentUser.fullName.split(' ');
                    const initials = names.map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase();
                    headerProfileInitials.textContent = initials;
                    if (dropdownProfileInitials) {
                        dropdownProfileInitials.textContent = initials;
                    }
                }
            }
        }
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            toggleProfileMenu();
        }
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }
        function changePassword() {
            alert('Password changed successfully!');
            closePasswordModal();
        }
        // Usage log functions
        function openUsageModal() {
            document.getElementById('usageModal').classList.remove('hidden');
            
            // Set today's date as default for activity date
            const form = document.getElementById('usageLogForm');
            if (form && form.activityDate) {
                const today = new Date();
                const todayString = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                form.activityDate.value = todayString;
                
                // Auto-fill the day
                updateDayField();
            }
            
            // Add event listener for activity date changes
            if (form && form.activityDate) {
                // Remove existing listener to prevent duplicates
                form.activityDate.removeEventListener('change', updateDayField);
                // Add new listener
                form.activityDate.addEventListener('change', updateDayField);
            }
            
            // Only populate venues dropdown if it's empty or venues are loaded
            if (venues.length === 0) {
                fetchVenues(false);
            } else {
                const venueSelect = document.getElementById('usageVenueSelect');
                if (venueSelect && venueSelect.options.length <= 1) {
                    populateUsageVenueDropdown();
                }
            }
            
            // Load and populate departments if not already loaded or if dropdown is empty
            if (departments.length === 0) {
                fetchDepartments(false);
            } else {
                const deptSelect = document.querySelector('#usageModal select[name="department"]');
                if (deptSelect && deptSelect.options.length <= 1) {
                    populateDepartmentDropdowns();
                }
            }
        }

        function updateDayField() {
            const form = document.getElementById('usageLogForm');
            if (!form || !form.activityDate || !form.day) return;
            
            const dateValue = form.activityDate.value;
            if (dateValue) {
                const date = new Date(dateValue);
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                form.day.value = days[date.getDay()];
            }
        }

        function populateUsageVenueDropdown() {
            const venueSelect = document.getElementById('usageVenueSelect');
            if (!venueSelect) return;
            
            // Save current selection if any
            const currentValue = venueSelect.value;
            
            // Clear existing options except the first one
            venueSelect.innerHTML = '<option value="">Select a venue...</option>';
            
            // Filter venues based on user's assignments
            let availableVenues = venues;
            if (currentUser && currentUser.userType !== 'admin' && currentUser.venueAssignments !== 'ALL') {
                const allowedVenues = currentUser.venueAssignments.split(',').map(v => v.trim());
                availableVenues = venues.filter(venue => allowedVenues.includes(venue.name));
            }
            
            availableVenues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.name;
                option.textContent = venue.name;
                venueSelect.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue && venueSelect.querySelector(`option[value="${currentValue}"]`)) {
                venueSelect.value = currentValue;
            }
        }
        
        function closeUsageModal() {
            document.getElementById('usageModal').classList.add('hidden');
        }
        async function saveUsageLog() {
            const form = document.getElementById('usageLogForm');
            if (!form) return;
            
            // Get selected facilities
            const selectedFacilities = [];
            const checkboxes = form.querySelectorAll('input[name="facilities"]:checked');
            checkboxes.forEach(checkbox => {
                selectedFacilities.push(checkbox.value);
            });
            
            // Add additional facilities if any
            const additionalFacilities = form.additionalFacilities.value.trim();
            if (additionalFacilities) {
                selectedFacilities.push(additionalFacilities);
            }
            
            // Validate required fields
            if (!form.venue.value || !form.activityDate.value || !form.department.value || !form.startTime.value || !form.endTime.value) {
                alert('Please fill all required fields.');
                return;
            }
            
            showLoading('Saving Usage Log...', 'Processing your venue usage log entry');
            
            // Get form data
            const formData = new FormData();
            formData.append('action', 'addUsageLog');
            formData.append('venue', form.venue.value);
            
            setProgress(20);
            
            // Ensure date is in YYYY-MM-DD format
            const activityDate = form.activityDate.value;
            if (activityDate) {
                formData.append('activityDate', activityDate); // HTML date input already gives YYYY-MM-DD
            }
            
            formData.append('day', form.day.value);
            formData.append('department', form.department.value);
            formData.append('startTime', form.startTime.value);
            formData.append('endTime', form.endTime.value);
            formData.append('purpose', form.purpose.value);
            formData.append('facilities', selectedFacilities.join(', '));
            
            setProgress(40);
            
            try {
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                setProgress(70);
                const result = await res.json();
                setProgress(85);
                
                if (result.success) {
                    updateLoadingText('Usage Log Saved!', 'Updating real-time data...');
                    form.reset();
                    closeUsageModal();
                    
                    // Trigger instant refresh for usage logs
                    await triggerInstantRefresh('usage-logs');
                    hideLoading();
                    alert('Event log saved successfully!');
                } else {
                    updateLoadingText('Error Saving Log', 'Failed to save usage log entry');
                    setTimeout(hideLoading, 1000);
                    alert('Error saving event log: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving event log:', error);
                updateLoadingText('Network Error', 'Failed to connect to server');
                setTimeout(hideLoading, 1000);
                alert('Error saving event log. Please try again.');
            }
        }

        // Usage log data
        let usageLogs = [];
        let currentEditingUsageLog = null; // Track currently editing usage log

        // Fetch usage logs from backend with caching
        async function fetchUsageLogs(showLoader = true) {
            // INSTANT LOAD: Try loading from cache first
            if (showLoader && loadUsageLogsFromCache()) {
                // Start background sync for fresh data
                syncUsageLogsInBackground();
                return;
            }
            
            if (showLoader) {
                showLoading('Loading Usage Logs...', 'Fetching venue usage history from database');
            }
            try {
                if (showLoader) setProgress(20);
                const formData = new FormData();
                formData.append('action', 'getUsageLogs');
                
                if (showLoader) setProgress(40);
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                if (showLoader) setProgress(70);
                const result = await res.json();
                if (showLoader) setProgress(90);
                
                if (result.success && result.usageLogs) {
                    usageLogs = result.usageLogs;
                    saveUsageLogsToCache(); // Save to cache
                    if (showLoader) updateLoadingText('Usage Logs Loaded!', 'Successfully loaded usage history');
                } else {
                    usageLogs = [];
                    if (showLoader) updateLoadingText('No Usage Logs Found', 'No usage history available');
                }
                loadUsageLog(); // Update display
                if (showLoader) hideLoading();
            } catch (err) {
                usageLogs = [];
                console.error('Error fetching usage logs:', err);
                if (showLoader) {
                    updateLoadingText('Error Loading Usage Logs', 'Failed to fetch usage history');
                    setTimeout(hideLoading, 1000);
                }
            }
        }

        function loadUsageLog() {
            const tbody = document.getElementById('usageLogTableBody');
            tbody.innerHTML = '';
            
            // Use filtered data if filters are applied, otherwise use all data
            const dataToDisplay = filteredUsageLogs || usageLogs;
            
            if (dataToDisplay.length === 0) {
                const noDataMessage = filteredUsageLogs ? 'No event logs match your filters' : 'No event logs found';
                const subMessage = filteredUsageLogs ? 'Try adjusting your filter criteria' : 'Start by logging an event activity';
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-4 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <p class="text-lg font-medium text-gray-400 mb-2">${noDataMessage}</p>
                                <p class="text-sm text-gray-400">${subMessage}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            dataToDisplay.forEach((usage, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors cursor-pointer';
                row.onclick = () => openUsageDetailModal(usage);
                
                // Format timestamps - with better error handling
                const timestamp = usage.timestamp ? (() => {
                    try {
                        const date = new Date(usage.timestamp);
                        // Check for invalid dates or the problematic 1899 date
                        if (isNaN(date.getTime()) || date.getFullYear() === 1899) {
                            return 'Invalid Date';
                        }
                        return date.toLocaleString('en-US', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return 'Invalid Date';
                    }
                })() : '';
                
                const activityDate = usage.activityDate ? (() => {
                    try {
                        // If activityDate is already in YYYY-MM-DD format, just format it nicely
                        if (typeof usage.activityDate === 'string' && usage.activityDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const [year, month, day] = usage.activityDate.split('-');
                            return `${month}/${day}`;
                        }
                        const date = new Date(usage.activityDate);
                        // Check for invalid dates or the problematic 1899 date
                        if (isNaN(date.getTime()) || date.getFullYear() === 1899) {
                            return 'Invalid Date';
                        }
                        return date.toLocaleDateString('en-US', {
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } catch (e) {
                        return 'Invalid Date';
                    }
                })() : '';
                
                row.innerHTML = `
                    <td class="w-32 px-3 py-3 text-xs text-gray-600 truncate" title="${usage.timestamp ? new Date(usage.timestamp).toLocaleString() : ''}">${timestamp}</td>
                    <td class="w-24 px-3 py-3 text-xs text-blue-600 truncate" title="${usage.logId || 'N/A'}">${usage.logId ? usage.logId.split('-')[1] || usage.logId : 'N/A'}</td>
                    <td class="w-32 px-3 py-3 text-sm text-gray-900 truncate" title="${usage.venue || ''}">${usage.venue || ''}</td>
                    <td class="w-28 px-3 py-3 text-sm text-gray-900 truncate">${activityDate}</td>
                    <td class="w-20 px-3 py-3 text-xs text-gray-600 truncate">${usage.day || ''}</td>
                    <td class="w-32 px-3 py-3 text-sm text-gray-900 truncate" title="${usage.department || ''}">${usage.department || ''}</td>
                    <td class="w-24 px-3 py-3 text-xs text-gray-900">
                        <div class="truncate">${usage.startTime || ''}</div>
                        <div class="truncate">${usage.endTime || ''}</div>
                    </td>
                    <td class="flex-1 min-w-0 px-3 py-3 text-sm text-gray-900">
                        <div class="space-y-1">
                            <div class="text-sm font-medium text-gray-900 break-words">${usage.purpose || ''}</div>
                            <div class="text-xs text-gray-600 break-words">
                                <span class="font-medium">Facilities:</span> ${usage.facilities || 'None specified'}
                            </div>
                            <div class="text-xs text-blue-500 mt-1">Click to view details</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Usage Log Detail Modal Functions
        function openUsageDetailModal(usage) {
            currentEditingUsageLog = usage; // Store for potential editing
            
            // Helper function to safely format dates
            function safeFormatDate(dateValue, formatType = 'full') {
                if (!dateValue) return 'N/A';
                
                try {
                    let date;
                    // If it's already in YYYY-MM-DD format, parse it carefully
                    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateValue.split('-');
                        date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    } else {
                        date = new Date(dateValue);
                    }
                    
                    // Check for invalid dates or the problematic 1899 date
                    if (isNaN(date.getTime()) || date.getFullYear() === 1899) {
                        return 'Invalid Date';
                    }
                    
                    if (formatType === 'full') {
                        return date.toLocaleString();
                    } else {
                        return date.toLocaleDateString();
                    }
                } catch (e) {
                    return 'Invalid Date';
                }
            }
            
            // Populate the modal with usage log data
            document.getElementById('detailTimestamp').textContent = safeFormatDate(usage.timestamp, 'full');
            document.getElementById('detailLogId').textContent = usage.logId || 'N/A';
            document.getElementById('detailVenue').textContent = usage.venue || 'N/A';
            document.getElementById('detailDepartment').textContent = usage.department || 'N/A';
            document.getElementById('detailActivityDate').textContent = safeFormatDate(usage.activityDate, 'date');
            document.getElementById('detailDay').textContent = usage.day || 'N/A';
            document.getElementById('detailStartTime').textContent = usage.startTime || 'N/A';
            document.getElementById('detailEndTime').textContent = usage.endTime || 'N/A';
            document.getElementById('detailPurpose').textContent = usage.purpose || 'N/A';
            document.getElementById('detailFacilities').textContent = usage.facilities || 'None specified';
            document.getElementById('detailDateSubmitted').textContent = safeFormatDate(usage.dateSubmitted, 'date');
            
            // Show the modal
            document.getElementById('usageDetailModal').classList.remove('hidden');
        }

        function closeUsageDetailModal() {
            document.getElementById('usageDetailModal').classList.add('hidden');
            currentEditingUsageLog = null;
        }

        // Handle Edit button click with immediate visual feedback
        function handleEditButtonClick() {
            const button = document.getElementById('editUsageButton');
            const buttonText = document.getElementById('editButtonText');
            const spinner = document.getElementById('editButtonSpinner');
            
            // Disable button and show loading state immediately
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
            buttonText.textContent = 'Loading...';
            spinner.classList.remove('hidden');
            
            // Call the actual edit function
            openEditUsageModal();
        }

        // Edit Usage Log Functions
        async function openEditUsageModal() {
            if (!currentEditingUsageLog) return;
            
            // Store the usage log before closing the detail modal
            const usageToEdit = currentEditingUsageLog;
            
            // Show loading feedback immediately
            showLoading('Preparing Edit Form...', 'Loading venue and department options');
            
            // Close detail modal
            closeUsageDetailModal();
            
            try {
                // Show edit modal immediately with loading state
                document.getElementById('editUsageModal').classList.remove('hidden');
                
                // Fill form with current data first (for instant feedback)
                fillEditForm(usageToEdit);
                
                // Set progress
                setProgress(30);
                
                // Populate dropdowns in parallel (using cached data when possible)
                await Promise.all([
                    populateEditVenueDropdown(),
                    populateEditDepartmentDropdown(),
                    populateEditFacilitiesCheckboxes()
                ]);
                
                setProgress(80);
                
                // Re-fill form after dropdowns are populated to ensure values are selected
                fillEditForm(usageToEdit);
                
                // Set the current editing log back (so save function can use it)
                currentEditingUsageLog = usageToEdit;
                
                updateLoadingText('Edit Form Ready!', 'You can now make changes to the usage log');
                hideLoading();
                
                // Reset edit button state
                resetEditButtonState();
                
            } catch (error) {
                console.error('Error opening edit modal:', error);
                updateLoadingText('Error Loading Form', 'Failed to prepare edit form');
                setTimeout(() => {
                    hideLoading();
                    closeEditUsageModal();
                    resetEditButtonState();
                }, 1500);
            }
        }

        // Reset the edit button to its normal state
        function resetEditButtonState() {
            const button = document.getElementById('editUsageButton');
            const buttonText = document.getElementById('editButtonText');
            const spinner = document.getElementById('editButtonSpinner');
            
            if (button && buttonText && spinner) {
                button.disabled = false;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
                buttonText.textContent = 'Edit';
                spinner.classList.add('hidden');
            }
        }

        function closeEditUsageModal() {
            document.getElementById('editUsageModal').classList.add('hidden');
            document.getElementById('editUsageMsg').innerHTML = '';
            currentEditingUsageLog = null;
        }

        async function populateEditVenueDropdown() {
            try {
                // Use cached venues if available, otherwise fetch
                if (venues.length === 0) {
                    const formData = new FormData();
                    formData.append('action', 'getVenues');
                    
                    const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    
                    if (result.success && result.venues) {
                        venues = result.venues; // Cache the venues
                    }
                }
                
                const venueSelect = document.getElementById('editVenue');
                venueSelect.innerHTML = '<option value="">Select a venue</option>';
                
                // Filter venues based on user's assignments
                let availableVenues = venues;
                if (currentUser && currentUser.userType !== 'admin' && currentUser.venueAssignments !== 'ALL') {
                    const allowedVenues = currentUser.venueAssignments.split(',').map(v => v.trim());
                    availableVenues = venues.filter(venue => allowedVenues.includes(venue.name));
                }
                
                availableVenues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.name;
                    option.textContent = venue.name;
                    venueSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error fetching venues for edit:', error);
            }
        }

        async function populateEditDepartmentDropdown() {
            try {
                // Use cached departments if available, otherwise fetch
                if (departments.length === 0) {
                    const formData = new FormData();
                    formData.append('action', 'getDepartments');
                    
                    const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    
                    if (result.success && result.departments) {
                        departments = result.departments; // Cache the departments
                    }
                }
                
                const departmentSelect = document.getElementById('editDepartment');
                departmentSelect.innerHTML = '<option value="">Select a department</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error fetching departments for edit:', error);
            }
        }

        async function populateEditFacilitiesCheckboxes() {
            const facilitiesContainer = document.getElementById('editFacilitiesCheckboxes');
            const commonFacilities = [
                'Projector', 'Whiteboard', 'Audio System', 'TV Screen', 'Microphone',
                'Stage', 'Sound System', 'Computers', 'Conference Table', 'Chairs',
                'Air Conditioning', 'WiFi', 'Power Outlets', 'Podium', 'Lighting'
            ];
            
            facilitiesContainer.innerHTML = '';
            
            commonFacilities.forEach(facility => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="editFacility${facility.replace(/\s+/g, '')}" name="editFacilities" value="${facility}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="editFacility${facility.replace(/\s+/g, '')}" class="ml-2 text-sm text-gray-700">${facility}</label>
                `;
                
                facilitiesContainer.appendChild(checkboxDiv);
            });
        }

        function fillEditForm(usage) {
            if (!usage) {
                console.error('No usage log data provided to fillEditForm');
                return;
            }
            
            // Fill basic fields
            document.getElementById('editLogId').value = usage.logId || '';
            document.getElementById('editVenue').value = usage.venue || '';
            document.getElementById('editDepartment').value = usage.department || '';
            document.getElementById('editPurpose').value = usage.purpose || '';
            
            // Fill date and time fields
            if (usage.activityDate) {
                // Convert to YYYY-MM-DD format if needed
                let dateValue = usage.activityDate;
                if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    document.getElementById('editActivityDate').value = dateValue;
                } else {
                    try {
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            document.getElementById('editActivityDate').value = `${year}-${month}-${day}`;
                        }
                    } catch (e) {
                        console.error('Error parsing activity date:', e);
                    }
                }
            }
            
            // Update day field
            updateEditDayField();
            
            // Fill time fields - convert from 12-hour to 24-hour format
            if (usage.startTime) {
                document.getElementById('editStartTime').value = convertTo24Hour(usage.startTime);
            }
            if (usage.endTime) {
                document.getElementById('editEndTime').value = convertTo24Hour(usage.endTime);
            }
            
            // Fill facilities checkboxes
            const facilities = usage.facilities || '';
            const facilitiesList = facilities.split(',').map(f => f.trim()).filter(f => f);
            
            // Uncheck all checkboxes first
            document.querySelectorAll('#editFacilitiesCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Check relevant facilities
            facilitiesList.forEach(facility => {
                const checkbox = document.querySelector(`#editFacilitiesCheckboxes input[value="${facility}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                } else {
                    // If facility is not in the predefined list, add it to additional facilities
                    const additionalInput = document.getElementById('editAdditionalFacilities');
                    const currentAdditional = additionalInput.value.trim();
                    additionalInput.value = currentAdditional ? `${currentAdditional}, ${facility}` : facility;
                }
            });
        }

        function updateEditDayField() {
            const dateInput = document.getElementById('editActivityDate');
            const dayInput = document.getElementById('editDay');
            
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dayInput.value = days[date.getDay()];
            } else {
                dayInput.value = '';
            }
        }

        function convertTo24Hour(time12h) {
            if (!time12h) return '';
            
            try {
                // Handle formats like "2:30 PM" or "14:30"
                if (time12h.includes('AM') || time12h.includes('PM')) {
                    const [time, modifier] = time12h.split(' ');
                    let [hours, minutes] = time.split(':');
                    
                    if (hours === '12') {
                        hours = '00';
                    }
                    
                    if (modifier === 'PM') {
                        hours = parseInt(hours, 10) + 12;
                    }
                    
                    return `${String(hours).padStart(2, '0')}:${minutes}`;
                } else {
                    // Already in 24-hour format
                    return time12h;
                }
            } catch (e) {
                console.error('Error converting time:', e);
                return '';
            }
        }

        async function updateUsageLog() {
            const form = document.getElementById('editUsageLogForm');
            const msgDiv = document.getElementById('editUsageMsg');
            
            if (!form) return;
            
            // Get selected facilities
            const selectedFacilities = [];
            const checkboxes = form.querySelectorAll('input[name="editFacilities"]:checked');
            checkboxes.forEach(checkbox => {
                selectedFacilities.push(checkbox.value);
            });
            
            // Add additional facilities if any
            const additionalFacilities = form.editAdditionalFacilities.value.trim();
            if (additionalFacilities) {
                selectedFacilities.push(additionalFacilities);
            }
            
            // Validate required fields
            if (!form.editVenue.value || !form.editActivityDate.value || !form.editDepartment.value || 
                !form.editStartTime.value || !form.editEndTime.value || !form.editPurpose.value) {
                msgDiv.innerHTML = '<span class="text-red-600">Please fill all required fields.</span>';
                return;
            }
            
            showLoading('Updating Usage Log...', 'Processing your changes');
            
            try {
                // Get form data
                const formData = new FormData();
                formData.append('action', 'updateUsageLog');
                formData.append('logId', form.editLogId.value);
                formData.append('venue', form.editVenue.value);
                formData.append('activityDate', form.editActivityDate.value);
                formData.append('day', form.editDay.value);
                formData.append('department', form.editDepartment.value);
                formData.append('startTime', form.editStartTime.value);
                formData.append('endTime', form.editEndTime.value);
                formData.append('purpose', form.editPurpose.value);
                formData.append('facilities', selectedFacilities.join(', '));
                
                setProgress(50);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                setProgress(80);
                const result = await res.json();
                setProgress(100);
                
                if (result.success) {
                    updateLoadingText('Usage Log Updated!', 'Changes saved successfully');
                    closeEditUsageModal();
                    
                    // Trigger instant refresh for usage logs
                    await triggerInstantRefresh('usage-logs');
                    hideLoading();
                    
                    msgDiv.innerHTML = '<span class="text-green-600">Usage log updated successfully!</span>';
                    setTimeout(() => {
                        msgDiv.innerHTML = '';
                    }, 2000);
                } else {
                    updateLoadingText('Error Updating Log', 'Failed to save changes');
                    setTimeout(hideLoading, 1000);
                    msgDiv.innerHTML = '<span class="text-red-600">Error updating usage log: ' + (result.error || 'Unknown error') + '</span>';
                }
            } catch (error) {
                console.error('Error updating usage log:', error);
                updateLoadingText('Network Error', 'Failed to connect to server');
                setTimeout(hideLoading, 1000);
                msgDiv.innerHTML = '<span class="text-red-600">Error updating usage log. Please try again.</span>';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('usageDetailModal');
            if (e.target === modal) {
                closeUsageDetailModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('usageDetailModal');
                if (!modal.classList.contains('hidden')) {
                    closeUsageDetailModal();
                }
            }
        });

        // Usage Log Filtering Functions
        let filteredUsageLogs = null;

        function filterUsageLogs() {
            const venueFilter = document.getElementById('usageVenueFilter').value;
            const dateFromFilter = document.getElementById('usageFromDateFilter').value;
            const dateToFilter = document.getElementById('usageToDateFilter').value;

            if (!venueFilter && !dateFromFilter && !dateToFilter) {
                // No filters applied, show all logs
                filteredUsageLogs = null;
                loadUsageLog();
                return;
            }

            // Apply filters to the usage logs
            filteredUsageLogs = usageLogs.filter(log => {
                let matches = true;

                // Venue filter
                if (venueFilter && log.venue !== venueFilter) {
                    matches = false;
                }

                // Date range filter
                if (dateFromFilter || dateToFilter) {
                    const logDate = log.activityDate;
                    if (logDate) {
                        // Ensure date is in YYYY-MM-DD format
                        let logDateStr = logDate;
                        if (logDate instanceof Date) {
                            const year = logDate.getFullYear();
                            const month = String(logDate.getMonth() + 1).padStart(2, '0');
                            const day = String(logDate.getDate()).padStart(2, '0');
                            logDateStr = `${year}-${month}-${day}`;
                        }

                        if (dateFromFilter && logDateStr < dateFromFilter) {
                            matches = false;
                        }
                        if (dateToFilter && logDateStr > dateToFilter) {
                            matches = false;
                        }
                    }
                }

                return matches;
            });

            loadUsageLog();
        }

        function clearUsageFilters() {
            document.getElementById('usageVenueFilter').value = '';
            document.getElementById('usageFromDateFilter').value = '';
            document.getElementById('usageToDateFilter').value = '';
            filteredUsageLogs = null;
            loadUsageLog();
        }

        // Populate venue filter dropdown
        async function populateVenueFilter() {
            try {
                const formData = new FormData();
                formData.append('action', 'getVenues');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.venues) {
                    const venueSelect = document.getElementById('usageVenueFilter');
                    venueSelect.innerHTML = '<option value="">All Venues</option>';
                    
                    result.venues.forEach(venue => {
                        const option = document.createElement('option');
                        option.value = venue.name;
                        option.textContent = venue.name;
                        venueSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error fetching venues for filter:', error);
            }
        }

        // Export Functions
        function exportUsageLogToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // University Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('UNIVERSITY OF SAN JOSE RECOLETOS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Venue Usage Log Report', 105, 30, { align: 'center' });
            
            // Date range info
            const dateFrom = document.getElementById('usageFromDateFilter').value;
            const dateTo = document.getElementById('usageToDateFilter').value;
            const venue = document.getElementById('usageVenueFilter').value;
            
            let filterInfo = 'Generated on: ' + new Date().toLocaleDateString();
            if (dateFrom || dateTo || venue) {
                filterInfo += ' | Filters: ';
                if (venue) filterInfo += `Venue: ${venue} `;
                if (dateFrom) filterInfo += `From: ${dateFrom} `;
                if (dateTo) filterInfo += `To: ${dateTo}`;
            }
            
            doc.setFontSize(8);
            doc.text(filterInfo, 105, 40, { align: 'center' });
            
            // Prepare data for table
            const dataToExport = filteredUsageLogs || usageLogs;
            const tableData = dataToExport.map(log => [
                log.logId ? log.logId.split('-')[1] || log.logId : 'N/A',
                log.venue || '',
                log.department || '',
                log.activityDate || '',
                log.day || '',
                log.startTime || '',
                log.endTime || '',
                log.purpose || ''
            ]);
            
            // Add table
            doc.autoTable({
                head: [['Log ID', 'Venue', 'Department', 'Date', 'Day', 'Start Time', 'End Time', 'Purpose']],
                body: tableData,
                startY: 50,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { top: 50, left: 10, right: 10 }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 195, 285, { align: 'right' });
                doc.text('University of San Jose Recoletos - Venue Management System', 10, 285);
            }
            
            // Save the PDF
            const fileName = `Usage_Log_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function exportUsageLogToExcel() {
            const dataToExport = filteredUsageLogs || usageLogs;
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Prepare header rows
            let headerRows = [
                ['UNIVERSITY OF SAN JOSE RECOLETOS'],
                ['Venue Usage Log Report'],
                [''],
                [`Generated on: ${new Date().toLocaleDateString()}`]
            ];
            
            // Add filter information if any
            const dateFrom = document.getElementById('usageFromDateFilter').value;
            const dateTo = document.getElementById('usageToDateFilter').value;
            const venue = document.getElementById('usageVenueFilter').value;
            
            if (dateFrom || dateTo || venue) {
                let filterInfo = 'Filters Applied: ';
                if (venue) filterInfo += `Venue: ${venue} `;
                if (dateFrom) filterInfo += `From: ${dateFrom} `;
                if (dateTo) filterInfo += `To: ${dateTo}`;
                
                headerRows.push(['']);
                headerRows.push([filterInfo]);
            }
            
            // Add spacing and column headers
            headerRows.push(['']);
            headerRows.push(['Log ID', 'Venue', 'Department', 'Activity Date', 'Day', 'Start Time', 'End Time', 'Purpose', 'Facilities Used', 'Date Submitted', 'Timestamp']);
            
            // Prepare data rows
            const dataRows = dataToExport.map(log => [
                log.logId ? log.logId.split('-')[1] || log.logId : 'N/A',
                log.venue || '',
                log.department || '',
                log.activityDate || '',
                log.day || '',
                log.startTime || '',
                log.endTime || '',
                log.purpose || '',
                log.facilities || '',
                log.dateSubmitted || '',
                log.timestamp ? new Date(log.timestamp).toLocaleString() : ''
            ]);
            
            // Combine all rows
            const allRows = [...headerRows, ...dataRows];
            
            // Create worksheet from all data
            const ws = XLSX.utils.aoa_to_sheet(allRows);
            
            // Set column widths
            const colWidths = [
                { wch: 12 }, // Log ID
                { wch: 20 }, // Venue
                { wch: 25 }, // Department
                { wch: 12 }, // Activity Date
                { wch: 10 }, // Day
                { wch: 12 }, // Start Time
                { wch: 12 }, // End Time
                { wch: 30 }, // Purpose
                { wch: 25 }, // Facilities Used
                { wch: 12 }, // Date Submitted
                { wch: 18 }  // Timestamp
            ];
            ws['!cols'] = colWidths;
            
            // Add the worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Usage Log Report');
            
            // Save the file
            const fileName = `Usage_Log_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // User Management functions
        let managedUsers = [];

        async function refreshUsersList() {
            showLoading('Loading Users...', 'Fetching user management data');
            try {
                setProgress(30);
                const formData = new FormData();
                formData.append('action', 'getUsers');
                
                setProgress(60);
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                setProgress(85);
                const result = await res.json();
                
                if (result.success && result.users) {
                    managedUsers = result.users;
                    loadUsersList();
                    updateLoadingText('Users Loaded!', 'User management data updated successfully');
                    hideLoading();
                } else {
                    console.error('Error fetching users:', result.error);
                    showUsersEmpty();
                    updateLoadingText('No Users Found', 'No user data available');
                    setTimeout(hideLoading, 1000);
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                showUsersEmpty();
                updateLoadingText('Error Loading Users', 'Failed to fetch user data');
                setTimeout(hideLoading, 1000);
            }
        }

        // Silent version of refreshUsersList for background updates
        async function refreshUsersListSilent() {
            try {
                const formData = new FormData();
                formData.append('action', 'getUsers');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const result = await res.json();
                
                if (result.success && result.users) {
                    managedUsers = result.users;
                    loadUsersList();
                } else {
                    console.log('No users found during background refresh');
                }
            } catch (error) {
                console.error('Error during background users refresh:', error);
            }
        }

        function loadUsersList() {
            const tbody = document.getElementById('usersTableBody');
            const loading = document.getElementById('usersLoading');
            const empty = document.getElementById('usersEmpty');
            
            if (!tbody) return;
            
            loading.classList.add('hidden');
            
            if (managedUsers.length === 0) {
                tbody.style.display = 'none';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            tbody.style.display = 'table-row-group';
            tbody.innerHTML = '';
            
            managedUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const statusClass = user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const typeClass = user.userType === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
                
                // Format venue assignments display
                const venueAssignments = user.venueAssignments || 'ALL';
                const venueDisplayText = venueAssignments === 'ALL' ? 'All Venues' : 
                    (venueAssignments.split(',').length > 2 ? 
                        `${venueAssignments.split(',').slice(0, 2).join(', ')}...` : 
                        venueAssignments);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    ${user.profilePicture ? 
                                        `<img class="h-10 w-10 rounded-full object-cover" src="${user.profilePicture}" alt="">` :
                                        `<span class="text-sm font-medium text-gray-700">${user.fullName.charAt(0)}</span>`
                                    }
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
                                <div class="text-sm text-gray-500">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${user.email}</div>
                        <div class="text-sm text-gray-500">${user.phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                            ${user.userType}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900" title="${venueAssignments}">
                            ${venueDisplayText}
                        </div>
                        <button class="venue-edit-btn text-xs text-blue-600 hover:text-blue-900 transition-colors"
                                data-username="${user.username}" 
                                data-venues="${venueAssignments.replace(/"/g, '&quot;')}">
                            Edit
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="toggleUserStatus('${user.username}', '${user.status}')" 
                                    class="text-indigo-600 hover:text-indigo-900 transition-colors">
                                ${user.status === 'Active' ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="confirmDeleteUser('${user.username}')" 
                                    class="text-red-600 hover:text-red-900 transition-colors">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners for venue edit buttons
            document.querySelectorAll('.venue-edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const venues = this.getAttribute('data-venues');
                    editVenueAssignments(username, venues);
                });
            });
        }

        function showUsersEmpty() {
            const tbody = document.getElementById('usersTableBody');
            const loading = document.getElementById('usersLoading');
            const empty = document.getElementById('usersEmpty');
            
            if (loading) loading.classList.add('hidden');
            if (tbody) tbody.style.display = 'none';
            if (empty) empty.classList.remove('hidden');
        }

        async function toggleUserStatus(username, currentStatus) {
            const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
            
            if (!confirm(`Are you sure you want to ${newStatus.toLowerCase()} user "${username}"?`)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'updateUserStatus');
                formData.append('username', username);
                formData.append('status', newStatus);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success) {
                    alert(result.message);
                    // Trigger instant refresh for users
                    await triggerInstantRefresh('users');
                } else {
                    alert('Error updating user status: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error updating user status. Please try again.');
            }
        }

        async function confirmDeleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'deleteUser');
                formData.append('username', username);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success) {
                    alert(result.message);
                    // Trigger instant refresh for users
                    await triggerInstantRefresh('users');
                } else {
                    alert('Error deleting user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user. Please try again.');
            }
        }

        // Venue assignment functions
        async function editVenueAssignments(username, currentAssignments) {
            console.log('editVenueAssignments called with:', username, currentAssignments); // Debug log
            
            const modal = document.getElementById('venueAssignmentModal');
            const usernameInput = document.getElementById('assignmentUsername');
            const venueCheckboxes = document.getElementById('venueCheckboxes');
            const allVenuesRadio = document.querySelector('input[name="venueAccess"][value="ALL"]');
            const specificVenuesRadio = document.querySelector('input[name="venueAccess"][value="SPECIFIC"]');
            
            // Check if elements exist
            if (!modal) {
                console.error('venueAssignmentModal not found');
                alert('Modal not found. Please refresh the page.');
                return;
            }
            
            if (!usernameInput) {
                console.error('assignmentUsername input not found');
                alert('Username input not found. Please refresh the page.');
                return;
            }
            
            // Set username
            usernameInput.value = username;
            
            // Load available venues
            try {
                const formData = new FormData();
                formData.append('action', 'getVenues');
                
                console.log('Fetching venues...'); // Debug log
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                console.log('Venues result:', result); // Debug log
                
                if (result.success && result.venues) {
                    // Populate venue checkboxes
                    venueCheckboxes.innerHTML = '';
                    result.venues.forEach(venue => {
                        const isChecked = currentAssignments !== 'ALL' && 
                            currentAssignments.split(',').map(v => v.trim()).includes(venue.name);
                        
                        const checkbox = document.createElement('label');
                        checkbox.className = 'flex items-center space-x-2 text-sm';
                        checkbox.innerHTML = `
                            <input type="checkbox" value="${venue.name}" ${isChecked ? 'checked' : ''} 
                                   class="text-blue-600 focus:ring-blue-500 mr-3">
                            <span>${venue.name}</span>
                        `;
                        venueCheckboxes.appendChild(checkbox);
                    });
                    
                    // Set initial radio button state
                    if (currentAssignments === 'ALL') {
                        allVenuesRadio.checked = true;
                    } else {
                        specificVenuesRadio.checked = true;
                    }
                    
                    // Show modal
                    console.log('Showing modal...'); // Debug log
                    modal.classList.remove('hidden');
                } else {
                    console.error('Failed to load venues:', result.error);
                    alert('Failed to load venues: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading venues:', error);
                alert('Error loading venues. Please try again.');
            }
        }
        
        function closeVenueAssignmentModal() {
            const modal = document.getElementById('venueAssignmentModal');
            const msgDiv = document.getElementById('venueAssignmentMsg');
            modal.classList.add('hidden');
            msgDiv.innerHTML = '';
        }
        
        // Handle venue assignment form submission
        document.getElementById('venueAssignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('assignmentUsername').value;
            const accessType = document.querySelector('input[name="venueAccess"]:checked').value;
            const msgDiv = document.getElementById('venueAssignmentMsg');
            
            let venueAssignments = 'ALL';
            
            if (accessType === 'SPECIFIC') {
                const checkedVenues = Array.from(document.querySelectorAll('#venueCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                if (checkedVenues.length === 0) {
                    msgDiv.innerHTML = '<span class="text-red-600">Please select at least one venue or choose "All Venues".</span>';
                    return;
                }
                
                venueAssignments = checkedVenues.join(', ');
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'updateUserVenueAssignments');
                formData.append('username', username);
                formData.append('venueAssignments', venueAssignments);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success) {
                    msgDiv.innerHTML = '<span class="text-green-600">Venue assignments updated successfully!</span>';
                    setTimeout(async () => {
                        closeVenueAssignmentModal();
                        // Trigger instant refresh for users
                        await triggerInstantRefresh('users');
                    }, 1500);
                } else {
                    msgDiv.innerHTML = '<span class="text-red-600">Error: ' + (result.error || 'Unknown error') + '</span>';
                }
            } catch (error) {
                console.error('Error updating venue assignments:', error);
                msgDiv.innerHTML = '<span class="text-red-600">Error updating assignments. Please try again.</span>';
            }
        });

        // Messaging functions with enhanced performance
        let allUsers = [];
        let backupUsers = []; // Backup copy to prevent user loss during messaging
        let selectedUser = null;
        let messages = [];
        let lastKnownMessageIds = new Set(); // Track known message IDs for highlighting new ones
        let newMessageHighlights = new Set(); // Track which messages should be highlighted as new
        let messagePollingInterval = null;
        let unreadCountsPollingInterval = null;
        let unreadCounts = {};
        let messagesCache = new Map(); // Cache messages per user to reduce API calls
        let usersCache = null; // Cache users data
        let lastMessagesFetch = 0; // Throttle message fetching
        let backgroundLoadingQueue = new Set(); // Prevent duplicate background loads
        let isLoadingMessages = false; // Prevent concurrent message loading
        let lastDisplayUpdate = 0; // Prevent rapid display updates
        let displayUpdateDebounce = null; // Debounce display updates
        
        // Enhanced persistent caching system
        const USERS_CACHE_KEY = 'venue_system_users_cache';
        const USERS_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
        const USERS_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minutes for background sync
        let lastUsersSync = 0;
        let usersSyncInterval = null;
        
        // Enhanced messages caching system
        const MESSAGES_CACHE_KEY_PREFIX = 'venue_system_messages_';
        const MESSAGES_CACHE_EXPIRY = 7 * 24 * 60 * 60 * 1000; // 7 days
        const MESSAGES_SYNC_INTERVAL = 3 * 1000; // 3 seconds for message sync
        let lastMessageSync = 0;

        // Enhanced usage logs caching system
        const USAGE_LOGS_CACHE_KEY = 'venue_system_usage_logs_cache';
        const USAGE_LOGS_CACHE_EXPIRY = 6 * 60 * 60 * 1000; // 6 hours
        const USAGE_LOGS_SYNC_INTERVAL = 30 * 1000; // 30 seconds for background sync
        let lastUsageLogsSync = 0;
        let usageLogsSyncInterval = null;

        // NEW: Instant users loading for messages section
        async function loadUsersInstant() {
            console.log('Loading users instantly with cache-first approach');
            
            // PRIORITY 1: Load from cache instantly (0ms)
            const hasCache = loadUsersFromCache();
            if (hasCache && allUsers.length > 0) {
                console.log('INSTANT: Displaying users from cache');
                displayUsers(allUsers);
                
                // Fetch unread counts immediately
                fetchUnreadCounts().then(() => {
                    displayUsers(allUsers); // Refresh with unread counts
                    updateNavigationUnreadIndicator();
                });
            } else {
                console.log('No cache available, showing loading state');
                // Show minimal loading indicator
                const usersList = document.getElementById('usersList');
                if (usersList) {
                    usersList.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                            Loading users...
                        </div>
                    `;
                }
            }
            
            // PRIORITY 2: Background refresh (parallel with display)
            setTimeout(() => {
                fetchAllUsersWithBatchData(true).then(() => {
                    console.log('Background: Users refreshed');
                    displayUsers(allUsers);
                    return fetchUnreadCounts();
                }).then(() => {
                    console.log('Background: Unread counts updated');
                    displayUsers(allUsers);
                    updateNavigationUnreadIndicator();
                }).catch(error => {
                    console.error('Background refresh failed:', error);
                    // Fallback to legacy method
                    loadAllUsers();
                });
            }, 10); // Immediate background refresh
            
            // Clear message polling when entering messages section
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
        }

        function loadAllUsers() {
            // INSTANT LOAD: Display cached users immediately for instant UI response
            loadUsersFromCache();
            
            // BACKGROUND SYNC: Update users in background without UI delay
            syncUsersInBackground();
        }

        // NEW: Load users from localStorage cache instantly
        function loadUsersFromCache() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            try {
                const cachedData = localStorage.getItem(USERS_CACHE_KEY);
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    const cacheAge = Date.now() - parsedCache.timestamp;
                    
                    // Use cache if it's not too old (24 hours)
                    if (cacheAge < USERS_CACHE_EXPIRY && parsedCache.users) {
                        // Filter with defensive checks
                        const cachedUsers = parsedCache.users.filter(user => 
                            user && user.username && user.username !== currentUser?.username
                        );
                        
                        // Only update if we got valid cached data
                        if (cachedUsers.length > 0 || parsedCache.users.length === 0) {
                            allUsers = cachedUsers;
                            unreadCounts = parsedCache.unreadCounts || {};
                            
                            // Display users instantly - no loading state
                            displayUsers(allUsers);
                            updateNavigationUnreadIndicator();
                            
                            console.log(`Loaded ${allUsers.length} users from cache (${Math.round(cacheAge/1000)}s old)`);
                            return true; // Successfully loaded from cache
                        } else {
                            console.warn('Invalid cached users data, will fetch fresh data');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading users from cache:', error);
            }
            
            // If no cache or cache is invalid, show minimal loading state
            usersList.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mx-auto mb-2"></div>
                    <p class="text-xs">Loading...</p>
                </div>
            `;
            return false; // Need to fetch from server
        }

        // NEW: Background sync without UI interruption
        async function syncUsersInBackground() {
            const now = Date.now();
            
            // Throttle background syncs (max once per 5 minutes)
            if (now - lastUsersSync < USERS_SYNC_INTERVAL) {
                return;
            }
            
            lastUsersSync = now;
            
            try {
                // First try incremental sync (only new/changed users)
                const lastSync = getLastSyncTimestamp();
                const incrementalSuccess = await fetchIncrementalUserUpdates(lastSync);
                
                if (!incrementalSuccess) {
                    // Fallback to full sync if incremental fails
                    await fetchAllUsersWithBatchData(true); // Silent mode
                }
                
                // Update unread counts separately (lightweight)
                await fetchUnreadCounts();
                
            } catch (error) {
                console.error('Background users sync failed:', error);
            }
        }

        // NEW: Fetch only new/changed users since last sync
        async function fetchIncrementalUserUpdates(lastSyncTime) {
            try {
                const formData = new FormData();
                formData.append('action', 'getUsersIncremental');
                formData.append('currentUser', currentUser?.username || '');
                formData.append('lastSync', lastSyncTime.toString());
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.hasUpdates) {
                    // Merge incremental updates with existing users
                    updateUsersFromIncremental(result.users, result.deletedUsers);
                    
                    // Update cache
                    saveUsersToCache();
                    
                    // Update UI silently
                    displayUsers(allUsers);
                    updateNavigationUnreadIndicator();
                    
                    console.log(`Incremental sync: ${result.users?.length || 0} updates, ${result.deletedUsers?.length || 0} deletions`);
                    return true;
                    
                } else if (result.success && !result.hasUpdates) {
                    // No updates needed
                    updateLastSyncTimestamp();
                    return true;
                }
                
                return false; // Need full sync
                
            } catch (error) {
                console.error('Incremental user sync failed:', error);
                return false;
            }
        }

        // NEW: Update existing users list with incremental data
        function updateUsersFromIncremental(updatedUsers, deletedUsers) {
            if (!updatedUsers && !deletedUsers) return;
            
            // Remove deleted users
            if (deletedUsers && deletedUsers.length > 0) {
                allUsers = allUsers.filter(user => !deletedUsers.includes(user.username));
            }
            
            // Update or add new users
            if (updatedUsers && updatedUsers.length > 0) {
                updatedUsers.forEach(updatedUser => {
                    if (updatedUser.username === currentUser?.username) return; // Skip current user
                    
                    const existingIndex = allUsers.findIndex(user => user.username === updatedUser.username);
                    if (existingIndex >= 0) {
                        // Update existing user
                        allUsers[existingIndex] = updatedUser;
                    } else {
                        // Add new user
                        allUsers.push(updatedUser);
                    }
                });
            }
            
            updateLastSyncTimestamp();
        }

        // NEW: Enhanced caching functions
        function saveUsersToCache() {
            try {
                const cacheData = {
                    users: allUsers,
                    unreadCounts: unreadCounts,
                    timestamp: Date.now(),
                    lastSync: Date.now()
                };
                localStorage.setItem(USERS_CACHE_KEY, JSON.stringify(cacheData));
            } catch (error) {
                console.error('Error saving users to cache:', error);
            }
        }

        function getLastSyncTimestamp() {
            try {
                const cachedData = localStorage.getItem(USERS_CACHE_KEY);
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    return parsedCache.lastSync || 0;
                }
            } catch (error) {
                console.error('Error reading last sync timestamp:', error);
            }
            return 0;
        }

        function updateLastSyncTimestamp() {
            try {
                const cachedData = localStorage.getItem(USERS_CACHE_KEY);
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    parsedCache.lastSync = Date.now();
                    localStorage.setItem(USERS_CACHE_KEY, JSON.stringify(parsedCache));
                }
            } catch (error) {
                console.error('Error updating sync timestamp:', error);
            }
        }

        // NEW: Start periodic background sync
        function startUsersSync() {
            stopUsersSync();
            
            // Sync every 5 minutes when page is active
            usersSyncInterval = setInterval(() => {
                if (!document.hidden && currentUser) {
                    syncUsersInBackground();
                }
            }, USERS_SYNC_INTERVAL);
        }

        function stopUsersSync() {
            if (usersSyncInterval) {
                clearInterval(usersSyncInterval);
                usersSyncInterval = null;
            }
        }

        // Enhanced Messages Cache System
        function getMessagesCacheKey(user1, user2) {
            // Create consistent cache key regardless of order
            const users = [user1, user2].sort();
            return `${MESSAGES_CACHE_KEY_PREFIX}${users[0]}_${users[1]}`;
        }

        function loadMessagesFromCache(conversationKey) {
            try {
                const cacheKey = getMessagesCacheKey(currentUser.username, selectedUser.username);
                const cachedData = localStorage.getItem(cacheKey);
                
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    const cacheAge = Date.now() - parsedCache.timestamp;
                    
                    // Use cache if it's not too old (7 days)
                    if (cacheAge < MESSAGES_CACHE_EXPIRY && parsedCache.messages) {
                        messages = parsedCache.messages;
                        
                        // Update in-memory cache
                        messagesCache.set(conversationKey, {
                            messages: messages,
                            timestamp: parsedCache.timestamp
                        });
                        
                        // Display messages instantly
                        displayMessages();
                        
                        console.log(`Loaded ${messages.length} messages from cache (${Math.round(cacheAge/1000)}s old)`);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading messages from cache:', error);
            }
            return false;
        }

        function saveMessagesToCache(conversationKey, messagesData) {
            try {
                const cacheKey = getMessagesCacheKey(currentUser.username, selectedUser.username);
                const cacheData = {
                    messages: messagesData,
                    timestamp: Date.now(),
                    lastMessageId: messagesData.length > 0 ? messagesData[messagesData.length - 1].id : null
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                
                // Also update in-memory cache
                messagesCache.set(conversationKey, {
                    messages: messagesData,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('Error saving messages to cache:', error);
            }
        }

        async function fetchIncrementalMessages(conversationKey) {
            try {
                const cacheKey = getMessagesCacheKey(currentUser.username, selectedUser.username);
                const cachedData = localStorage.getItem(cacheKey);
                let lastMessageId = null;
                
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    lastMessageId = parsedCache.lastMessageId;
                }
                
                const formData = new FormData();
                formData.append('action', 'getMessagesIncremental');
                formData.append('user1', currentUser.username);
                formData.append('user2', selectedUser.username);
                formData.append('lastMessageId', lastMessageId || '');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.hasNewMessages) {
                    // Merge new messages with existing ones
                    const existingMessages = messages || [];
                    const newMessages = result.messages || [];
                    
                    // Remove duplicates and merge
                    const allMessages = [...existingMessages];
                    newMessages.forEach(newMsg => {
                        if (!allMessages.find(msg => msg.id === newMsg.id)) {
                            allMessages.push(newMsg);
                        }
                    });
                    
                    // Sort by timestamp
                    allMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    messages = allMessages;
                    
                    // Update cache
                    saveMessagesToCache(conversationKey, messages);
                    
                    // Update UI if this user is still selected
                    if (selectedUser && `${currentUser.username}-${selectedUser.username}` === conversationKey) {
                        displayMessages();
                        
                        // Mark messages as read
                        await markMessagesAsRead(selectedUser.username);
                    }
                    
                    console.log(`Incremental sync: ${newMessages.length} new messages`);
                    return true;
                    
                } else if (result.success && !result.hasNewMessages) {
                    // No new messages
                    return true;
                }
                
                return false; // Fallback to full load
                
            } catch (error) {
                console.error('Incremental message sync failed:', error);
                return false;
            }
        }

        async function syncMessagesInBackground(conversationKey) {
            const now = Date.now();
            
            // Throttle message sync (max once per 3 seconds per conversation)
            if (now - lastMessageSync < MESSAGES_SYNC_INTERVAL) {
                return;
            }
            
            lastMessageSync = now;
            
            try {
                // Try incremental sync first
                const incrementalSuccess = await fetchIncrementalMessages(conversationKey);
                
                if (!incrementalSuccess) {
                    // Fallback to full message load
                    await loadMessagesFullSync(conversationKey);
                }
                
            } catch (error) {
                console.error('Background message sync failed:', error);
            }
        }

        async function loadMessagesFullSync(conversationKey) {
            try {
                const formData = new FormData();
                formData.append('action', 'getMessages');
                formData.append('user1', currentUser.username);
                formData.append('user2', selectedUser.username);
                formData.append('limit', '50');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.messages) {
                    // Only update if this user is still selected
                    if (selectedUser && `${currentUser.username}-${selectedUser.username}` === conversationKey) {
                        messages = result.messages;
                        
                        // Update cache
                        saveMessagesToCache(conversationKey, messages);
                        
                        // Display messages
                        displayMessages();
                        
                        // Mark as read
                        await markMessagesAsRead(selectedUser.username);
                        
                        // End performance tracking
                        endMessageLoadTracking(messages.length);
                    }
                } else {
                    console.error('Failed to load messages:', result.error);
                    showMessageLoadError();
                }
                
            } catch (error) {
                console.error('Error in full message sync:', error);
                showMessageLoadError();
            }
        }

        function showMessageLoadError() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <p class="text-red-500 text-sm">Failed to load messages</p>
                            <button onclick="loadMessages()" class="text-blue-600 text-sm mt-2 hover:underline">Try again</button>
                        </div>
                    </div>
                `;
            }
        }

        function clearMessagesCache(user1, user2) {
            try {
                const cacheKey = getMessagesCacheKey(user1, user2);
                localStorage.removeItem(cacheKey);
                console.log('Messages cache cleared for conversation');
            } catch (error) {
                console.error('Error clearing messages cache:', error);
            }
        }

        function getMessagesCacheInfo(user1, user2) {
            try {
                const cacheKey = getMessagesCacheKey(user1, user2);
                const cachedData = localStorage.getItem(cacheKey);
                
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    const cacheAge = Date.now() - parsedCache.timestamp;
                    
                    return {
                        exists: true,
                        messageCount: parsedCache.messages?.length || 0,
                        cacheAge: Math.round(cacheAge / 1000), // seconds
                        timestamp: new Date(parsedCache.timestamp).toLocaleString(),
                        lastMessageId: parsedCache.lastMessageId
                    };
                }
                return { exists: false };
            } catch (error) {
                console.error('Error reading messages cache info:', error);
                return { exists: false, error: error.message };
            }
        }

        // Debug functions for message cache (for development)
        function debugMessageCache(user1, user2) {
            const info = getMessagesCacheInfo(user1, user2);
            console.log(`Message Cache Status for ${user1} <-> ${user2}:`, info);
            return info;
        }

        function clearAllMessagesCache() {
            try {
                const keys = Object.keys(localStorage);
                const messageKeys = keys.filter(key => key.startsWith(MESSAGES_CACHE_KEY_PREFIX));
                
                messageKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                console.log(`Cleared ${messageKeys.length} message cache entries`);
                
                // Also clear in-memory cache
                messagesCache.clear();
                
            } catch (error) {
                console.error('Error clearing all message caches:', error);
            }
        }

        function getStorageStats() {
            try {
                const stats = {
                    totalKeys: Object.keys(localStorage).length,
                    usersCache: localStorage.getItem(USERS_CACHE_KEY) ? 'exists' : 'none',
                    messageCaches: 0,
                    usageLogsCache: localStorage.getItem(USAGE_LOGS_CACHE_KEY) ? 'exists' : 'none',
                    totalSize: 0
                };
                
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(MESSAGES_CACHE_KEY_PREFIX)) {
                        stats.messageCaches++;
                    }
                    stats.totalSize += (localStorage.getItem(key) || '').length;
                });
                
                stats.totalSizeMB = (stats.totalSize / (1024 * 1024)).toFixed(2);
                
                console.log('Storage Statistics:', stats);
                return stats;
            } catch (error) {
                console.error('Error getting storage stats:', error);
                return { error: error.message };
            }
        }

        // Enhanced Usage Logs Cache System
        function loadUsageLogsFromCache() {
            try {
                const cachedData = localStorage.getItem(USAGE_LOGS_CACHE_KEY);
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    const cacheAge = Date.now() - parsedCache.timestamp;
                    
                    // Use cache if it's not too old (6 hours)
                    if (cacheAge < USAGE_LOGS_CACHE_EXPIRY && parsedCache.usageLogs) {
                        usageLogs = parsedCache.usageLogs;
                        loadUsageLog();
                        
                        console.log(`Loaded ${usageLogs.length} usage logs from cache (${Math.round(cacheAge/1000)}s old)`);
                        return true; // Successfully loaded from cache
                    }
                }
            } catch (error) {
                console.error('Error loading usage logs from cache:', error);
            }
            return false; // Need to fetch from server
        }

        function saveUsageLogsToCache() {
            try {
                const cacheData = {
                    usageLogs: usageLogs,
                    timestamp: Date.now(),
                    lastSync: Date.now()
                };
                localStorage.setItem(USAGE_LOGS_CACHE_KEY, JSON.stringify(cacheData));
                console.log(`Saved ${usageLogs.length} usage logs to cache`);
            } catch (error) {
                console.error('Error saving usage logs to cache:', error);
            }
        }

        async function syncUsageLogsInBackground() {
            const now = Date.now();
            
            // Throttle background syncs (max once per 30 seconds)
            if (now - lastUsageLogsSync < USAGE_LOGS_SYNC_INTERVAL) {
                return;
            }
            
            lastUsageLogsSync = now;
            
            try {
                await fetchUsageLogs(false); // Silent fetch
                saveUsageLogsToCache();
                loadUsageLog(); // Refresh display
            } catch (error) {
                console.error('Background usage logs sync failed:', error);
            }
        }

        function startUsageLogsSync() {
            stopUsageLogsSync();
            
            // Sync every 30 seconds when page is active
            usageLogsSyncInterval = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    syncUsageLogsInBackground();
                }
            }, USAGE_LOGS_SYNC_INTERVAL);
        }

        function stopUsageLogsSync() {
            if (usageLogsSyncInterval) {
                clearInterval(usageLogsSyncInterval);
                usageLogsSyncInterval = null;
            }
        }

        function clearUsageLogsCache() {
            try {
                localStorage.removeItem(USAGE_LOGS_CACHE_KEY);
                console.log('Cleared usage logs cache');
            } catch (error) {
                console.error('Error clearing usage logs cache:', error);
            }
        }

        async function preloadTopConversations() {
            if (!allUsers.length || !currentUser) return;
            
            // Preload messages for top 5 users (or users with unread messages)
            const usersToPreload = allUsers
                .filter(user => unreadCounts[user.username] > 0)
                .slice(0, 3)
                .concat(allUsers.slice(0, 5))
                .slice(0, 5); // Max 5 preloads
                
            usersToPreload.forEach(user => {
                const conversationKey = `${currentUser.username}-${user.username}`;
                if (!messagesCache.has(conversationKey)) {
                    // Preload in background without UI updates
                    setTimeout(() => preloadUserMessages(user), Math.random() * 2000);
                }
            });
        }

        async function preloadUserMessages(user) {
            if (!currentUser) return;
            
            const conversationKey = `${currentUser.username}-${user.username}`;
            if (backgroundLoadingQueue.has(conversationKey)) return;
            
            backgroundLoadingQueue.add(conversationKey);
            
            try {
                const formData = new FormData();
                formData.append('action', 'getMessages');
                formData.append('user1', currentUser.username);
                formData.append('user2', user.username);
                formData.append('limit', '50');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.messages) {
                    // Cache the messages with long expiry for preloaded data
                    messagesCache.set(conversationKey, {
                        messages: result.messages,
                        timestamp: Date.now()
                    });
                }
            } catch (error) {
                console.error('Error preloading messages for', user.fullName, ':', error);
            } finally {
                backgroundLoadingQueue.delete(conversationKey);
            }
        }

        async function fetchAllUsersWithBatchData(silentMode = false) {
            try {
                // Use cached data if available and recent (30 seconds) - for manual refreshes
                if (!silentMode && usersCache && (Date.now() - usersCache.timestamp) < 30000) {
                    allUsers = usersCache.users;
                    unreadCounts = usersCache.unreadCounts;
                    displayUsers(allUsers);
                    updateNavigationUnreadIndicator();
                    return;
                }

                const formData = new FormData();
                formData.append('action', 'getUsersWithMessages'); // New batch endpoint
                formData.append('currentUser', currentUser?.username || '');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success) {
                    // Filter out current user from users list - with defensive checks
                    const newUsers = (result.users || []).filter(user => 
                        user && user.username && user.username !== currentUser?.username
                    );
                    
                    // Only update allUsers if we got valid data
                    if (newUsers.length > 0 || result.users?.length === 0) {
                        // Ensure selected user is preserved if they're missing from new data
                        if (selectedUser && newUsers.length > 0) {
                            const selectedUserExists = newUsers.find(u => u.username === selectedUser.username);
                            if (!selectedUserExists && backupUsers.length > 0) {
                                const selectedFromBackup = backupUsers.find(u => u.username === selectedUser.username);
                                if (selectedFromBackup) {
                                    console.log('Preserving selected user from backup:', selectedUser.username);
                                    newUsers.push(selectedFromBackup);
                                }
                            }
                        }
                        allUsers = newUsers;
                    } else {
                        console.warn('Received invalid users data, keeping existing users');
                    }
                    
                    // Get unread counts from batch response
                    unreadCounts = result.unreadCounts || {};
                    
                    // Cache the data
                    usersCache = {
                        users: allUsers,
                        unreadCounts: unreadCounts,
                        timestamp: Date.now()
                    };
                    
                    // Update persistent cache
                    saveUsersToCache();
                    
                    if (!silentMode) {
                        displayUsers(allUsers);
                        updateNavigationUnreadIndicator();
                    }
                    
                    // Preload conversations after successful full sync
                    if (!silentMode) {
                        preloadTopConversations();
                    }
                    
                } else {
                    // Fallback to individual API calls if batch endpoint not available
                    await fetchAllUsersLegacy(silentMode);
                }
            } catch (error) {
                console.error('Error fetching users with batch data:', error);
                // Fallback to individual API calls
                await fetchAllUsersLegacy(silentMode);
            }
        }

        // Legacy fallback for individual API calls
        async function fetchAllUsersLegacy(silentMode = false) {
            try {
                const formData = new FormData();
                formData.append('action', 'getAllUsers');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.users) {
                    // Filter out current user with defensive checks
                    const newUsers = result.users.filter(user => 
                        user && user.username && user.username !== currentUser?.username
                    );
                    
                    // Only update if we got valid data
                    if (newUsers.length > 0 || result.users.length === 0) {
                        // Ensure selected user is preserved if they're missing from new data
                        if (selectedUser && newUsers.length > 0) {
                            const selectedUserExists = newUsers.find(u => u.username === selectedUser.username);
                            if (!selectedUserExists && backupUsers.length > 0) {
                                const selectedFromBackup = backupUsers.find(u => u.username === selectedUser.username);
                                if (selectedFromBackup) {
                                    console.log('Preserving selected user from backup (legacy):', selectedUser.username);
                                    newUsers.push(selectedFromBackup);
                                }
                            }
                        }
                        allUsers = newUsers;
                    } else {
                        console.warn('Received invalid users data in legacy mode, keeping existing users');
                    }
                    
                    // Only fetch unread counts if we have users
                    if (allUsers.length > 0) {
                        await fetchUnreadCounts();
                    }
                    
                    // Update persistent cache
                    saveUsersToCache();
                    
                    if (!silentMode) {
                        displayUsers(allUsers);
                    }
                } else {
                    allUsers = [];
                    if (!silentMode) {
                        displayUsers(allUsers);
                    }
                }
            } catch (error) {
                console.error('Error fetching users (legacy):', error);
                allUsers = [];
                if (!silentMode) {
                    displayUsers(allUsers);
                }
            }
        }

        async function fetchUnreadCounts() {
            if (!currentUser) {
                console.log('fetchUnreadCounts: No current user');
                return;
            }
            
            console.log('Fetching unread counts for user:', currentUser.username);
            
            try {
                const formData = new FormData();
                formData.append('action', 'getUnreadCounts');
                formData.append('currentUser', currentUser.username);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                console.log('Unread counts API response:', result);
                
                if (result.success) {
                    const previousUnreadCounts = { ...unreadCounts };
                    unreadCounts = result.unreadCounts || {};
                    console.log('Updated unreadCounts:', unreadCounts);
                    updateNavigationUnreadIndicator();
                    
                    // NEW: Check for new messages in active conversation for INSTANT message display
                    if (selectedUser) {
                        const prevCount = previousUnreadCounts[selectedUser.username] || 0;
                        const newCount = unreadCounts[selectedUser.username] || 0;
                        
                        if (newCount > prevCount) {
                            console.log('🚀 NEW MESSAGE detected in active conversation! Refreshing immediately...');
                            // INSTANT refresh for new messages
                            loadMessagesInBackground();
                        }
                    }
                    
                    // Check if there are new conversations (new users with unread messages)
                    const newConversations = Object.keys(unreadCounts).filter(username => 
                        unreadCounts[username] > 0 && (!previousUnreadCounts[username] || previousUnreadCounts[username] === 0)
                    );
                    
                    // If there are new conversations, refresh user list immediately
                    if (newConversations.length > 0) {
                        console.log('🚀 NEW CONVERSATIONS detected:', newConversations);
                        const messagesSection = document.getElementById('messages-section');
                        if (messagesSection && !messagesSection.classList.contains('hidden')) {
                            console.log('In messages section - INSTANT user list refresh for new conversations');
                            
                            // INSTANT refresh with immediate display
                            try {
                                await fetchAllUsersWithBatchData(false); // Not silent - show changes immediately
                                console.log('✅ User list refreshed successfully');
                                displayUsers(allUsers);
                                
                                // Save updated users to cache immediately
                                saveUsersToCache();
                                
                                // Also refresh unread counts again to ensure consistency
                                setTimeout(() => {
                                    fetchUnreadCounts().then(() => {
                                        displayUsers(allUsers);
                                    });
                                }, 100);
                            } catch (error) {
                                console.log('Batch fetch failed, trying legacy method');
                                try {
                                    await fetchAllUsersLegacy(false);
                                    displayUsers(allUsers);
                                    saveUsersToCache();
                                } catch (legacyError) {
                                    console.error('Both batch and legacy user fetch failed:', legacyError);
                                }
                            }
                        }
                    } else {
                        // Only refresh users display if we have valid users and are in messages section
                        // BUT avoid refreshing if user is actively messaging to prevent disappearing users
                        const messagesSection = document.getElementById('messages-section');
                        const isInMessagesSection = messagesSection && !messagesSection.classList.contains('hidden');
                        const hasValidUsers = allUsers && allUsers.length > 0;
                        const isActivelyMessaging = selectedUser && isLoadingMessages;
                        
                        if (isInMessagesSection && hasValidUsers && !isActivelyMessaging) {
                            console.log('Safe to refresh user display with unread counts');
                            displayUsers(allUsers);
                        } else if (isActivelyMessaging) {
                            console.log('User is actively messaging, skipping display refresh to prevent flickering');
                        }
                    }
                } else {
                    console.log('Failed to fetch unread counts:', result.error);
                }
            } catch (error) {
                console.error('Error fetching unread counts:', error);
                unreadCounts = {};
                updateNavigationUnreadIndicator();
            }
        }

        function updateNavigationUnreadIndicator() {
            const indicator = document.getElementById('navUnreadIndicator');
            if (!indicator) return;
            
            // Check if there are any unread messages
            const totalUnread = Object.values(unreadCounts).reduce((sum, count) => sum + count, 0);
            
            if (totalUnread > 0) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Enhanced Real-time data refresh with intelligent polling
        let isRefreshing = false;
        let lastRefreshTime = 0;
        let refreshQueue = new Set();
        
        async function refreshAllData() {
            // Prevent multiple simultaneous refreshes
            if (isRefreshing) return;
            isRefreshing = true;
            
            // Show real-time indicator
            const statusIndicator = document.getElementById('realTimeStatus');
            if (statusIndicator) {
                statusIndicator.style.opacity = '1';
            }
            
            try {
                const refreshPromises = [];
                
                // Smart refresh based on current section and user activity
                const activeSection = document.querySelector('.section:not(.hidden)');
                const sectionId = activeSection ? activeSection.id : '';
                
                // Always refresh core data (lightweight)
                refreshPromises.push(fetchReservations(false));
                refreshPromises.push(fetchVenues(false));
                refreshPromises.push(fetchDepartments(false));
                
                // Conditional refreshes based on active section
                if (sectionId.includes('usage-log') || sectionId.includes('dashboard')) {
                    refreshPromises.push(fetchUsageLogs(false));
                }
                
                if (sectionId.includes('manage-users')) {
                    // For background refresh, don't show loading overlay
                    refreshPromises.push(refreshUsersListSilent());
                }
                
                // Execute all refresh operations in parallel
                await Promise.all(refreshPromises);
                
                // Update UI based on current section
                await updateActiveSection(sectionId);
                
                lastRefreshTime = Date.now();
                console.log('Real-time data refresh completed successfully');
                
            } catch (error) {
                console.error('Error in real-time refresh:', error);
            } finally {
                isRefreshing = false;
                
                // Hide real-time indicator after 1 second
                if (statusIndicator) {
                    setTimeout(() => {
                        statusIndicator.style.opacity = '0';
                    }, 1000);
                }
            }
        }
        
        // Update UI based on active section
        async function updateActiveSection(sectionId) {
            switch (sectionId) {
                case 'dashboard-section':
                    generateCalendar();
                    break;
                case 'reservations-section':
                    loadAllReservations();
                    break;
                case 'venues-section':
                    loadVenuesGrid();
                    break;
                case 'usage-log-section':
                    loadUsageLog();
                    break;
                case 'messages-section':
                    if (selectedUser) {
                        await loadMessages();
                    }
                    break;
                // manage-users section refreshes itself
            }
        }
        
        // Enhanced real-time polling with adaptive intervals
        function startRealTimePolling() {
            // Stop existing intervals
            stopRealTimePolling();
            
            // Track page visibility for smart polling
            let isPageVisible = !document.hidden;
            let baseInterval = 5000; // 5 seconds for active tabs
            let inactiveInterval = 30000; // 30 seconds for inactive tabs
            
            // Fast polling for critical updates (adaptive based on visibility)
            dataRefreshInterval = setInterval(() => {
                const timeSinceLastRefresh = Date.now() - lastRefreshTime;
                
                // Skip if recently refreshed (prevent spam)
                if (timeSinceLastRefresh < 3000) return;
                
                refreshAllData();
            }, isPageVisible ? baseInterval : inactiveInterval);
            
            // Faster polling for unread counts (every 2 seconds when active)
            // But reduce frequency when actively messaging to prevent user list conflicts
            // Make it more aggressive when in messages section to detect new conversations faster
            const messagesSection = document.getElementById('messages-section');
            const isInMessagesSection = messagesSection && !messagesSection.classList.contains('hidden');
            let unreadCountsInterval;
            
            if (isInMessagesSection) {
                // ULTRA-AGGRESSIVE polling in messages section for instant message detection
                unreadCountsInterval = 200; // 200ms when in messages section for near-instant updates
            } else if (selectedUser) {
                unreadCountsInterval = 500; // 500ms when actively messaging
            } else {
                unreadCountsInterval = isPageVisible ? 2000 : 10000; // 2 seconds when active, 10 when inactive
            }
            
            unreadCountsPollingInterval = setInterval(fetchUnreadCounts, unreadCountsInterval);
            
            // Note: Message polling is handled per-user in selectUser() function
            
            // Listen for visibility changes to adjust polling
            document.addEventListener('visibilitychange', () => {
                isPageVisible = !document.hidden;
                
                if (isPageVisible) {
                    console.log('Page became visible - checking for new messages');
                    // Check if we're in messages section and do immediate refresh
                    const messagesSection = document.getElementById('messages-section');
                    const isInMessagesSection = messagesSection && !messagesSection.classList.contains('hidden');
                    
                    if (isInMessagesSection) {
                        // Force immediate refresh when page becomes visible in messages section
                        fetchAllUsersWithBatchData(true).then(() => {
                            return fetchUnreadCounts();
                        }).then(() => {
                            displayUsers(allUsers);
                            updateNavigationUnreadIndicator();
                        }).catch(error => {
                            console.error('Error refreshing on visibility change:', error);
                        });
                    } else {
                        triggerInstantRefresh('all');
                    }
                } else {
                    // Page hidden - reduce polling frequency
                    console.log('Page hidden - reducing poll frequency');
                }
                
                // Restart polling with new intervals
                startRealTimePolling();
            });
            
            // Store polling intervals for cleanup
            window.pollingIntervals = {
                dataRefresh: dataRefreshInterval,
                unreadCounts: unreadCountsPollingInterval,
                messages: messagePollingInterval // Fixed: use messagePollingInterval instead of messagePolling
            };
        }
        
        function stopRealTimePolling() {
            if (window.pollingIntervals) {
                Object.values(window.pollingIntervals).forEach(interval => {
                    if (interval) clearInterval(interval);
                });
                window.pollingIntervals = null;
            }
            
            // Stop background sync systems
            stopUsageLogsSync();
            stopUsersSync();
            
            // Legacy cleanup
            if (dataRefreshInterval) {
                clearInterval(dataRefreshInterval);
                dataRefreshInterval = null;
            }
            if (unreadCountsPollingInterval) {
                clearInterval(unreadCountsPollingInterval);
                unreadCountsPollingInterval = null;
            }
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
        }
        
        // Instant refresh triggers for immediate updates
        async function triggerInstantRefresh(dataType) {
            if (refreshQueue.has(dataType)) return;
            
            refreshQueue.add(dataType);
            
            try {
                switch (dataType) {
                    case 'reservations':
                        await fetchReservations(false);
                        if (!document.getElementById('reservations-section').classList.contains('hidden')) {
                            loadAllReservations();
                        }
                        if (!document.getElementById('dashboard-section').classList.contains('hidden')) {
                            generateCalendar();
                        }
                        break;
                        
                    case 'venues':
                        await fetchVenues(false);
                        if (!document.getElementById('venues-section').classList.contains('hidden')) {
                            loadVenuesGrid();
                        }
                        populateVenueFilter();
                        break;
                        
                    case 'usage-logs':
                        await fetchUsageLogs(false);
                        if (!document.getElementById('usage-log-section').classList.contains('hidden')) {
                            loadUsageLog();
                        }
                        break;
                        
                    case 'users':
                        if (!document.getElementById('manage-users-section').classList.contains('hidden')) {
                            await refreshUsersListSilent();
                        }
                        break;
                }
                
                // Show brief success indicator
                const statusIndicator = document.getElementById('realTimeStatus');
                if (statusIndicator) {
                    statusIndicator.style.opacity = '1';
                    setTimeout(() => {
                        statusIndicator.style.opacity = '0';
                    }, 800);
                }
                
            } catch (error) {
                console.error(`Error refreshing ${dataType}:`, error);
            } finally {
                refreshQueue.delete(dataType);
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (!usersList) {
                console.error('Users list container not found');
                return;
            }
            
            // Defensive check: Don't render if users data is invalid
            if (!users || !Array.isArray(users)) {
                console.warn('displayUsers called with invalid users data:', users);
                // Try to restore from backup if available
                if (backupUsers && backupUsers.length > 0) {
                    console.log('Restoring users from backup:', backupUsers.length);
                    users = backupUsers;
                } else {
                    console.error('No backup users available');
                    return;
                }
            }
            
            // Create backup of valid users for emergency restore
            if (users && users.length > 0) {
                backupUsers = [...users];
            }
            
            console.log('Displaying users:', users.length, 'Current unread counts:', unreadCounts);
            
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No users found</p>
                    </div>
                `;
                return;
            }
            
            users.forEach(user => {
                const initials = user.fullName.split(' ').map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase();
                const unreadCount = unreadCounts[user.username] || 0;
                console.log(`User: ${user.fullName} (${user.username}) - Unread: ${unreadCount}`);
                
                const userItem = document.createElement('div');
                userItem.className = `p-4 hover:bg-gray-50 cursor-pointer border-l-4 border-transparent hover:border-blue-500 transition-all ${
                    selectedUser?.username === user.username ? 'bg-blue-50 border-blue-500' : ''
                }`;
                userItem.onclick = () => {
                    try {
                        // Super fast visual feedback - no delays
                        userItem.style.transform = 'scale(0.98)';
                        userItem.style.opacity = '0.8';
                        
                        // Reset immediately
                        requestAnimationFrame(() => {
                            userItem.style.transform = 'scale(1)';
                            userItem.style.opacity = '1';
                        });
                        
                        console.log('Clicking user:', user.fullName); // Debug log
                        selectUser(user);
                    } catch (error) {
                        console.error('Error selecting user:', error);
                        alert('Error selecting user. Please try again.');
                    }
                };
                
                userItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                            ${user.profilePicture ? 
                                `<img src="${user.profilePicture}" alt="Profile" class="w-full h-full object-cover">` : 
                                `<span class="text-white font-semibold text-sm">${initials}</span>`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-900 truncate">${user.fullName}</h4>
                            <p class="text-sm text-gray-500">${user.userType === 'admin' ? 'Administrator' : 'User'}</p>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full min-w-[20px] text-center">${unreadCount}</span>` : ''}
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userItem);
            });
            
            // Final safety check: If selected user is not in the displayed list, add them
            if (selectedUser && !users.find(u => u.username === selectedUser.username)) {
                console.warn('Selected user missing from display, adding back:', selectedUser.username);
                const selectedUserItem = document.createElement('div');
                selectedUserItem.className = 'p-4 hover:bg-gray-50 cursor-pointer border-l-4 bg-blue-50 border-blue-500 transition-all';
                selectedUserItem.onclick = () => selectUser(selectedUser);
                
                const initials = selectedUser.fullName.split(' ').map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase();
                const unreadCount = unreadCounts[selectedUser.username] || 0;
                
                selectedUserItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                            ${selectedUser.profilePicture ? 
                                `<img src="${selectedUser.profilePicture}" alt="Profile" class="w-full h-full object-cover">` : 
                                `<span class="text-white font-semibold text-sm">${initials}</span>`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-900 truncate">${selectedUser.fullName}</h4>
                            <p class="text-sm text-gray-500">${selectedUser.userType === 'admin' ? 'Administrator' : 'User'}</p>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full min-w-[20px] text-center">${unreadCount}</span>` : ''}
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        </div>
                    </div>
                `;
                
                usersList.insertBefore(selectedUserItem, usersList.firstChild);
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.fullName.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        }

        // Status indicator functions for real-time feedback
        function showMessageStatus(status, text, showLoading = false) {
            const statusContainer = document.getElementById('messagingStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            if (statusContainer && indicator && statusText) {
                statusContainer.classList.remove('hidden');
                
                // Update indicator color
                indicator.className = `inline-block w-2 h-2 rounded-full mr-2 ${
                    status === 'connected' ? 'bg-green-500' :
                    status === 'loading' ? 'bg-yellow-500' :
                    status === 'error' ? 'bg-red-500' :
                    'bg-gray-500'
                }`;
                
                statusText.textContent = text;
                
                if (showLoading && loadingIndicator) {
                    loadingIndicator.classList.remove('hidden');
                } else if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }
            }
        }
        
        function hideMessageStatus() {
            const statusContainer = document.getElementById('messagingStatus');
            if (statusContainer) {
                statusContainer.classList.add('hidden');
            }
        }

        // Message performance tracking
        let messageLoadStartTime = 0;
        
        function startMessageLoadTracking() {
            messageLoadStartTime = performance.now();
            showMessageStatus('loading', 'Loading messages...', true);
        }
        
        function endMessageLoadTracking(messageCount = 0) {
            if (messageLoadStartTime > 0) {
                const loadTime = Math.round(performance.now() - messageLoadStartTime);
                showMessageStatus('connected', `Loaded ${messageCount} messages (${loadTime}ms)`, false);
                
                // Hide status after a brief moment
                setTimeout(() => {
                    hideMessageStatus();
                }, 1500);
                
                messageLoadStartTime = 0;
            }
        }

        function selectUser(user) {
            console.log('Selecting user:', user);
            
            // Clear any existing polling immediately
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
            
            // Clear previous highlights when switching conversations
            newMessageHighlights.clear();
            lastKnownMessageIds.clear();
            
            selectedUser = user;
            
            // Update UI instantly
            const noUserSelected = document.getElementById('noUserSelected');
            const chatHeader = document.getElementById('chatHeader');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            if (noUserSelected) noUserSelected.classList.add('hidden');
            if (chatHeader) chatHeader.classList.remove('hidden');
            if (messageInputContainer) messageInputContainer.classList.remove('hidden');
            
            // Update chat header
            const initials = user.fullName.split(' ').map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase();
            const chatUserProfileImage = document.getElementById('chatUserProfileImage');
            const chatUserInitials = document.getElementById('chatUserInitials');
            const chatUserName = document.getElementById('chatUserName');
            const chatUserRole = document.getElementById('chatUserRole');
            
            if (user.profilePicture && chatUserProfileImage && chatUserInitials) {
                chatUserProfileImage.src = user.profilePicture;
                chatUserProfileImage.classList.remove('hidden');
                chatUserInitials.classList.add('hidden');
            } else if (chatUserProfileImage && chatUserInitials) {
                chatUserProfileImage.classList.add('hidden');
                chatUserInitials.classList.remove('hidden');
                chatUserInitials.textContent = initials;
            }
            
            if (chatUserName) chatUserName.textContent = user.fullName;
            if (chatUserRole) chatUserRole.textContent = user.userType === 'admin' ? 'Administrator' : 'User';
            
            // Update users list selection
            displayUsers(allUsers);
            
            // SIMPLIFIED: Direct message loading - no complex caching
            loadMessagesSimple(user);
            
            // Start simple polling for real-time messaging
            messagePollingInterval = setInterval(() => {
                if (selectedUser && selectedUser.username === user.username && !isLoadingMessages) {
                    loadMessagesInBackground();
                }
            }, 2000); // Simple 2-second polling
            
            // Mark messages as read after a short delay
            setTimeout(() => {
                markMessagesAsRead();
            }, 1000);
        }
        
        function continueUserSelection(user) {
            // Validate we have a current user
            if (!currentUser) {
                console.error('No current user available for messaging');
                alert('Please log in to access messaging features');
                return;
            }
            
            // Update UI instantly - no delays with null checks
            const noUserSelected = document.getElementById('noUserSelected');
            const chatHeader = document.getElementById('chatHeader');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            if (noUserSelected) noUserSelected.classList.add('hidden');
            if (chatHeader) chatHeader.classList.remove('hidden');
            if (messageInputContainer) messageInputContainer.classList.remove('hidden');
            
            // Update chat header instantly with null checks
            const initials = user.fullName.split(' ').map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase();
            const chatUserProfileImage = document.getElementById('chatUserProfileImage');
            const chatUserInitials = document.getElementById('chatUserInitials');
            const chatUserName = document.getElementById('chatUserName');
            const chatUserRole = document.getElementById('chatUserRole');
            
            if (user.profilePicture && chatUserProfileImage && chatUserInitials) {
                chatUserProfileImage.src = user.profilePicture;
                chatUserProfileImage.classList.remove('hidden');
                chatUserInitials.classList.add('hidden');
            } else if (chatUserProfileImage && chatUserInitials) {
                chatUserProfileImage.classList.add('hidden');
                chatUserInitials.classList.remove('hidden');
                chatUserInitials.textContent = initials;
            }
            
            if (chatUserName) chatUserName.textContent = user.fullName;
            if (chatUserRole) chatUserRole.textContent = user.userType === 'admin' ? 'Administrator' : 'User';
            
            // Update users list selection instantly
            displayUsers(allUsers);
            
            // SUPER FAST MESSAGE LOADING - New optimized approach
            loadMessagesSimple(user);
            
            // Start ULTRA-FAST polling for real-time messaging
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }
            
            messagePollingInterval = setInterval(() => {
                if (selectedUser && selectedUser.username === user.username && !isLoadingMessages) {
                    loadMessagesInBackground();
                }
            }, 2000); // Simple 2-second polling
            
            // Mark messages as read in background (non-blocking and debounced)
            setTimeout(() => {
                markMessagesAsRead().then(() => {
                    // Only fetch unread counts, don't force display refresh here
                    fetchUnreadCounts().then(() => {
                        updateNavigationUnreadIndicator();
                        // Only update display if users are still valid and selected user exists
                        if (allUsers.length > 0 && selectedUser && allUsers.find(u => u.username === selectedUser.username)) {
                            displayUsers(allUsers);
                        }
                    });
                }).catch(err => console.error('Error marking messages as read:', err));
            }, 500); // Increased delay to 500ms to avoid conflicts
        }
        
        // NEW: Ultra-fast message loading with INSTANT display priority
        // SIMPLIFIED: Fast message loading without complex caching
        async function loadMessagesSimple(user) {
            if (!user || !currentUser) return;
            
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // Show simple loading state
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                        <p class="text-sm">Loading messages...</p>
                    </div>
                </div>
            `;
            
            try {
                console.log('Loading messages for:', user.username);
                
                const formData = new FormData();
                formData.append('action', 'getMessages');
                formData.append('user1', currentUser.username);
                formData.append('user2', user.username);
                formData.append('limit', '50');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.messages) {
                    messages = result.messages;
                    
                    // Initialize tracking for existing messages
                    lastKnownMessageIds.clear();
                    messages.forEach(msg => {
                        if (msg.messageId) {
                            lastKnownMessageIds.add(msg.messageId);
                        }
                    });
                    
                    displayMessages();
                    console.log('Messages loaded successfully:', messages.length);
                } else {
                    console.error('Failed to load messages:', result.error);
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <p class="text-sm">Error loading messages</p>
                                <p class="text-xs mt-1">Please try again</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <p class="text-sm">Error loading messages</p>
                            <p class="text-xs mt-1">Please check your connection</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // NEW: Get messages from localStorage
        function getMessagesFromLocalStorage(conversationKey) {
            try {
                const cacheKey = `messages_${conversationKey}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Check if cache is less than 1 hour old
                    if (Date.now() - data.timestamp < 3600000) {
                        return data;
                    }
                }
            } catch (error) {
                console.error('Error reading messages from localStorage:', error);
            }
            return null;
        }
        
        // NEW: Save messages to localStorage
        function saveMessagesToLocalStorage(conversationKey, messages) {
            try {
                const cacheKey = `messages_${conversationKey}`;
                const data = {
                    messages: messages,
                    timestamp: Date.now()
                };
                localStorage.setItem(cacheKey, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving messages to localStorage:', error);
            }
        }

        async function loadMessagesInBackground() {
            if (!selectedUser || !currentUser || isLoadingMessages) return;
            
            const conversationKey = `${currentUser.username}-${selectedUser.username}`;
            
            // Prevent concurrent loading
            isLoadingMessages = true;
            
            try {
                console.log('Background: Fetching fresh messages for', conversationKey);
                
                const formData = new FormData();
                formData.append('action', 'getMessages');
                formData.append('user1', currentUser.username);
                formData.append('user2', selectedUser.username);
                formData.append('limit', '50');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.messages) {
                    // Only update if this user is still selected
                    if (selectedUser && selectedUser.username === conversationKey.split('-')[1]) {
                        const newMessages = result.messages;
                        
                        // Track current message IDs before update
                        const currentMessageIds = new Set(messages.map(m => m.messageId));
                        
                        // Check if we recently sent a message to avoid conflicts
                        const recentlySentMessage = window.lastSentMessageTime && 
                            (Date.now() - window.lastSentMessageTime) < 2000; // Reduced to 2 seconds
                        
                        if (recentlySentMessage) {
                            console.log('⚡ Recently sent message detected - using smart merge');
                            // Only add truly new messages that aren't already in our list
                            const existingIds = new Set(messages.map(m => m.messageId));
                            const newMessagesToAdd = newMessages.filter(m => !existingIds.has(m.messageId));
                            
                            if (newMessagesToAdd.length > 0) {
                                console.log('Adding', newMessagesToAdd.length, 'new messages without overwriting sent message');
                                
                                // Mark new messages from other users for highlighting
                                newMessagesToAdd.forEach(msg => {
                                    if (msg.senderUsername !== currentUser.username) {
                                        newMessageHighlights.add(msg.messageId);
                                        console.log('🎯 Highlighting new received message:', msg.messageId);
                                    }
                                });
                                
                                messages = [...messages, ...newMessagesToAdd].sort((a, b) => 
                                    new Date(a.timestamp) - new Date(b.timestamp)
                                );
                                displayMessages();
                                
                                // Update caches
                                messagesCache.set(conversationKey, {
                                    messages: messages,
                                    timestamp: Date.now()
                                });
                                saveMessagesToLocalStorage(conversationKey, messages);
                            }
                        } else {
                            // Safe to do normal comparison and update
                            const shouldUpdate = !messages || 
                                               messages.length !== newMessages.length || 
                                               (messages.length > 0 && newMessages.length > 0 && 
                                                messages[messages.length - 1].messageId !== newMessages[newMessages.length - 1].messageId);
                            
                            if (shouldUpdate) {
                                console.log('🚀 Background: NEW MESSAGES detected, updating display!');
                                
                                // Identify truly new messages for highlighting
                                newMessages.forEach(msg => {
                                    // If this message wasn't in our previous list AND it's from someone else
                                    if (!currentMessageIds.has(msg.messageId) && msg.senderUsername !== currentUser.username) {
                                        newMessageHighlights.add(msg.messageId);
                                        console.log('🎯 Highlighting new received message:', msg.messageId);
                                    }
                                });
                                
                                messages = newMessages;
                                displayMessages();
                                
                                // Update caches
                                messagesCache.set(conversationKey, {
                                    messages: messages,
                                    timestamp: Date.now()
                                });
                                saveMessagesToLocalStorage(conversationKey, messages);
                            } else {
                                console.log('Background: Messages identical, skipping update');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading messages in background:', error);
            } finally {
                isLoadingMessages = false;
            }
        }

        // NEW: Ultra-strict message comparison to prevent any flickering
        function messagesAreIdentical(msgs1, msgs2) {
            if (!msgs1 || !msgs2) return false;
            if (msgs1.length !== msgs2.length) return false;
            
            for (let i = 0; i < msgs1.length; i++) {
                const m1 = msgs1[i];
                const m2 = msgs2[i];
                
                // Safely get message content
                const msg1Content = (m1.message || m1.content || '').toString();
                const msg2Content = (m2.message || m2.content || '').toString();
                
                if (m1.messageId !== m2.messageId ||
                    msg1Content !== msg2Content ||
                    m1.senderUsername !== m2.senderUsername ||
                    m1.readStatus !== m2.readStatus) {
                    return false;
                }
            }
            return true;
        }

        // NEW: Smart message comparison to prevent flickering
        function shouldUpdateMessages(currentMessages, newMessages) {
            // If no current messages, always update
            if (!currentMessages || currentMessages.length === 0) {
                return newMessages && newMessages.length > 0;
            }
            
            // If no new messages, don't update if we have messages
            if (!newMessages || newMessages.length === 0) {
                return false;
            }
            
            // If length is different, update
            if (currentMessages.length !== newMessages.length) {
                return true;
            }
            
            // Compare message IDs and content (more reliable than JSON.stringify)
            for (let i = 0; i < currentMessages.length; i++) {
                const current = currentMessages[i];
                const newMsg = newMessages[i];
                
                // Safely get message content
                const currentContent = (current.message || current.content || '').toString();
                const newContent = (newMsg.message || newMsg.content || '').toString();
                
                // Check critical fields that matter for display
                if (current.messageId !== newMsg.messageId ||
                    currentContent !== newContent ||
                    current.readStatus !== newMsg.readStatus ||
                    current.senderUsername !== newMsg.senderUsername) {
                    return true;
                }
            }
            
            // Messages are identical, no update needed
            return false;
        }

        // NEW: Immediate display messages (removed debouncing for speed)
        function displayMessagesImmediate() {
            displayMessages();
        }

        async function loadMessagesInstant() {
            if (!selectedUser || !currentUser) return;
            
            const conversationKey = `${currentUser.username}-${selectedUser.username}`;
            
            try {
                // Check cache first for instant display
                const cachedData = messagesCache.get(conversationKey);
                if (cachedData) {
                    messages = cachedData.messages;
                    displayMessages();
                    // Still fetch fresh data in background
                }
                
                // Always fetch fresh data
                const formData = new FormData();
                formData.append('action', 'getMessages');
                formData.append('user1', currentUser.username);
                formData.append('user2', selectedUser.username);
                formData.append('limit', '50');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.messages) {
                    messages = result.messages;
                    
                    // Update cache
                    messagesCache.set(conversationKey, {
                        messages: messages,
                        timestamp: Date.now()
                    });
                    
                    // Update display
                    displayMessages();
                    
                    // Update last fetch time
                    lastMessagesFetch = Date.now();
                }
            } catch (error) {
                console.error('Error loading messages instantly:', error);
                // Show error state in UI
                const container = document.getElementById('messagesContainer');
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <p class="text-red-500 text-sm">Failed to load messages</p>
                            <button onclick="loadMessagesInstant()" class="text-blue-600 text-sm mt-2 hover:underline">Try again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function loadMessages() {
            if (!selectedUser || !currentUser) return;
            
            const conversationKey = `${currentUser.username}-${selectedUser.username}`;
            
            // INSTANT LOAD: Try to load from persistent cache first
            const loadedFromCache = loadMessagesFromCache(conversationKey);
            
            if (!loadedFromCache) {
                // No cache available, show loading state
                startMessageLoadTracking();
                
                // Show minimal loading in messages container
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div class="flex items-center justify-center h-32">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                <p class="text-gray-500 text-sm">Loading messages...</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            // BACKGROUND SYNC: Always check for new messages
            await syncMessagesInBackground(conversationKey);
        }

        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            
            if (!container) {
                console.error('Messages container not found');
                return;
            }
            
            // Create ultra-fast signature for change detection
            const messageSignature = messages.map(m => {
                const msgText = (m.message || m.content || '').toString();
                return `${m.messageId || 'temp'}-${msgText.substring(0,20)}`;
            }).join('|');
            
            // Skip redraw if messages haven't actually changed
            if (container.dataset.lastSignature === messageSignature) {
                console.log('Display: Messages identical, skipping redraw');
                return;
            }
            
            console.log('Display: Rendering', messages.length, 'messages');
            
            // Store scroll position
            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <p class="text-sm">No messages yet</p>
                            <p class="text-xs mt-1">Start the conversation!</p>
                        </div>
                    </div>
                `;
                container.dataset.lastSignature = '';
                return;
            }
            
            // Build all HTML in one go for maximum performance
            let html = '';
            
            messages.forEach(message => {
                const isCurrentUser = message.senderUsername === currentUser.username;
                const messageText = escapeHtml((message.message || message.content || '').toString());
                const timeText = formatMessageTime(message.timestamp);
                const isNewMessage = newMessageHighlights.has(message.messageId);
                
                // Determine outer container styling with new message highlighting
                let containerClasses = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-3`;
                
                // Add sky blue background highlighting for new messages (full background, no outline)
                if (isNewMessage && !isCurrentUser) {
                    containerClasses += ' bg-sky-300 rounded-lg p-3 animate-pulse new-message-highlight';
                }
                
                // Determine message bubble styling (without highlighting)
                let messageClasses = `max-w-[70%] rounded-lg px-3 py-2 shadow-sm transition-all duration-500 ${message.isTemporary ? 'opacity-70' : ''}`;
                
                if (isCurrentUser) {
                    messageClasses += ' bg-blue-600 text-white';
                } else {
                    messageClasses += ' bg-white border border-gray-200';
                }
                
                html += `
                    <div class="${containerClasses}" data-message-id="${message.messageId}">
                        <div class="${messageClasses}">
                            <p class="text-sm break-words">${messageText}</p>
                            <p class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} mt-1">
                                ${timeText}${message.readStatus === 'read' && isCurrentUser ? ' ✓' : ''}
                            </p>
                        </div>
                    </div>
                `;
            });
            
            // Single DOM update for maximum performance
            container.innerHTML = html;
            container.dataset.lastSignature = messageSignature;
            
            // Restore scroll position
            if (wasAtBottom) {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
            
            // Clear new message highlights after 3 seconds
            if (newMessageHighlights.size > 0) {
                setTimeout(() => {
                    newMessageHighlights.clear();
                    displayMessages(); // Re-render without highlights
                }, 3000);
            }
        }

        async function markMessagesAsRead() {
            if (!selectedUser || !currentUser) return;
            
            try {
                const formData = new FormData();
                formData.append('action', 'markMessagesAsRead');
                formData.append('currentUser', currentUser.username);
                formData.append('otherUser', selectedUser.username);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.updatedCount > 0) {
                    console.log(`Marked ${result.updatedCount} messages as read`);
                }
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        async function sendMessage(messageText) {
            if (!selectedUser || !currentUser || !messageText.trim()) return;
            
            const trimmedMessage = messageText.trim();
            
            // INSTANT UI UPDATE - Add message immediately with final message ID
            const tempMessage = {
                messageId: 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                senderUsername: currentUser.username,
                receiverUsername: selectedUser.username,
                message: trimmedMessage,
                timestamp: new Date().toISOString(),
                readStatus: 'unread',
                isTemporary: true,
                isSending: true
            };
            
            // Add to messages and display instantly
            messages.push(tempMessage);
            displayMessages();
            
            // Clear input instantly
            const messageInput = document.getElementById('messageInput');
            if (messageInput) messageInput.value = '';
            
            // No status indicator - keep it silent for speed
            
            try {
                // Send message to server in parallel (don't block UI)
                const sendPromise = fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: (() => {
                        const formData = new FormData();
                        formData.append('action', 'sendMessage');
                        formData.append('senderUsername', currentUser.username);
                        formData.append('receiverUsername', selectedUser.username);
                        formData.append('message', trimmedMessage);
                        return formData;
                    })()
                });
                
                // Update caches immediately with temp message for instant sync
                const conversationKey = `${currentUser.username}-${selectedUser.username}`;
                messagesCache.set(conversationKey, {
                    messages: messages,
                    timestamp: Date.now()
                });
                saveMessagesToLocalStorage(conversationKey, messages);
                
                // Handle server response
                const res = await sendPromise;
                const result = await res.json();
                
                if (result.success) {
                    // Replace temp message with real one instantly
                    const messageIndex = messages.findIndex(msg => msg.messageId === tempMessage.messageId);
                    if (messageIndex !== -1) {
                        // Create real message object
                        const realMessage = {
                            messageId: result.messageId || tempMessage.messageId.replace('temp-', 'real-'),
                            senderUsername: currentUser.username,
                            receiverUsername: selectedUser.username,
                            message: trimmedMessage,
                            timestamp: result.timestamp || tempMessage.timestamp,
                            readStatus: 'unread',
                            isTemporary: false,
                            isSending: false
                        };
                        
                        // Replace temp message with real one
                        messages[messageIndex] = realMessage;
                        displayMessages();
                        
                        // Update caches with real message
                        messagesCache.set(conversationKey, {
                            messages: messages,
                            timestamp: Date.now()
                        });
                        saveMessagesToLocalStorage(conversationKey, messages);
                        
                        // IMPORTANT: Mark the message timestamp to prevent background overwrites
                        window.lastSentMessageTime = Date.now();
                    }
                    
                    // DON'T trigger background refresh immediately - wait longer to prevent overwrite
                    setTimeout(() => {
                        // Only refresh if enough time has passed since our message
                        if (Date.now() - (window.lastSentMessageTime || 0) > 2000) {
                            loadMessagesInBackground();
                        }
                    }, 3000); // Reduced delay to 3 seconds
                    
                } else {
                    throw new Error(result.error || 'Failed to send message');
                }
            } catch (error) {
                // Remove temporary message on error and show user feedback
                const messageIndex = messages.findIndex(msg => msg.messageId === tempMessage.messageId);
                if (messageIndex !== -1) {
                    messages.splice(messageIndex, 1);
                    displayMessages();
                }
                
                console.error('Error sending message:', error);
                
                // Restore message to input
                if (messageInput) messageInput.value = trimmedMessage;
                
                // Show error briefly
                showMessageStatus('error', 'Failed to send');
                setTimeout(() => hideMessageStatus(), 1500);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Message form submission
        document.addEventListener('DOMContentLoaded', function() {
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            
            if (messageForm) {
                messageForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const messageText = messageInput.value.trim();
                    if (messageText) {
                        sendMessage(messageText);
                    }
                });
            }
            
            // Add instant Enter key support for ultra-fast messaging
            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const messageText = messageInput.value.trim();
                        if (messageText) {
                            sendMessage(messageText);
                        }
                    }
                });
                
                // Also add input event to auto-resize if needed and provide instant feedback
                messageInput.addEventListener('input', function() {
                    // Auto-trim whitespace for better UX
                    const cursorPos = messageInput.selectionStart;
                    const trimmedValue = messageInput.value.replace(/^\s+/, ''); // Only trim leading spaces
                    if (trimmedValue !== messageInput.value) {
                        messageInput.value = trimmedValue;
                        messageInput.setSelectionRange(Math.max(0, cursorPos - (messageInput.value.length - trimmedValue.length)), Math.max(0, cursorPos - (messageInput.value.length - trimmedValue.length)));
                    }
                });
            }
            
            // Edit usage log form submission
            const editUsageForm = document.getElementById('editUsageLogForm');
            if (editUsageForm) {
                editUsageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await updateUsageLog();
                });
            }
        });

        // Reservation Modal functions
        function openReservationModal() {
            // Check if user has permission
            if (currentUser && currentUser.userType !== 'admin') {
                alert('Access denied. Only administrators can create reservations.');
                return;
            }
            
            document.getElementById('reservationModal').classList.remove('hidden');
            document.getElementById('reservationMsg').textContent = '';
            document.getElementById('reservationForm').reset();
            
            // Auto-populate day field based on selected date
            if (selectedDate) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[selectedDate.getDay()];
                const dayInput = document.querySelector('#reservationModal input[name="day"]');
                if (dayInput) {
                    dayInput.value = dayName;
                }
                
                // Also pre-fill the activity date
                const activityDateInput = document.querySelector('#reservationModal input[name="activityDate"]');
                if (activityDateInput) {
                    const year = selectedDate.getFullYear();
                    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                    const day = String(selectedDate.getDate()).padStart(2, '0');
                    activityDateInput.value = `${year}-${month}-${day}`;
                }
            }
            
            // Add event listener for activity date changes to auto-update day field
            const activityDateInput = document.querySelector('#reservationModal input[name="activityDate"]');
            if (activityDateInput) {
                // Remove existing listener to prevent duplicates
                activityDateInput.removeEventListener('change', updateReservationDayField);
                // Add new listener
                activityDateInput.addEventListener('change', updateReservationDayField);
            }
            
            // Load and populate venues if not already loaded or if dropdown is empty
            if (venues.length === 0) {
                fetchVenues(false);
            } else {
                // Only populate if dropdown is empty
                const venueSelect = document.getElementById('venueSelect');
                if (venueSelect && venueSelect.options.length <= 1) {
                    populateVenueDropdown();
                }
            }
            
            // Load and populate departments if not already loaded or if dropdown is empty
            if (departments.length === 0) {
                fetchDepartments(false);
            } else {
                // Only populate if dropdown is empty
                const deptSelect = document.querySelector('#reservationModal select[name="department"]');
                if (deptSelect && deptSelect.options.length <= 1) {
                    populateDepartmentDropdowns();
                }
            }
        }
        
        function updateReservationDayField() {
            const activityDateInput = document.querySelector('#reservationModal input[name="activityDate"]');
            const dayInput = document.querySelector('#reservationModal input[name="day"]');
            
            if (!activityDateInput || !dayInput) return;
            
            const dateValue = activityDateInput.value;
            if (dateValue) {
                const date = new Date(dateValue);
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dayInput.value = dayNames[date.getDay()];
            }
        }
        
        function closeReservationModal() {
            document.getElementById('reservationModal').classList.add('hidden');
        }

        // Calendar functions
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = 
                monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            
            // Create table structure
            calendar.innerHTML = `
                <thead>
                    <tr style="background-color: #CCC;">
                        <th width="14%" height="45"><div align="center">SUN</div></th>
                        <th width="14%"><div align="center">MON</div></th>
                        <th width="14%"><div align="center">TUE</div></th>
                        <th width="14%"><div align="center">WED</div></th>
                        <th width="14%"><div align="center">THU</div></th>
                        <th width="14%"><div align="center">FRI</div></th>
                        <th width="14%"><div align="center">SAT</div></th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = calendar.querySelector('tbody');
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let currentWeek = null;
            
            for (let i = 0; i < 42; i++) {
                if (i % 7 === 0) {
                    currentWeek = document.createElement('tr');
                    tbody.appendChild(currentWeek);
                }
                
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const dayOfWeek = day.getDay();
                const dayOfMonth = day.getDate();
                const dayDate = new Date(day);
                dayDate.setHours(0, 0, 0, 0);
                
                // Determine cell background class
                let cellClass = '';
                let isCurrentMonth = day.getMonth() === currentDate.getMonth();
                
                if (dayOfWeek === 0) { // Sunday
                    cellClass = 'bg-red';
                } else if (dayOfWeek === 6) { // Saturday
                    cellClass = 'bg-orange';
                } else if (!isCurrentMonth) {
                    cellClass = 'bg-gray-100';
                } else if (dayDate.getTime() === today.getTime()) {
                    cellClass = 'bg-maroon'; // Today's date
                }
                
                const cell = document.createElement('td');
                cell.className = `calendar-cell ${cellClass}`;
                
                // Create clickable day link
                const dayLink = document.createElement('a');
                dayLink.id = `dyvw${i}`;
                dayLink.className = 'thickbox';
                dayLink.style.cssText = 'cursor:pointer;color:inherit;text-decoration:none;';
                dayLink.title = 'Show Reservation List';
                dayLink.onclick = (e) => {
                    e.preventDefault();
                    selectDate(day);
                };
                
                // Date number
                const dateDiv = document.createElement('div');
                dateDiv.style.cssText = 'text-align: right; font-size: 18px; margin-bottom: 10px;';
                dateDiv.innerHTML = `<strong>${dayOfMonth}</strong>`;
                dayLink.appendChild(dateDiv);
                cell.appendChild(dayLink);
                
                // Reservations container
                const reservationsContainer = document.createElement('div');
                reservationsContainer.style.cssText = 'padding-top: 10px;';
                
                // Get reservations for this date
                // Use timezone-neutral date string creation to avoid timezone issues
                const year = day.getFullYear();
                const month = String(day.getMonth() + 1).padStart(2, '0');
                const dayOfMonthStr = String(day.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${dayOfMonthStr}`;
                let dayReservations = reservations.filter(res => res.activityDate === dateString);
                
                // Filter by user's venue assignments if not admin
                if (currentUser && currentUser.userType !== 'admin' && currentUser.venueAssignments !== 'ALL') {
                    const allowedVenues = currentUser.venueAssignments.split(',').map(v => v.trim());
                    dayReservations = dayReservations.filter(reservation => 
                        allowedVenues.includes(reservation.venue)
                    );
                }
                
                // Display reservations
                dayReservations.forEach((reservation, index) => {
                    const reservationLink = document.createElement('a');
                    reservationLink.id = `view${i}_${index}`;
                    reservationLink.className = 'thickbox';
                    reservationLink.title = 'Show Reservation Details';
                    reservationLink.href = '#';
                    reservationLink.style.cssText = 'text-decoration: none; color: inherit;';
                    reservationLink.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showReservationDetails(reservation);
                    };
                    
                    const reservationDiv = document.createElement('div');
                    reservationDiv.style.cssText = 'padding-bottom: 3px;';
                    
                    const reservationContent = document.createElement('div');
                    // Use different colors for different types of reservations
                    const bgColor = reservation.status === 'Approved' ? 'bg-green' : 
                                   reservation.status === 'Rejected' ? 'bg-red' : 
                                   'bg-blue';
                    reservationContent.className = bgColor;
                    reservationContent.style.cssText = 'padding: 3px; font-size: 12px; border-radius: 4px; margin-bottom: 2px;';
                    
                    const timeDiv = document.createElement('div');
                    timeDiv.textContent = formatTimeRange(reservation.time) || 'All Day';
                    
                    const purposeDiv = document.createElement('div');
                    // Truncate long purposes
                    const purpose = reservation.purpose || 'Event';
                    purposeDiv.textContent = purpose.length > 25 ? purpose.substring(0, 25) + '...' : purpose;
                    
                    reservationContent.appendChild(timeDiv);
                    reservationContent.appendChild(purposeDiv);
                    reservationDiv.appendChild(reservationContent);
                    reservationLink.appendChild(reservationDiv);
                    reservationsContainer.appendChild(reservationLink);
                });
                
                cell.appendChild(reservationsContainer);
                currentWeek.appendChild(cell);
            }
        }

        function formatTimeRange(timeString) {
            if (!timeString) return null;
            
            // If it's already formatted with am/pm, return as is
            if (timeString.includes('am') || timeString.includes('pm')) {
                return timeString;
            }
            
            // Helper function to convert 24-hour to 12-hour format
            function convertTo12Hour(time24) {
                const [hours, minutes] = time24.split(':');
                const hour24 = parseInt(hours);
                const ampm = hour24 >= 12 ? 'PM' : 'AM';
                const hour12 = hour24 % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            // Handle time ranges (e.g., "09:00 - 17:00")
            if (timeString.includes(' - ')) {
                const [startTime, endTime] = timeString.split(' - ').map(t => t.trim());
                if (startTime.match(/^\d{1,2}:\d{2}$/) && endTime.match(/^\d{1,2}:\d{2}$/)) {
                    return `${convertTo12Hour(startTime)} - ${convertTo12Hour(endTime)}`;
                }
                return timeString;
            }
            
            // Handle single time (e.g., "09:00")
            const time = timeString.trim();
            if (time.match(/^\d{1,2}:\d{2}$/)) {
                return convertTo12Hour(time);
            }
            
            return timeString;
        }

        function showReservationDetails(reservation) {
            // Create and show reservation details modal
            const modalHtml = `
                <div id="reservationDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-900">Reservation Details</h3>
                            <button onclick="closeReservationDetailsModal()" class="text-gray-400 hover:text-gray-600 p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 gap-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Reservation ID:</span>
                                    <span class="text-gray-900">${reservation.reservationId || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Date:</span>
                                    <span class="text-gray-900">${formatDate(reservation.activityDate) || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Day:</span>
                                    <span class="text-gray-900">${reservation.day || formatDayFromDate(reservation.activityDate) || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Time:</span>
                                    <span class="text-gray-900">${formatTimeRange(reservation.time) || 'All Day'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Venue:</span>
                                    <span class="text-gray-900">${reservation.venue || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Department:</span>
                                    <span class="text-gray-900">${reservation.department || 'N/A'}</span>
                                </div>
                                <div class="border-t pt-4">
                                    <span class="font-medium text-gray-700">Purpose:</span>
                                    <p class="text-gray-900 mt-2">${reservation.purpose || 'N/A'}</p>
                                </div>
                                ${reservation.facilities ? `
                                <div class="border-t pt-4">
                                    <span class="font-medium text-gray-700">Facilities:</span>
                                    <p class="text-gray-900 mt-2">${reservation.facilities}</p>
                                </div>
                                ` : ''}
                                <div class="flex justify-between items-center border-t pt-4">
                                    <span class="font-medium text-gray-700">Status:</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                        reservation.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                        reservation.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">${reservation.status || 'Pending'}</span>
                                </div>
                                ${reservation.dateSubmitted ? `
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Date Submitted:</span>
                                    <span class="text-gray-900">${formatDate(reservation.dateSubmitted)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeReservationDetailsModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('reservationDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            let date;
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Handle YYYY-MM-DD format with timezone-neutral parsing
                const [year, month, day] = dateString.split('-');
                date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return dateString || 'N/A';
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            });
        }

        function formatDayFromDate(dateString) {
            if (!dateString) return null;
            
            let date;
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Handle YYYY-MM-DD format with timezone-neutral parsing
                const [year, month, day] = dateString.split('-');
                date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return null;
            
            return date.toLocaleDateString('en-US', { weekday: 'long' });
        }

        function closeReservationDetailsModal() {
            const modal = document.getElementById('reservationDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectDate(date) {
            selectedDate = date;
            // Use timezone-neutral date string creation to avoid timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            const dayReservations = reservations.filter(res => res.activityDate === dateString);
            
            if (dayReservations.length > 0) {
                showDateReservations(date, dayReservations);
            } else {
                // Only allow admins to create new reservations from calendar
                if (currentUser && currentUser.userType === 'admin') {
                    // Open reservation modal for this date
                    openReservationModal();
                    // Pre-fill the date
                    const activityDateInput = document.querySelector('input[name="activityDate"]');
                    if (activityDateInput) {
                        activityDateInput.value = dateString;
                    }
                }
                // Regular users can click on empty dates without any message
            }
        }
        function showDateReservations(date, dayReservations) {
            const modal = document.getElementById('dateReservationsModal');
            const title = document.getElementById('dateModalTitle');
            const tbody = document.getElementById('dateReservationsTableBody');
            title.textContent = `Reservations for ${date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`;
            tbody.innerHTML = '';
            dayReservations.forEach(reservation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.time || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.venue || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.department || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.purpose || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            reservation.status === 'Approved' ? 'bg-green-100 text-green-800' :
                            reservation.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">${reservation.status || 'Pending'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            modal.classList.remove('hidden');
        }
        function closeDateReservationsModal() {
            document.getElementById('dateReservationsModal').classList.add('hidden');
        }
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function loadAllReservations(filteredReservations = null) {
            const tbody = document.getElementById('reservationsTableBody');
            tbody.innerHTML = '';
            
            // Use filtered reservations if provided, otherwise use all reservations
            let reservationsToShow = filteredReservations || reservations;
            
            // Filter by user's venue assignments if not admin
            if (currentUser && currentUser.userType !== 'admin' && currentUser.venueAssignments !== 'ALL') {
                const allowedVenues = currentUser.venueAssignments.split(',').map(v => v.trim());
                reservationsToShow = reservationsToShow.filter(reservation => 
                    allowedVenues.includes(reservation.venue)
                );
            }
            
            // Sort reservations by activity date (earliest/closest dates first)
            reservationsToShow.sort((a, b) => {
                // Parse dates for comparison
                let dateA, dateB;
                
                if (a.activityDate) {
                    if (typeof a.activityDate === 'string' && a.activityDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = a.activityDate.split('-');
                        dateA = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    } else {
                        dateA = new Date(a.activityDate);
                    }
                } else {
                    dateA = new Date('9999-12-31'); // Very future date for invalid dates (puts them at bottom)
                }
                
                if (b.activityDate) {
                    if (typeof b.activityDate === 'string' && b.activityDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = b.activityDate.split('-');
                        dateB = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    } else {
                        dateB = new Date(b.activityDate);
                    }
                } else {
                    dateB = new Date('9999-12-31'); // Very future date for invalid dates (puts them at bottom)
                }
                
                // Sort in ascending order (earliest dates first)
                return dateA - dateB;
            });
            
            if (reservationsToShow.length === 0) {
                const noDataMessage = filteredReservations ? 'No reservations found matching your filters' : 'No reservations found';
                const subMessage = filteredReservations ? 'Try adjusting your search criteria' : 'Create a new reservation to get started';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-gray-300 mb-4 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-lg font-medium text-gray-400 mb-2">${noDataMessage}</p>
                            <p class="text-sm text-gray-400">${subMessage}</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            reservationsToShow.forEach(reservation => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // Format date for display
                let formattedDate = '';
                if (reservation.activityDate) {
                    if (typeof reservation.activityDate === 'string' && reservation.activityDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = reservation.activityDate.split('-');
                        const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        formattedDate = dateObj.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    } else {
                        formattedDate = new Date(reservation.activityDate).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                }
                
                // Format time using existing function
                const formattedTime = formatTimeRange(reservation.time) || 'All Day';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.venue || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reservation.department || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate" title="${reservation.purpose || ''}">${reservation.purpose || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-full text-xs status-badge ${
                            reservation.status === 'Approved' ? 'bg-green-100 text-green-800' :
                            reservation.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">${reservation.status || 'Pending'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter reservations by date range
        function filterReservations() {
            const fromDate = document.getElementById('fromDateFilter').value;
            const toDate = document.getElementById('toDateFilter').value;
            
            if (!fromDate && !toDate) {
                // No filters applied, show all reservations
                loadAllReservations();
                return;
            }
            
            const filteredReservations = reservations.filter(reservation => {
                if (!reservation.activityDate) return false;
                
                // Create timezone-neutral Date objects for comparison
                let reservationDate;
                if (typeof reservation.activityDate === 'string' && reservation.activityDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = reservation.activityDate.split('-');
                    reservationDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                } else {
                    reservationDate = new Date(reservation.activityDate);
                }
                
                let from = null, to = null;
                if (fromDate) {
                    const [year, month, day] = fromDate.split('-');
                    from = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                }
                if (toDate) {
                    const [year, month, day] = toDate.split('-');
                    to = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    // Set to end of day for inclusive comparison
                    to.setHours(23, 59, 59, 999);
                }
                
                // Check date range
                if (from && reservationDate < from) return false;
                if (to && reservationDate > to) return false;
                
                return true;
            });
            
            loadAllReservations(filteredReservations);
        }
        
        // Clear reservation filters
        function clearReservationFilters() {
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            loadAllReservations();
        }

        // Load reservation data from Google Apps Script
        async function fetchReservations(showLoader = true) {
            if (showLoader) {
                showLoading('Loading Reservations...', 'Fetching all reservation data from database');
            }
            try {
                if (showLoader) setProgress(20);
                
                const formData = new FormData();
                formData.append('action', 'getAllReservations');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                if (showLoader) setProgress(50);
                const result = await res.json();
                if (showLoader) setProgress(75);
                if (result.success && result.reservations) {
                    reservations = result.reservations;
                    if (showLoader) updateLoadingText('Processing Reservations...', 'Generating calendar and updating statistics');
                } else {
                    reservations = [];
                    if (showLoader) updateLoadingText('No Reservations Found', 'No reservations in the system');
                }
                if (showLoader) setProgress(90);
            } catch (err) {
                reservations = [];
                if (showLoader) updateLoadingText('Error Loading Reservations', 'Failed to fetch reservation data');
            }
            generateCalendar();
            updateHeaderStats();
            // If in reservations section, reload table
            if (!document.getElementById('reservations-section').classList.contains('hidden')) {
                loadAllReservations();
            }
            if (showLoader) {
                updateLoadingText('Reservations Loaded!', 'Calendar and statistics updated successfully');
                hideLoading();
            }
        }

        // Load venues from Google Apps Script
        async function fetchVenues(showLoader = true) {
            if (showLoader) {
                showLoading('Loading Venues...', 'Fetching available venues from database');
            }
            try {
                if (showLoader) setProgress(25);
                
                const formData = new FormData();
                formData.append('action', 'getVenues');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                if (showLoader) setProgress(60);
                const result = await res.json();
                if (showLoader) setProgress(85);
                if (result.success && result.venues) {
                    venues = result.venues;
                    // Only populate dropdowns if they haven't been populated yet
                    const venueSelect = document.getElementById('venueSelect');
                    const usageVenueSelect = document.getElementById('usageVenueSelect');
                    if (venueSelect && venueSelect.options.length <= 1) {
                        populateVenueDropdown();
                    }
                    if (usageVenueSelect && usageVenueSelect.options.length <= 1) {
                        populateUsageVenueDropdown();
                    }
                    updateHeaderStats();
                    if (showLoader) updateLoadingText('Venues Loaded!', 'Successfully loaded venue information');
                } else {
                    venues = [];
                    if (showLoader) updateLoadingText('No Venues Found', 'No venues available in the system');
                }
                if (showLoader) hideLoading();
            } catch (err) {
                venues = [];
                console.error('Error fetching venues:', err);
                if (showLoader) {
                    updateLoadingText('Error Loading Venues', 'Failed to fetch venue data');
                    setTimeout(hideLoading, 1000);
                }
            }
        }

        // Load departments from Google Apps Script
        async function fetchDepartments(showLoader = true) {
            if (showLoader) {
                showLoading('Loading Departments...', 'Fetching department list from database');
            }
            try {
                if (showLoader) setProgress(30);
                
                const formData = new FormData();
                formData.append('action', 'getDepartments');
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                if (showLoader) setProgress(70);
                const result = await res.json();
                if (showLoader) setProgress(90);
                if (result.success && result.departments) {
                    departments = result.departments;
                    // Only populate dropdowns if they haven't been populated yet
                    const reservationDeptSelect = document.querySelector('#reservationModal select[name="department"]');
                    const usageDeptSelect = document.querySelector('#usageModal select[name="department"]');
                    if (reservationDeptSelect && reservationDeptSelect.options.length <= 1) {
                        populateDepartmentDropdowns();
                    }
                    if (usageDeptSelect && usageDeptSelect.options.length <= 1) {
                        populateDepartmentDropdowns();
                    }
                    if (showLoader) updateLoadingText('Departments Loaded!', 'Successfully populated department dropdowns');
                } else {
                    departments = [];
                    if (showLoader) updateLoadingText('No Departments Found', 'Using default department list');
                }
                if (showLoader) hideLoading();
            } catch (err) {
                departments = [];
                console.error('Error fetching departments:', err);
                if (showLoader) {
                    updateLoadingText('Error Loading Departments', 'Using fallback department list');
                    setTimeout(hideLoading, 1000);
                }
            }
        }

        // Populate venue dropdown
        function populateVenueDropdown() {
            const venueSelect = document.getElementById('venueSelect');
            if (!venueSelect) return;
            
            // Save current selection if any
            const currentValue = venueSelect.value;
            
            // Clear existing options except the first one
            venueSelect.innerHTML = '<option value="">Select a venue...</option>';
            
            // Filter venues based on user's assignments
            let availableVenues = venues;
            if (currentUser && currentUser.userType !== 'admin' && currentUser.venueAssignments !== 'ALL') {
                const allowedVenues = currentUser.venueAssignments.split(',').map(v => v.trim());
                availableVenues = venues.filter(venue => allowedVenues.includes(venue.name));
            }
            
            availableVenues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.name;
                option.textContent = `${venue.name} (Capacity: ${venue.capacity})`;
                option.title = `Facilities: ${venue.facilities}`;
                venueSelect.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue && venueSelect.querySelector(`option[value="${currentValue}"]`)) {
                venueSelect.value = currentValue;
            }
        }

        // Populate department dropdowns
        function populateDepartmentDropdowns() {
            // Populate reservation form department dropdown
            const reservationDeptSelect = document.querySelector('#reservationModal select[name="department"]');
            if (reservationDeptSelect) {
                // Save current selection if any
                const currentValue = reservationDeptSelect.value;
                
                // Clear existing options except the first one
                reservationDeptSelect.innerHTML = '<option value="">Select department...</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    reservationDeptSelect.appendChild(option);
                });
                
                // Restore previous selection if it still exists
                if (currentValue && reservationDeptSelect.querySelector(`option[value="${currentValue}"]`)) {
                    reservationDeptSelect.value = currentValue;
                }
            }

            // Populate usage log form department dropdown
            const usageDeptSelect = document.querySelector('#usageModal select[name="department"]');
            if (usageDeptSelect) {
                // Save current selection if any
                const currentValue = usageDeptSelect.value;
                
                // Clear existing options except the first one  
                usageDeptSelect.innerHTML = '<option value="">Select department...</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    usageDeptSelect.appendChild(option);
                });
                
                // Restore previous selection if it still exists
                if (currentValue && usageDeptSelect.querySelector(`option[value="${currentValue}"]`)) {
                    usageDeptSelect.value = currentValue;
                }
            }
        }

        // Load venues grid for venues section
        function loadVenuesGrid() {
            const venuesGrid = document.getElementById('venuesGrid');
            if (!venuesGrid) return;
            
            venuesGrid.innerHTML = '';
            
            if (venues.length === 0) {
                venuesGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No venues found</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding a new venue.</p>
                    </div>
                `;
                return;
            }
            
            venues.forEach(venue => {
                const venueCard = document.createElement('div');
                venueCard.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-6 card-shadow hover:shadow-md transition-shadow';
                venueCard.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${venue.name}</h3>
                    <p class="text-gray-600 mb-2">Capacity: ${venue.capacity} people</p>
                    <p class="text-gray-500 text-sm mb-4">${venue.facilities || 'No facilities listed'}</p>
                    <div class="flex items-center justify-between">
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm status-badge">${venue.status}</span>
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-semibold transition-colors">View Details</button>
                    </div>
                `;
                venuesGrid.appendChild(venueCard);
            });
        }

        // Add Venue Modal functions
        function openAddVenueModal() {
            // Check if user has permission
            if (currentUser && currentUser.userType !== 'admin') {
                alert('Access denied. Only administrators can add venues.');
                return;
            }
            
            document.getElementById('addVenueModal').classList.remove('hidden');
            document.getElementById('addVenueMsg').textContent = '';
            document.getElementById('addVenueForm').reset();
        }

        function closeAddVenueModal() {
            document.getElementById('addVenueModal').classList.add('hidden');
        }

        // Authentication functions
        function checkAuthentication() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'auth.html';
                return false;
            }
            
            try {
                currentUser = JSON.parse(userData);
                updateUIForUser();
                // Refresh user profile to get latest venue assignments
                refreshCurrentUserProfile();
                return true;
            } catch (e) {
                localStorage.removeItem('currentUser');
                window.location.href = 'auth.html';
                return false;
            }
        }

        async function refreshCurrentUserProfile() {
            if (!currentUser) return;
            
            try {
                const formData = new FormData();
                formData.append('action', 'getUserProfile');
                formData.append('username', currentUser.username);
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.success && result.user) {
                    // Update current user with latest profile data including venue assignments
                    currentUser = { ...currentUser, ...result.user };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update header display
                    updateHeaderUserInfo();
                    updateProfilePicture(currentUser.profilePicture);
                }
            } catch (error) {
                console.error('Error refreshing user profile:', error);
            }
        }

        function updateUIForUser() {
            if (!currentUser) return;
            
            // Update profile display in header - simple design
            const headerUserName = document.querySelector('header .text-gray-700.font-medium');
            const headerUserRole = document.querySelector('header .text-gray-500.text-xs');
            if (headerUserName) {
                headerUserName.textContent = currentUser.fullName || currentUser.username;
            }
            if (headerUserRole) {
                // Show the actual user type with proper capitalization
                const userTypeDisplay = currentUser.userType ? 
                    currentUser.userType.charAt(0).toUpperCase() + currentUser.userType.slice(1) : 'User';
                headerUserRole.textContent = userTypeDisplay;
            }
            
            // Update profile dropdown information
            const profileDisplayName = document.getElementById('profileDisplayName');
            const profileDisplayEmail = document.getElementById('profileDisplayEmail');
            const profileDisplayType = document.getElementById('profileDisplayType');
            
            if (profileDisplayName) {
                profileDisplayName.textContent = currentUser.fullName || currentUser.username;
            }
            if (profileDisplayEmail) {
                profileDisplayEmail.textContent = currentUser.email || '';
            }
            if (profileDisplayType) {
                // Show the actual user type with proper capitalization
                const userTypeDisplay = currentUser.userType ? 
                    currentUser.userType.charAt(0).toUpperCase() + currentUser.userType.slice(1) : 'User';
                profileDisplayType.textContent = userTypeDisplay;
                
                // Set color based on user type
                if (currentUser.userType === 'admin') {
                    profileDisplayType.className = 'inline-block px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full mt-1';
                } else if (currentUser.userType === 'user') {
                    profileDisplayType.className = 'inline-block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mt-1';
                } else {
                    profileDisplayType.className = 'inline-block px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full mt-1';
                }
            }
            
            // Update navigation visibility based on user type
            updateNavigationVisibility();
            
            // Show appropriate default section based on user type
            if (currentUser.userType === 'admin' || currentUser.userType === 'user') {
                // Admin and regular users see dashboard by default
                showSection('dashboard');
            } else {
                // Students, faculty, staff see file job order section by default
                showSection('file-job-order');
            }
            
            // Show/hide admin features based on user type
            if (currentUser.userType !== 'admin') {
                // Hide admin-only buttons
                const addVenueButton = document.querySelector('button[onclick="openAddVenueModal()"]');
                if (addVenueButton) {
                    addVenueButton.style.display = 'none';
                }
                
                const newReservationButton = document.querySelector('button[onclick="openReservationModal()"]');
                if (newReservationButton) {
                    newReservationButton.style.display = 'none';
                }
            }
        }
        
        // Update header statistics (simplified - no longer needed)
        function updateHeaderStats() {
            // Function kept for compatibility but no longer updates header stats
            // since we removed them from the header
        }

        function logout() {
            // Clear all real-time polling intervals
            stopRealTimePolling();
            
            localStorage.removeItem('currentUser');
            window.location.href = 'auth.html';
        }

        // Reservation Form Submit (SINGLE HANDLER - prevents duplicate submissions)
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const msgDiv = document.getElementById('reservationMsg');
            msgDiv.textContent = '';
            
            // Disable submit button to prevent multiple submissions
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            
            // Create FormData object
            const formData = new FormData();
            formData.append('venue', form.venue.value.trim());
            
            // Ensure date is in proper format
            const activityDate = form.activityDate.value;
            if (activityDate) {
                formData.append('activityDate', activityDate); // HTML date input already gives YYYY-MM-DD
            }
            
            formData.append('day', form.day.value.trim());
            formData.append('department', form.department.value.trim());
            
            // Combine start and end time into time field
            let timeValue = '';
            if (form.startTime.value && form.endTime.value) {
                timeValue = `${form.startTime.value} - ${form.endTime.value}`;
            } else if (form.startTime.value) {
                timeValue = form.startTime.value;
            } else if (form.endTime.value) {
                timeValue = form.endTime.value;
            }
            formData.append('time', timeValue);
            
            formData.append('purpose', form.purpose.value.trim());
            formData.append('facilities', form.facilities.value.trim());
            
            // Required fields validation
            if (!form.venue.value.trim() || !form.activityDate.value || !form.department.value.trim() || !form.purpose.value.trim()) {
                msgDiv.textContent = 'Please fill all required fields.';
                msgDiv.className = 'text-red-500 font-medium';
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }
            
            showLoading('Submitting Reservation...', 'Processing your venue reservation request');
            msgDiv.textContent = 'Submitting reservation...';
            msgDiv.className = 'text-blue-500 font-medium';
            
            try {
                setProgress(30);
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                setProgress(70);
                const result = await res.json();
                setProgress(90);
                
                if (result.success) {
                    updateLoadingText('Reservation Submitted!', 'Updating real-time data...');
                    msgDiv.textContent = 'Reservation submitted successfully! ID: ' + result.reservationId;
                    msgDiv.className = 'text-green-600 font-medium';
                    form.reset();
                    
                    // Trigger instant refresh for reservations
                    await triggerInstantRefresh('reservations');
                    hideLoading();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeReservationModal();
                    }, 2000);
                } else {
                    updateLoadingText('Reservation Failed', 'Error submitting reservation');
                    msgDiv.textContent = result.error || 'Submission failed.';
                    msgDiv.className = 'text-red-500 font-medium';
                    setTimeout(hideLoading, 1000);
                }
            } catch (err) {
                updateLoadingText('Network Error', 'Failed to connect to server');
                msgDiv.textContent = 'Network error. Please try again.';
                msgDiv.className = 'text-red-500 font-medium';
                console.error('Submission error:', err);
                setTimeout(hideLoading, 1000);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // Add Venue Form Submit Handler
        document.getElementById('addVenueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const msgDiv = document.getElementById('addVenueMsg');
            msgDiv.textContent = '';
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            
            // Create FormData object
            const formData = new FormData();
            formData.append('action', 'addVenue');
            formData.append('venueName', form.venueName.value.trim());
            formData.append('capacity', form.capacity.value);
            formData.append('facilities', form.facilities.value.trim());
            
            // Required fields validation
            if (!form.venueName.value.trim() || !form.capacity.value) {
                msgDiv.textContent = 'Please fill all required fields.';
                msgDiv.className = 'text-red-500 font-medium';
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }
            
            msgDiv.textContent = 'Adding venue...';
            msgDiv.className = 'text-blue-500 font-medium';
            
            try {
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    msgDiv.textContent = 'Venue added successfully!';
                    msgDiv.className = 'text-green-500 font-medium';
                    form.reset();
                    
                    // Refresh venues immediately (without loading overlay since form already shows success)
                    await fetchVenues(false);
                    loadVenuesGrid();
                    populateVenueDropdown(); // Update reservation form dropdown too
                    
                    // Close modal after 1.5 seconds
                    setTimeout(() => {
                        closeAddVenueModal();
                    }, 1500);
                } else {
                    msgDiv.textContent = result.error || 'Failed to add venue.';
                    msgDiv.className = 'text-red-500 font-medium';
                }
            } catch (err) {
                msgDiv.textContent = 'Network error. Please try again.';
                msgDiv.className = 'text-red-500 font-medium';
                console.error('Add venue error:', err);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // Profile Form Submit Handler
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleProfileSubmit(e);
        });
        
        // Handle profile form submission
        async function handleProfileSubmit(event) {
            const form = event.target;
            const profileMsg = document.getElementById('profileMsg');
            
            try {
                console.log('Starting profile update...'); // Debug log
                
                const formData = new FormData();
                formData.append('action', 'updateUserProfile');
                formData.append('username', currentUser.username);
                formData.append('fullName', form.fullName.value);
                formData.append('email', form.email.value);
                formData.append('phone', form.phone.value);
                formData.append('userType', form.userType.value);
                
                console.log('Form data prepared:', {
                    username: currentUser.username,
                    fullName: form.fullName.value,
                    email: form.email.value,
                    phone: form.phone.value,
                    userType: form.userType.value
                }); // Debug log
                
                // Handle profile picture - use compressed image from preview
                const profilePreview = document.getElementById('profilePreview');
                if (profilePreview && !profilePreview.classList.contains('hidden') && profilePreview.src.startsWith('data:')) {
                    console.log('Using compressed profile image, size:', profilePreview.src.length); // Debug log
                    
                    // Validate compressed image size
                    if (profilePreview.src.length > 45000) {
                        profileMsg.textContent = 'Compressed image is still too large. Please try a simpler image.';
                        profileMsg.className = 'text-red-500 text-sm mt-2';
                        return;
                    }
                    
                    formData.append('profilePicture', profilePreview.src);
                    await submitProfileUpdate(formData, profileMsg);
                } else {
                    console.log('No new image selected, using existing...'); // Debug log
                    // If no new image selected, preserve existing one
                    if (currentUser.profilePicture) {
                        formData.append('profilePicture', currentUser.profilePicture);
                    }
                    await submitProfileUpdate(formData, profileMsg);
                }
                
            } catch (error) {
                console.error('Error in handleProfileSubmit:', error); // Debug log
                profileMsg.textContent = 'Error updating profile: ' + error.message;
                profileMsg.className = 'text-red-500 text-sm mt-2';
            }
        }
        
        // Submit profile update
        async function submitProfileUpdate(formData, profileMsg) {
            try {
                console.log('Submitting profile update to backend...'); // Debug log
                
                profileMsg.textContent = 'Updating profile...';
                profileMsg.className = 'text-blue-500 text-sm mt-2';
                
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', res.status); // Debug log
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const result = await res.json();
                console.log('Backend response:', result); // Debug log
                
                if (result.success) {
                    // Update currentUser object
                    currentUser.fullName = formData.get('fullName');
                    currentUser.email = formData.get('email');
                    currentUser.phone = formData.get('phone');
                    currentUser.userType = formData.get('userType');
                    currentUser.profilePicture = formData.get('profilePicture');
                    
                    // Update localStorage
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update header display
                    updateHeaderUserInfo();
                    updateProfilePicture(currentUser.profilePicture);
                    
                    profileMsg.textContent = 'Profile updated successfully!';
                    profileMsg.className = 'text-green-500 text-sm mt-2';
                    
                    setTimeout(() => {
                        closeProfileModal();
                    }, 2000);
                } else {
                    console.error('Backend error:', result.error || result.message); // Debug log
                    profileMsg.textContent = result.error || result.message || 'Failed to update profile';
                    profileMsg.className = 'text-red-500 text-sm mt-2';
                }
            } catch (error) {
                console.error('Error in submitProfileUpdate:', error); // Debug log
                profileMsg.textContent = 'Error updating profile: ' + error.message;
                profileMsg.className = 'text-red-500 text-sm mt-2';
            }
        }

        // Update header user info
        function updateHeaderUserInfo() {
            const userNameSpan = document.querySelector('header .text-gray-700.font-medium');
            if (userNameSpan && currentUser) {
                userNameSpan.textContent = currentUser.fullName || currentUser.username;
            }
            
            // Update profile dropdown information
            const profileDisplayName = document.getElementById('profileDisplayName');
            const profileDisplayEmail = document.getElementById('profileDisplayEmail');
            
            if (profileDisplayName) {
                profileDisplayName.textContent = currentUser.fullName || currentUser.username;
            }
            if (profileDisplayEmail) {
                profileDisplayEmail.textContent = currentUser.email || '';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const profileMenu = document.getElementById('profileMenu');
            const profileButton = event.target.closest('button');
            if (!profileButton || !profileButton.onclick || profileButton.onclick.toString().indexOf('toggleProfileMenu') === -1) {
                profileMenu.classList.add('hidden');
            }
        });

        // ====== JOB ORDER FUNCTIONALITY ======
        
        // Job Order Data
        let jobOrders = [];
        let originalJobOrders = []; // Store original unfiltered data
        
        // Load job orders from backend
        async function loadJobOrders() {
            const tableBody = document.getElementById('jobOrdersTableBody');
            const loadingDiv = document.getElementById('jobOrdersLoading');
            const emptyDiv = document.getElementById('jobOrdersEmpty');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            emptyDiv.classList.add('hidden');
            tableBody.innerHTML = '';
            
            try {
                const formData = new FormData();
                formData.append('action', 'getJobOrders');
                if (currentUser) {
                    formData.append('username', currentUser.username);
                }
                
                console.log('Sending request to:', GOOGLE_APPS_SCRIPT_URL_FORM);
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.success) {
                    jobOrders = result.jobOrders || [];
                    originalJobOrders = [...jobOrders]; // Store original unfiltered data
                    console.log('Loaded job orders:', jobOrders);
                    console.log('First job order (if any):', jobOrders[0]);
                    if (jobOrders.length > 0) {
                        console.log('First job order department:', jobOrders[0].department);
                        console.log('First job order keys:', Object.keys(jobOrders[0]));
                    }
                    populateJobOrderDepartmentFilter();
                    displayJobOrders(jobOrders);
                } else {
                    console.error('Failed to load job orders:', result.error);
                    alert(`Failed to load job orders: ${result.error}\n\nThis usually means the Google Apps Script needs to be redeployed with the new getJobOrders action.`);
                    showEmptyJobOrders();
                }
            } catch (error) {
                console.error('Error loading job orders:', error);
                alert(`Network error loading job orders: ${error.message}\n\nPlease check your internet connection and try again.`);
                showEmptyJobOrders();
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // Display job orders in table and mobile cards
        function displayJobOrders(orders) {
            const tableBody = document.getElementById('jobOrdersTableBody');
            const mobileContainer = document.getElementById('jobOrdersCardView');
            const emptyDiv = document.getElementById('jobOrdersEmpty');
            const countElement = document.getElementById('jobOrdersCount');
            
            // Update count
            if (countElement) {
                const totalCount = originalJobOrders.length;
                const displayedCount = orders.length;
                if (totalCount === displayedCount) {
                    countElement.textContent = `${totalCount} job order${totalCount !== 1 ? 's' : ''}`;
                } else {
                    countElement.textContent = `${displayedCount} of ${totalCount} job order${totalCount !== 1 ? 's' : ''} (filtered)`;
                }
            }
            
            if (!orders || orders.length === 0) {
                showEmptyJobOrders();
                return;
            }

            emptyDiv.classList.add('hidden');            // Store orders globally for mobile card access
            window.currentJobOrders = orders;
            
            // Desktop table view
            if (tableBody) {
                tableBody.innerHTML = orders.map((order, index) => `
                    <tr class="job-order-row ${getRandomFlagClass()} hover:bg-gray-50 cursor-pointer" onclick="openJobOrderDetailsModal(${index})">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.formNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(order.dateFiled)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.department || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${order.location || 'N/A'}">${order.location || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${order.natureOfWork || 'N/A'}">${order.natureOfWork || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.requestedBy || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(order.status)}">
                                ${order.status || 'Pending'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="event.stopPropagation(); openJobOrderDetailsModal(${index})" class="text-blue-600 hover:text-blue-700 mr-2" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); printJobOrder('${order.formNumber}').catch(console.error)" class="text-green-600 hover:text-green-700" title="Print">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Mobile card view
            if (mobileContainer) {
                mobileContainer.innerHTML = orders.map((order, index) => `
                <div class="job-order-card ${getRandomFlagClass()}" 
                     onclick="openJobOrderDetailsModal(${index})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="title">
                                <i class="fas fa-file-alt mr-2 text-blue-600"></i>
                                ${order.formNumber || 'N/A'}
                            </h3>
                            <p class="subtitle">
                                <i class="fas fa-calendar mr-1"></i>
                                ${formatDate(order.dateFiled)}
                            </p>
                        </div>
                        <span class="status-badge ${getStatusColor(order.status)}">
                            ${order.status || 'Pending'}
                        </span>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center text-xs text-gray-600">
                            <i class="fas fa-building mr-2 text-gray-400 w-4"></i>
                            <span class="truncate">${order.department || 'N/A'}</span>
                        </div>
                        
                        <div class="flex items-center text-xs text-gray-600">
                            <i class="fas fa-location-dot mr-2 text-orange-500 w-4"></i>
                            <span class="truncate font-medium">${order.location || 'No location specified'}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                        <div class="text-xs text-gray-500 flex items-center">
                            <i class="fas fa-user mr-1"></i>
                            <span class="truncate">${order.requestedBy || 'N/A'}</span>
                        </div>
                        <div class="flex space-x-2">
                            <div class="text-xs text-blue-600 flex items-center">
                                <i class="fas fa-eye mr-1"></i>
                                <span>View Details</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            }
        }
        
        // Show empty state
        function showEmptyJobOrders() {
            const emptyDiv = document.getElementById('jobOrdersEmpty');
            const countElement = document.getElementById('jobOrdersCount');
            const tableBody = document.getElementById('jobOrdersTableBody');
            const mobileContainer = document.getElementById('jobOrdersCardView');
            
            // Clear the table and mobile view content
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            if (mobileContainer) {
                mobileContainer.innerHTML = '';
            }
            if (countElement) {
                const totalCount = originalJobOrders.length;
                if (totalCount === 0) {
                    countElement.textContent = 'No job orders found';
                } else {
                    countElement.textContent = `0 of ${totalCount} job order${totalCount !== 1 ? 's' : ''} (filtered)`;
                }
            }
            
            // Update empty message based on whether it's filtered or truly empty
            const hasFilters = document.getElementById('jobOrderSearch').value || 
                              document.getElementById('jobOrderDepartmentFilter').value ||
                              document.getElementById('jobOrderDate').value;
            
            if (originalJobOrders.length === 0) {
                // No job orders at all
                emptyDiv.innerHTML = `
                    <div class="text-gray-500">
                        <i class="fas fa-clipboard text-4xl mb-4"></i>
                        <p class="text-lg font-medium mb-2">No job orders found</p>
                        <p class="text-sm">You haven't submitted any job orders yet.</p>
                    </div>
                `;
            } else if (hasFilters) {
                // Job orders exist but none match filters
                emptyDiv.innerHTML = `
                    <div class="text-gray-500">
                        <i class="fas fa-filter text-4xl mb-4"></i>
                        <p class="text-lg font-medium mb-2">No matching job orders</p>
                        <p class="text-sm">Try adjusting your filters to see more results.</p>
                        <button onclick="clearJobOrderFilters()" class="mt-3 px-4 py-2 text-blue-600 hover:text-blue-700 font-medium">
                            Clear Filters
                        </button>
                    </div>
                `;
            }
            
            emptyDiv.classList.remove('hidden');
        }
        
        // Get status color classes
        function getStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'completed':
                    return 'bg-green-100 text-green-800';
                case 'in progress':
                    return 'bg-blue-100 text-blue-800';
                case 'cancelled':
                    return 'bg-red-100 text-red-800';
                case 'pending':
                default:
                    return 'bg-yellow-100 text-yellow-800';
            }
        }
        
        // Refresh job orders (for testing, let's also try an existing action)
        function refreshJobOrders() {
            loadJobOrders();
        }
        
        // Populate job order department filter based on user type
        function populateJobOrderDepartmentFilter() {
            const departmentFilter = document.getElementById('jobOrderDepartmentFilter');
            if (!departmentFilter) return;
            
            // Clear existing options except "All Departments"
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            if (currentUser && currentUser.userType === 'admin') {
                // Admin can see all departments
                const uniqueDepartments = [...new Set(originalJobOrders.map(order => order.department).filter(dept => dept))];
                uniqueDepartments.sort().forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentFilter.appendChild(option);
                });
            } else {
                // Non-admin users can only see their own department
                if (currentUser && currentUser.department) {
                    const option = document.createElement('option');
                    option.value = currentUser.department;
                    option.textContent = currentUser.department;
                    departmentFilter.appendChild(option);
                    
                    // Auto-select their department
                    departmentFilter.value = currentUser.department;
                }
            }
        }
        
        // Filter job orders based on search, department, and date range
        let filterTimeout = null;
        function filterJobOrders(immediate = false) {
            // Debounce search input to avoid filtering on every keystroke
            if (!immediate && filterTimeout) {
                clearTimeout(filterTimeout);
            }
            
            const doFilter = () => {
                const searchTerm = document.getElementById('jobOrderSearch').value.toLowerCase().trim();
                const departmentFilter = document.getElementById('jobOrderDepartmentFilter').value;
                const selectedDate = document.getElementById('jobOrderDate').value;
                
                let filteredOrders = [...originalJobOrders];
                
                // Apply search filter (search in form number, location, nature of work, and requested by)
                if (searchTerm) {
                    filteredOrders = filteredOrders.filter(order => {
                        const searchableFields = [
                            order.formNumber,
                            order.location,
                            order.natureOfWork,
                            order.requestedBy
                        ].filter(field => field); // Remove empty/null fields
                        
                        return searchableFields.some(field => 
                            field.toLowerCase().includes(searchTerm)
                        );
                    });
                }
                
                // Apply department filter
                if (departmentFilter) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.department === departmentFilter
                    );
                }
                
                // Apply date filter
                if (selectedDate) {
                    filteredOrders = filteredOrders.filter(order => {
                        if (!order.dateFiled) return false;
                        
                        // Convert order date to Date object
                        let orderDate;
                        if (typeof order.dateFiled === 'string' && order.dateFiled.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const [year, month, day] = order.dateFiled.split('-');
                            orderDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        } else {
                            orderDate = new Date(order.dateFiled);
                        }
                        
                        if (isNaN(orderDate.getTime())) return false;
                        
                        // Convert selected date to Date object
                        const [year, month, day] = selectedDate.split('-');
                        const filterDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        
                        // Check if dates match
                        return orderDate.getTime() === filterDate.getTime();
                    });
                }
                
                // Update the displayed job orders
                jobOrders = filteredOrders;
                displayJobOrders(jobOrders);
            };
            
            if (immediate) {
                doFilter();
            } else {
                filterTimeout = setTimeout(doFilter, 300); // 300ms debounce
            }
        }
        
        // Clear all job order filters
        function clearJobOrderFilters() {
            document.getElementById('jobOrderSearch').value = '';
            document.getElementById('jobOrderDepartmentFilter').value = '';
            document.getElementById('jobOrderDate').value = '';
            
            // Reset to original unfiltered data
            jobOrders = [...originalJobOrders];
            displayJobOrders(jobOrders);
        }
        
        // Test function to verify backend connectivity
        async function testBackendConnection() {
            try {
                const formData = new FormData();
                formData.append('action', 'getDepartments'); // This action should exist
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Backend test result:', result);
                
                if (result.success) {
                    alert('Backend connection successful! The issue is that getJobOrders action needs to be deployed.');
                } else {
                    alert('Backend connection failed: ' + result.error);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }
        
        // View job order details (placeholder for future modal)
        function viewJobOrderDetails(formNumber) {
            const order = jobOrders.find(o => o.formNumber === formNumber);
            if (order) {
                alert(`Job Order Details:\n\nForm Number: ${order.formNumber}\nDepartment: ${order.department}\nLocation: ${order.location}\nNature of Work: ${order.natureOfWork}\nRequested By: ${order.requestedBy}\nStatus: ${order.status}\nDate Filed: ${formatDate(order.dateFiled)}\nDate Submitted: ${formatDate(order.dateSubmitted)}`);
            }
        }
        
        // Print job order - regenerates print content from form data
        async function printJobOrder(formNumber) {
            const order = jobOrders.find(o => o.formNumber === formNumber);
            if (!order) {
                alert('Job order not found.');
                return;
            }

            try {
                // Show loading overlay
                showLoadingOverlay();

                // Call backend to generate fresh print content
                const formDataToSend = new FormData();
                formDataToSend.append('action', 'generatePrintContent');
                formDataToSend.append('formNumber', order.formNumber);
                formDataToSend.append('department', order.department);
                formDataToSend.append('dateFiled', formatDate(order.dateFiled));
                formDataToSend.append('location', order.location);
                formDataToSend.append('natureOfWork', order.natureOfWork);
                formDataToSend.append('requestedBy', order.requestedBy);

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formDataToSend
                });

                const result = await response.json();
                
                // Hide loading overlay
                hideLoadingOverlay();

                if (result.success && result.printContent) {
                    // Open new window and print
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(result.printContent);
                    printWindow.document.close();
                    printWindow.print();
                } else {
                    alert('Unable to generate print content. Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                hideLoadingOverlay();
                console.error('Error generating print content:', error);
                alert('Unable to generate print content. Please try again.');
            }
        }
        
        // Job Order Form Handler
        async function initializeJobOrderForm() {
            const formNumberInput = document.getElementById('formNumber');
            const dateFiledInput = document.getElementById('dateFiled');
            const requestedByInput = document.getElementById('requestedBy');
            const departmentSelect = document.getElementById('department');
            
            // Set current date
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            dateFiledInput.value = formattedDate;
            
            // Pre-fill requested by with current user's name
            if (currentUser) {
                requestedByInput.value = currentUser.fullName || currentUser.username;
            }
            
            // Auto-populate department based on user's department
            if (currentUser && currentUser.department) {
                departmentSelect.innerHTML = `<option value="${currentUser.department}" selected>${currentUser.department}</option>`;
                departmentSelect.disabled = true; // Make it read-only since it's auto-populated
                departmentSelect.classList.add('bg-gray-50', 'cursor-not-allowed');
            } else {
                // Load departments if user department is not available
                try {
                    const deptResponse = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            action: 'getDepartments'
                        })
                    });
                    
                    const deptResult = await deptResponse.json();
                    if (deptResult.success && deptResult.departments) {
                        // Clear loading message
                        departmentSelect.innerHTML = '<option value="">Select Department</option>';
                        
                        // Add departments from the sheet
                        deptResult.departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.name;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                    } else {
                        departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
                        console.error('Error loading departments:', deptResult.error);
                    }
                } catch (error) {
                    console.error('Error fetching departments:', error);
                    departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
                }
            }
            
            // Set form number as "Will be generated after submission"
            formNumberInput.value = 'Will be generated after submission';
        }
        
        // Handle job order form submission
        document.addEventListener('DOMContentLoaded', function() {
            const jobOrderForm = document.getElementById('jobOrderForm');
            if (jobOrderForm) {
                jobOrderForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const messageDiv = document.getElementById('jobOrderMessage');
                    const submitButton = form.querySelector('button[type="submit"]');
                    
                    // Disable submit button
                    const originalText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
                    
                    // Validate form
                    const formData = {
                        dateFiled: form.dateFiled.value,
                        department: form.department.value,
                        location: form.location.value,
                        natureOfWork: form.natureOfWork.value,
                        requestedBy: form.requestedBy.value
                    };
                    
                    if (!formData.department) {
                        messageDiv.textContent = 'Please select a department.';
                        messageDiv.className = 'mt-4 text-sm text-red-600';
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                        return;
                    }
                    
                    // Show loading overlay
                    showLoadingOverlay();
                    
                    try {
                        // Submit form data (form number will be generated on backend)
                        const formDataToSend = new FormData();
                        formDataToSend.append('action', 'submitJobOrder');
                        Object.keys(formData).forEach(key => {
                            formDataToSend.append(key, formData[key]);
                        });
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                            method: 'POST',
                            body: formDataToSend
                        });
                        
                        const result = await response.json();
                        
                        // Hide loading overlay
                        hideLoadingOverlay();
                        
                        if (result.success) {
                            // Clear any previous error messages
                            messageDiv.textContent = '';
                            messageDiv.className = '';
                            
                            // Reset form
                            form.reset();
                            initializeJobOrderForm();
                            
                            // Show success overlay
                            showJobOrderSuccessOverlay(result.formNumber, result.printContent);
                        } else {
                            messageDiv.textContent = result.error || 'Failed to submit job order.';
                            messageDiv.className = 'mt-4 text-sm text-red-600';
                        }
                    } catch (error) {
                        console.error('Error submitting job order:', error);
                        hideLoadingOverlay(); // Hide loading overlay on error
                        messageDiv.textContent = 'Network error. Please try again.';
                        messageDiv.className = 'mt-4 text-sm text-red-600';
                        hideTutorialOverlay();
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                });
            }
            
            // Job Order Edit Form
            const jobOrderEditForm = document.getElementById('jobOrderEditForm');
            if (jobOrderEditForm) {
                jobOrderEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const messageDiv = document.getElementById('jobOrderEditMsg');
                    const submitButton = form.querySelector('button[type="submit"]');
                    const formNumber = form.dataset.formNumber;
                    
                    // Disable submit button
                    const originalText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    
                    try {
                        const formData = {
                            action: 'updateJobOrder',
                            formNumber: formNumber,
                            status: document.getElementById('editStatus').value
                        };
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                            method: 'POST',
                            body: new URLSearchParams(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            messageDiv.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Job order updated successfully!</span>';
                            
                            // Refresh job orders list
                            setTimeout(() => {
                                closeJobOrderEditModal();
                                loadJobOrders();
                            }, 1500);
                        } else {
                            throw new Error(result.error || 'Failed to update job order');
                        }
                    } catch (error) {
                        console.error('Error updating job order:', error);
                        messageDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>Failed to update job order: ' + error.message + '</span>';
                    } finally {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                });
            }
            
            // Aircon Concerns Form
            const airconConcernsForm = document.getElementById('airconConcernForm');
            if (airconConcernsForm) {
                airconConcernsForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const messageDiv = document.getElementById('airconMessage');
                    const submitButton = form.querySelector('button[type="submit"]');
                    
                    // Disable submit button
                    const originalText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
                    
                    try {
                        const formData = {
                            action: 'submitAirconConcern',
                            date: form.date.value,
                            department: form.department.value,
                            airconType: form.airconType.value,
                            concerns: form.concerns.value.trim(),
                            reportedBy: form.reportedBy.value,
                            status: 'Pending', // Default status
                            dateAccomplished: '' // Empty initially
                        };
                        
                        if (!formData.concerns) {
                            messageDiv.textContent = 'Please describe the aircon concern.';
                            messageDiv.className = 'mt-4 text-sm text-red-600';
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalText;
                            return;
                        }
                        
                        // Show loading overlay
                        showLoadingOverlay();
                        
                        const formDataToSend = new FormData();
                        Object.keys(formData).forEach(key => {
                            formDataToSend.append(key, formData[key]);
                        });
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                            method: 'POST',
                            body: formDataToSend
                        });
                        
                        const result = await response.json();
                        
                        // Hide loading overlay
                        hideLoadingOverlay();
                        
                        if (result.success) {
                            // Clear any previous error messages
                            messageDiv.textContent = '';
                            messageDiv.className = '';
                            
                            // Reset form
                            resetAirconForm();
                            
                            // Show success message
                            messageDiv.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Aircon concern submitted successfully!</span>';
                            
                            // Hide success message after 3 seconds
                            setTimeout(() => {
                                messageDiv.textContent = '';
                                messageDiv.className = '';
                            }, 3000);
                        } else {
                            messageDiv.textContent = result.error || 'Failed to submit aircon concern.';
                            messageDiv.className = 'mt-4 text-sm text-red-600';
                        }
                    } catch (error) {
                        console.error('Error submitting aircon concern:', error);
                        hideLoadingOverlay();
                        messageDiv.textContent = 'Network error. Please try again.';
                        messageDiv.className = 'mt-4 text-sm text-red-600';
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                });
            }
            
            // AC Concern Edit Form
            const acConcernEditForm = document.getElementById('acConcernEditForm');
            if (acConcernEditForm) {
                acConcernEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const messageDiv = document.getElementById('acConcernEditMsg');
                    const submitButton = form.querySelector('button[type="submit"]');
                    const concernId = form.dataset.concernId;
                    
                    // Disable submit button
                    const originalText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    
                    try {
                        // Get the current status to check if it's being set to "Completed"
                        const status = document.getElementById('editACStatus').value;
                        let dateAccomplished = document.getElementById('editACDateAccomplished').value;
                        
                        // Automatically set date accomplished if status is "Completed" and date is empty
                        if (status === 'Completed' && !dateAccomplished) {
                            const today = new Date();
                            dateAccomplished = today.getFullYear() + '-' + 
                                String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(today.getDate()).padStart(2, '0');
                            
                            // Update the form field to show the auto-filled date
                            document.getElementById('editACDateAccomplished').value = dateAccomplished;
                        }
                        
                        const formData = {
                            action: 'updateACConcern',
                            concernId: concernId,
                            concerns: document.getElementById('editACConcerns').value,
                            status: status,
                            dateAccomplished: dateAccomplished
                        };
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                            method: 'POST',
                            body: new URLSearchParams(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            messageDiv.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>AC concern updated successfully!</span>';
                            
                            // Refresh AC concerns list
                            setTimeout(() => {
                                closeACConcernEditModal();
                                loadACConcerns();
                            }, 1500);
                        } else {
                            throw new Error(result.error || 'Failed to update AC concern');
                        }
                    } catch (error) {
                        console.error('Error updating AC concern:', error);
                        messageDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>Failed to update AC concern: ' + error.message + '</span>';
                    } finally {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                });
            }
            
            // AC Status change event listener for auto-filling date accomplished
            const acStatusSelect = document.getElementById('editACStatus');
            if (acStatusSelect) {
                acStatusSelect.addEventListener('change', function() {
                    const dateAccomplishedField = document.getElementById('editACDateAccomplished');
                    if (this.value === 'Completed' && !dateAccomplishedField.value) {
                        // Auto-fill with today's date when status is set to Completed
                        const today = new Date();
                        const formattedDate = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
                        dateAccomplishedField.value = formattedDate;
                    }
                });
            }
            
            // Add User Form
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const messageDiv = document.getElementById('addUserMsg');
                    const submitButton = form.querySelector('button[type="submit"]');
                    
                    // Disable submit button
                    const originalText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
                    
                    try {
                        const formData = {
                            action: 'signup',
                            username: document.getElementById('newUsername').value,
                            password: document.getElementById('newPassword').value,
                            fullName: document.getElementById('newFullName').value,
                            department: document.getElementById('newDepartment').value,
                            email: document.getElementById('newEmail').value,
                            phone: document.getElementById('newPhone').value,
                            userType: document.getElementById('newUserType').value,
                            status: document.getElementById('newStatus').value || 'Active'
                        };
                        
                        const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                            method: 'POST',
                            body: new URLSearchParams(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            messageDiv.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>User created successfully!</span>';
                            
                            // Clear form and close modal after success
                            setTimeout(() => {
                                closeAddUserModal();
                                refreshUsersList(); // Refresh the users list
                            }, 1500);
                        } else {
                            throw new Error(result.error || 'Failed to create user');
                        }
                    } catch (error) {
                        console.error('Error creating user:', error);
                        messageDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>Failed to create user: ' + error.message + '</span>';
                    } finally {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                });
            }
            
            // Mobile overlay click handler
            const mobileOverlay = document.getElementById('mobileOverlay');
            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', closeMobileSidebar);
            }
            
            // Keyboard support for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close job order details modal if open
                    const detailsModal = document.getElementById('jobOrderDetailsModal');
                    if (detailsModal && !detailsModal.classList.contains('hidden')) {
                        closeJobOrderDetailsModal();
                        return;
                    }
                    
                    // Close job order edit modal if open
                    const editModal = document.getElementById('jobOrderEditModal');
                    if (editModal && !editModal.classList.contains('hidden')) {
                        closeJobOrderEditModal();
                        return;
                    }
                    
                    // Close AC concern edit modal if open
                    const acEditModal = document.getElementById('acConcernEditModal');
                    if (acEditModal && !acEditModal.classList.contains('hidden')) {
                        closeACConcernEditModal();
                        return;
                    }
                }
            });
        });
        
        // Job Order Success Overlay Functions
        let currentPrintContent = null;
        
        function showJobOrderSuccessOverlay(formNumber, printContent) {
            const overlay = document.getElementById('jobOrderSuccessOverlay');
            const formNumberSpan = document.getElementById('successFormNumber');
            
            // Store print content for later use
            currentPrintContent = printContent;
            
            // Set form number
            formNumberSpan.textContent = formNumber;
            
            // Show overlay
            overlay.classList.remove('hidden');
            
            // Add event listeners
            document.getElementById('printJobOrderBtn').onclick = function() {
                if (currentPrintContent) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(currentPrintContent);
                    printWindow.document.close();
                    printWindow.print();
                }
            };
            
            document.getElementById('downloadJobOrderBtn').onclick = function() {
                if (currentPrintContent) {
                    // Create a blob with the HTML content
                    const blob = new Blob([currentPrintContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `job-order-${formNumber}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };
            
            document.getElementById('closeSuccessOverlayX').onclick = function() {
                hideJobOrderSuccessOverlay();
            };
            
            // Close on overlay click (outside modal)
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    hideJobOrderSuccessOverlay();
                }
            };
        }
        
        function hideJobOrderSuccessOverlay() {
            const overlay = document.getElementById('jobOrderSuccessOverlay');
            overlay.classList.add('hidden');
            currentPrintContent = null;
        }

        // Loading Overlay Functions
        function showLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
        }
        
        // ====== AIRCON CONCERNS FUNCTIONALITY ======
        
        // Initialize aircon concern form when section is shown
        function initializeAirconForm() {
            const dateInput = document.getElementById('airconDate');
            const departmentInput = document.getElementById('airconDepartment');
            const reportedByInput = document.getElementById('airconReportedBy');
            
            // Set current date
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            dateInput.value = formattedDate;
            
            // Auto-fill from current user data
            if (currentUser) {
                departmentInput.value = currentUser.department || 'N/A';
                reportedByInput.value = currentUser.fullName || currentUser.username || 'N/A';
            }
        }
        
        // Reset aircon concern form
        function resetAirconForm() {
            const form = document.getElementById('airconConcernForm');
            
            // Reset only user input fields, keep auto-filled fields
            form.querySelector('select[name="airconType"]').value = '';
            form.querySelector('textarea[name="concerns"]').value = '';
            
            // Clear any status messages
            const messageDiv = document.getElementById('airconMessage');
            messageDiv.textContent = '';
            messageDiv.className = 'mt-4 text-sm';
        }
        
        // Handle aircon concern form submission
        async function submitAirconConcern(formData) {
            const messageDiv = document.getElementById('airconMessage');
            messageDiv.textContent = '';
            
            try {
                showLoadingOverlay();
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.textContent = 'Aircon concern submitted successfully! Our team will review and address your concern.';
                    messageDiv.className = 'mt-4 text-sm text-green-600 font-medium';
                    
                    // Reset the form after successful submission
                    setTimeout(() => {
                        resetAirconForm();
                        messageDiv.textContent = '';
                    }, 3000);
                } else {
                    messageDiv.textContent = `Error: ${result.error || 'Failed to submit concern'}`;
                    messageDiv.className = 'mt-4 text-sm text-red-600 font-medium';
                }
            } catch (error) {
                console.error('Error submitting aircon concern:', error);
                messageDiv.textContent = 'Network error. Please check your connection and try again.';
                messageDiv.className = 'mt-4 text-sm text-red-600 font-medium';
            } finally {
                hideLoadingOverlay();
            }
        }
        
        // ====== AC CONCERNS VIEWING FUNCTIONALITY ======
        
        // AC Concerns Data
        let acConcerns = [];
        let originalACConcerns = []; // Store original unfiltered data
        
        // Load AC concerns from backend
        async function loadACConcerns() {
            const tableBody = document.getElementById('acConcernsTableBody');
            const loadingDiv = document.getElementById('acConcernsLoading');
            const emptyDiv = document.getElementById('acConcernsEmpty');
            
            // Show loading state
            loadingDiv.classList.remove('hidden');
            emptyDiv.classList.add('hidden');
            if (tableBody) tableBody.innerHTML = '';
            
            try {
                const formData = new FormData();
                formData.append('action', 'getACConcerns');
                if (currentUser) {
                    formData.append('username', currentUser.username);
                }
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL_FORM, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.concerns) {
                    acConcerns = result.concerns;
                    originalACConcerns = [...result.concerns]; // Store original copy
                    displayACConcerns(acConcerns);
                    populateACConcernDepartmentFilter();
                } else {
                    showEmptyACConcerns();
                }
            } catch (error) {
                console.error('Error loading AC concerns:', error);
                showEmptyACConcerns();
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // Display AC concerns in table and mobile cards
        function displayACConcerns(concerns) {
            const tableBody = document.getElementById('acConcernsTableBody');
            const mobileContainer = document.getElementById('acConcernsCardView');
            const emptyDiv = document.getElementById('acConcernsEmpty');
            const countElement = document.getElementById('acConcernsCount');
            
            // Update count
            if (countElement) {
                countElement.textContent = concerns.length;
            }
            
            if (!concerns || concerns.length === 0) {
                showEmptyACConcerns();
                return;
            }

            emptyDiv.classList.add('hidden');
            
            // Store concerns globally for mobile card access
            window.currentACConcerns = concerns;
            
            // Desktop table view
            if (tableBody) {
                tableBody.innerHTML = concerns.map(concern => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(concern.date)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${concern.department}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${concern.airconType}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="max-w-xs truncate" title="${concern.concerns}">${concern.concerns}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${concern.reportedBy}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getACStatusColor(concern.status)}">
                                ${concern.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${concern.dateAccomplished || '-'}</td>
                        <td class="px-6 py-4 text-sm space-x-2">
                            ${currentUser && currentUser.userType === 'admin' ? `
                                <button onclick="editACConcern('${concern.id || concern.date + '-' + concern.reportedBy}')" 
                                        class="text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-eye mr-1"></i>Edit Status
                                </button>
                            ` : `
                                <span class="text-gray-500 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View Only
                                </span>
                            `}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Mobile card view
            if (mobileContainer) {
                mobileContainer.innerHTML = concerns.map(concern => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-900">${concern.department}</h4>
                                <p class="text-sm text-gray-600">${formatDate(concern.date)}</p>
                            </div>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getACStatusColor(concern.status)}">
                                ${concern.status}
                            </span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">AC Type:</span> ${concern.airconType}</p>
                            <p><span class="font-medium">Concern:</span> ${concern.concerns}</p>
                            <p><span class="font-medium">Reported by:</span> ${concern.reportedBy}</p>
                            ${concern.dateAccomplished ? `<p><span class="font-medium">Completed:</span> ${concern.dateAccomplished}</p>` : ''}
                        </div>
                        <div class="mt-4 flex justify-end">
                            ${currentUser && currentUser.userType === 'admin' ? `
                                <button onclick="editACConcern('${concern.id || concern.date + '-' + concern.reportedBy}')" 
                                        class="px-3 py-1.5 text-blue-600 hover:text-blue-800 border border-blue-300 rounded-lg text-sm font-medium">
                                    <i class="fas fa-eye mr-1"></i>Edit Status
                                </button>
                            ` : `
                                <span class="px-3 py-1.5 text-gray-500 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View Only
                                </span>
                            `}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Show empty state
        function showEmptyACConcerns() {
            const emptyDiv = document.getElementById('acConcernsEmpty');
            const countElement = document.getElementById('acConcernsCount');
            const tableBody = document.getElementById('acConcernsTableBody');
            const mobileContainer = document.getElementById('acConcernsCardView');
            
            // Clear the table and mobile view content
            if (tableBody) tableBody.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';
            if (countElement) countElement.textContent = '0';
            
            // Update empty message based on whether it's filtered or truly empty
            const hasFilters = document.getElementById('acConcernSearch').value || 
                              document.getElementById('acConcernDepartmentFilter').value ||
                              document.getElementById('acConcernStatusFilter').value ||
                              document.getElementById('acConcernTypeFilter').value;
            
            if (originalACConcerns.length === 0) {
                emptyDiv.innerHTML = `
                    <div class="text-gray-500">
                        <i class="fas fa-snowflake text-4xl mb-4"></i>
                        <p class="text-lg font-medium mb-2">No AC concerns found</p>
                        <p class="text-sm">No air conditioning concerns have been reported yet.</p>
                    </div>
                `;
            } else if (hasFilters) {
                emptyDiv.innerHTML = `
                    <div class="text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p class="text-lg font-medium mb-2">No matching AC concerns</p>
                        <p class="text-sm">Try adjusting your filters to see more results.</p>
                        <button onclick="clearACConcernFilters()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            Clear Filters
                        </button>
                    </div>
                `;
            }
            
            emptyDiv.classList.remove('hidden');
        }
        
        // Get status color classes for AC concerns
        function getACStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'in progress':
                    return 'bg-blue-100 text-blue-800';
                case 'completed':
                    return 'bg-green-100 text-green-800';
                case 'cancelled':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Refresh AC concerns
        function refreshACConcerns() {
            loadACConcerns();
        }
        
        // Populate AC concern department filter based on user type
        function populateACConcernDepartmentFilter() {
            const departmentFilter = document.getElementById('acConcernDepartmentFilter');
            if (!departmentFilter) return;
            
            // Clear existing options except "All Departments"
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            if (currentUser && currentUser.userType === 'admin') {
                // Admin can see all departments from the loaded data
                const departments = [...new Set(originalACConcerns.map(concern => concern.department))];
                departments.forEach(dept => {
                    departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
                });
            } else {
                // Non-admin users only see their own department
                if (currentUser && currentUser.department) {
                    departmentFilter.innerHTML += `<option value="${currentUser.department}">${currentUser.department}</option>`;
                    departmentFilter.value = currentUser.department;
                    departmentFilter.disabled = true;
                }
            }
        }
        
        // Filter AC concerns based on search, department, status, and type
        let acFilterTimeout = null;
        function filterACConcerns(immediate = false) {
            // Debounce search input to avoid filtering on every keystroke
            if (!immediate && acFilterTimeout) {
                clearTimeout(acFilterTimeout);
            }
            
            const doFilter = () => {
                const searchTerm = document.getElementById('acConcernSearch').value.toLowerCase().trim();
                const departmentFilter = document.getElementById('acConcernDepartmentFilter').value;
                const statusFilter = document.getElementById('acConcernStatusFilter').value;
                const typeFilter = document.getElementById('acConcernTypeFilter').value;
                
                let filtered = [...originalACConcerns];
                
                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(concern => 
                        concern.reportedBy.toLowerCase().includes(searchTerm) ||
                        concern.concerns.toLowerCase().includes(searchTerm) ||
                        concern.department.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Apply department filter
                if (departmentFilter) {
                    filtered = filtered.filter(concern => concern.department === departmentFilter);
                }
                
                // Apply status filter
                if (statusFilter) {
                    filtered = filtered.filter(concern => concern.status === statusFilter);
                }
                
                // Apply type filter
                if (typeFilter) {
                    filtered = filtered.filter(concern => concern.airconType === typeFilter);
                }
                
                acConcerns = filtered;
                displayACConcerns(acConcerns);
            };
            
            if (immediate) {
                doFilter();
            } else {
                acFilterTimeout = setTimeout(doFilter, 300);
            }
        }
        
        // Clear all AC concern filters
        function clearACConcernFilters() {
            document.getElementById('acConcernSearch').value = '';
            document.getElementById('acConcernDepartmentFilter').value = '';
            document.getElementById('acConcernStatusFilter').value = '';
            document.getElementById('acConcernTypeFilter').value = '';
            
            // Reset to original unfiltered data
            acConcerns = [...originalACConcerns];
            displayACConcerns(acConcerns);
        }
        
        // Edit AC concern
        function editACConcern(concernId) {
            // Check if user is admin
            if (!currentUser || currentUser.userType !== 'admin') {
                alert('Only administrators can edit AC concern status.');
                return;
            }
            
            const concern = acConcerns.find(c => (c.id || c.date + '-' + c.reportedBy) === concernId);
            if (!concern) return;
            
            // Populate edit form
            document.getElementById('editACDate').value = formatDate(concern.date);
            document.getElementById('editACDepartment').value = concern.department;
            document.getElementById('editACType').value = concern.airconType;
            document.getElementById('editACReportedBy').value = concern.reportedBy;
            document.getElementById('editACConcerns').value = concern.concerns;
            document.getElementById('editACStatus').value = concern.status;
            document.getElementById('editACDateAccomplished').value = concern.dateAccomplished || '';
            
            // Store concern ID for update
            document.getElementById('acConcernEditForm').dataset.concernId = concernId;
            
            // Show modal
            document.getElementById('acConcernEditModal').classList.remove('hidden');
        }
        
        // Close AC concern edit modal
        function closeACConcernEditModal() {
            document.getElementById('acConcernEditModal').classList.add('hidden');
            document.getElementById('acConcernEditMsg').textContent = '';
            document.getElementById('acConcernEditMsg').className = '';
        }
        
        // Open add user modal
        async function openAddUserModal() {
            // Check if user is admin
            if (!currentUser || currentUser.userType !== 'admin') {
                alert('Only administrators can add new users.');
                return;
            }
            
            // Load departments for the dropdown
            await loadDepartmentsForUserForm();
            
            // Clear form
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserMsg').textContent = '';
            document.getElementById('addUserMsg').className = '';
            
            // Show modal
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        // Close add user modal
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserMsg').textContent = '';
            document.getElementById('addUserMsg').className = '';
        }
        
        // Load departments for user form
        async function loadDepartmentsForUserForm() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL_FORM}?action=getDepartments`);
                const result = await response.json();
                
                if (result.success) {
                    const departmentSelect = document.getElementById('newDepartment');
                    departmentSelect.innerHTML = '<option value="">Select Department</option>';
                    
                    result.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = dept.name;
                        departmentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Initialize job order form when section is shown
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);
            
            if (sectionName === 'file-job-order') {
                initializeJobOrderForm();
            } else if (sectionName === 'view-job-order') {
                // Load job orders and populate filters when viewing job orders
                loadJobOrders();
            } else if (sectionName === 'aircon-concerns') {
                // Initialize aircon concern form when viewing aircon concerns
                initializeAirconForm();
            } else if (sectionName === 'view-ac-status') {
                // Load AC concerns when viewing AC status
                loadACConcerns();
            }
        };

        // Initialize the app
        window.addEventListener('DOMContentLoaded', function() {
            if (checkAuthentication()) {
                // Load all data - each function has its own loading overlay
                fetchReservations();
                fetchVenues();  
                fetchDepartments();
                fetchUsageLogs();
                populateVenueFilter();
                generateCalendar();
                fetchUnreadCounts();
                
                // Start background sync systems
                startUsageLogsSync();
                
                // Start enhanced real-time polling system
                startRealTimePolling();
                
                // Update profile picture on load
                if (currentUser && currentUser.profilePicture) {
                    updateProfilePicture(currentUser.profilePicture);
                }
                
                // Update header stats
                updateHeaderStats();
            }
        });
    </script>
    
    <!-- Job Order Edit Modal -->
    <div id="jobOrderEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="rope-border bg-white rounded-xl shadow-xl w-full max-w-md mx-auto max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-900">Update Job Order Status</h3>
                    <button onclick="closeJobOrderEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <form id="jobOrderEditForm" class="flex-1 overflow-y-auto">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Form Number</label>
                        <input type="text" id="editFormNumber" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-medium">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <input type="text" id="editDepartment" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status <span class="text-red-500">*</span></label>
                        <select id="editStatus" name="status" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="editLocation" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-location-dot mr-2 text-gray-400"></i>Location
                        </label>
                        <input type="text" id="editLocation" name="location" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    
                    <div>
                        <label for="editNatureOfWork" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clipboard-list mr-2 text-gray-400"></i>Nature of Work
                        </label>
                        <textarea id="editNatureOfWork" name="natureOfWork" readonly rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Requested By</label>
                        <input type="text" id="editRequestedBy" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date Filed</label>
                        <input type="text" id="editDateFiled" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 flex-shrink-0">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeJobOrderEditModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Update Status</span>
                        </button>
                    </div>
                    <div id="jobOrderEditMsg" class="text-sm mt-2"></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Job Order Details Modal -->
    <div id="jobOrderDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-8">
        <div class="rope-border bg-white rounded-xl shadow-xl w-full max-w-2xl mx-auto max-h-[85vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex-shrink-0 rounded-t-xl overflow-hidden">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-900">Job Order Details</h3>
                    <button onclick="closeJobOrderDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Form Information -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">
                            <i class="fas fa-file-alt mr-2 text-blue-600"></i>Form Information
                        </h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Form Number</label>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <span id="detailsFormNumber" class="font-mono text-gray-900">-</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <span id="detailsStatus" class="px-2 py-1 text-xs font-semibold rounded-full">-</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Filed</label>
                            <div class="p-3 bg-gray-50 rounded-lg flex items-center">
                                <i class="fas fa-calendar mr-2 text-gray-400"></i>
                                <span id="detailsDateFiled" class="text-gray-900">-</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Submitted</label>
                            <div class="p-3 bg-gray-50 rounded-lg flex items-center">
                                <i class="fas fa-clock mr-2 text-gray-400"></i>
                                <span id="detailsDateSubmitted" class="text-gray-900">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Request Information -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">
                            <i class="fas fa-user mr-2 text-green-600"></i>Request Information
                        </h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <div class="p-3 bg-gray-50 rounded-lg flex items-center">
                                <i class="fas fa-building mr-2 text-gray-400"></i>
                                <span id="detailsDepartment" class="text-gray-900">-</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Requested By</label>
                            <div class="p-3 bg-gray-50 rounded-lg flex items-center">
                                <i class="fas fa-user-circle mr-2 text-gray-400"></i>
                                <span id="detailsRequestedBy" class="text-gray-900">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Work Details -->
                <div class="mt-6 space-y-4">
                    <h4 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">
                        <i class="fas fa-tools mr-2 text-orange-600"></i>Work Details
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-center">
                                    <i class="fas fa-location-dot mr-2 text-blue-600"></i>
                                    <span id="detailsLocation" class="text-gray-900 font-medium">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-1">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">Nature of Work</label>
                                <button id="editWorkButton" onclick="openJobOrderEditFromDetails()" 
                                        class="text-xs text-blue-600 hover:text-blue-700 flex items-center space-x-1">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex items-start">
                                    <i class="fas fa-clipboard-list mr-2 text-green-600 mt-1"></i>
                                    <span id="detailsNatureOfWork" class="text-gray-900 whitespace-pre-line">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div class="flex space-x-3">
                        <button onclick="printJobOrderFromDetails().catch(console.error)" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center space-x-2">
                            <i class="fas fa-print"></i>
                            <span>Print</span>
                        </button>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="openJobOrderEditFromDetails()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center space-x-2" 
                                id="jobOrderEditButton" style="display: none;">
                            <i class="fas fa-edit"></i>
                            <span>Edit Status</span>
                        </button>
                        <button onclick="closeJobOrderDetailsModal()" class="px-4 py-2 text-gray-700 bg-white hover:bg-gray-100 border border-gray-300 rounded-lg transition-colors">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
